<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ContextFlow</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&display=swap" rel="stylesheet">
<style>
:root{
  --home-bg:#FFF8F0;--home-accent:#E8722A;--home-as:#FFF0E5;--home-card:#FFF;--home-text:#2D1B0E;--home-text2:#8B7355;
  --office-bg:#F0F4FF;--office-accent:#3B5BDB;--office-as:#E5EAFF;--office-card:#FFF;--office-text:#0E1B3D;--office-text2:#5B6B8A;
  --outside-bg:#F0FFF4;--outside-accent:#38A169;--outside-as:#E6FFED;--outside-card:#FFF;--outside-text:#1A3A2A;--outside-text2:#5A8A6A;
  --bg:var(--home-bg);--accent:var(--home-accent);--as:var(--home-as);--card:var(--home-card);--text:var(--home-text);--text2:var(--home-text2);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background .5s,color .4s;-webkit-tap-highlight-color:transparent;overflow-x:hidden}
.app{max-width:520px;margin:0 auto;min-height:100vh;position:relative}
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:12px}
.loading-spinner{width:32px;height:32px;border:3px solid var(--as);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:13px;color:var(--text2)}
.pitch{display:flex;flex-direction:column;min-height:100vh;padding:16px}
.pitch-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.pitch-name{font-family:'Fraunces',serif;font-size:18px;font-weight:700}
.pitch-r{display:flex;align-items:center;gap:8px}
.pitch-time{font-size:11px;color:var(--text2)}
.day-badge{font-size:9px;font-weight:700;padding:2px 8px;border-radius:12px}
.day-badge.weekday{background:#E5EAFF;color:#3B5BDB}.day-badge.weekend{background:#FFF0E5;color:#E8722A}.day-badge.holiday{background:#FFE5E5;color:#DC2626}
.hol-btn{background:none;border:1.5px solid var(--as);border-radius:7px;padding:2px 7px;font-size:9px;font-family:'DM Sans',sans-serif;cursor:pointer;color:var(--text2);transition:all .2s}
.hol-btn.active{background:#DC2626;color:white;border-color:#DC2626}
.corner-btn{position:fixed;bottom:20px;right:20px;width:48px;height:48px;border-radius:50%;border:none;background:var(--accent);color:white;font-size:20px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,.2);z-index:200;transition:all .3s;display:flex;align-items:center;justify-content:center}
.loc-bar{display:flex;gap:6px;margin-bottom:12px}
.loc-g{display:flex;background:var(--card);border-radius:12px;padding:3px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.loc-b{border:none;background:transparent;padding:6px 12px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:500;color:var(--text2);cursor:pointer;transition:all .3s;white-space:nowrap}
.loc-b.active{background:var(--accent);color:white}
.poss-strip{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:14px;margin-bottom:16px;transition:all .4s}
.poss-strip.atk{background:linear-gradient(135deg,rgba(220,38,38,.1),rgba(220,38,38,.05))}
.poss-strip.mid{background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(245,158,11,.05))}
.poss-strip.def{background:linear-gradient(135deg,rgba(139,92,246,.1),rgba(139,92,246,.05))}
.poss-strip.done{background:linear-gradient(135deg,rgba(5,150,105,.1),rgba(5,150,105,.05))}
.poss-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.4)}}
.poss-dot.d-atk{background:#DC2626}.poss-dot.d-mid{background:#F59E0B}.poss-dot.d-def{background:#8B5CF6}.poss-dot.d-done{background:#059669}
.poss-text{flex:1;font-size:12px;font-weight:600}.poss-sub{font-size:10px;color:var(--text2)}
.pass-def-btn{border:none;padding:6px 12px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;cursor:pointer;background:#8B5CF6;color:white;transition:all .2s;flex-shrink:0}
.pitch-field{flex:1;display:flex;flex-direction:column;align-items:center;padding:8px 0}
/* Football pitch */
.fp{position:relative;width:100%;max-width:420px;min-height:520px;background:linear-gradient(180deg,#2d8a4e 0%,#34a058 20%,#2d8a4e 40%,#34a058 60%,#2d8a4e 80%,#34a058 100%);border-radius:18px;overflow:visible;box-shadow:inset 0 0 0 3px rgba(255,255,255,.25),0 8px 32px rgba(0,0,0,.15)}
.fp-lines{position:absolute;inset:0;pointer-events:none;overflow:hidden;border-radius:18px}
.fp-lines svg{width:100%;height:100%}
.fp-lines line,.fp-lines circle,.fp-lines rect{stroke:rgba(255,255,255,.3);stroke-width:1.5;fill:none}
/* Player dot */
.fp-dot{position:absolute;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:all .35s ease;z-index:5;transform:translateX(-50%)}
.fp-dot.blurred{opacity:.25;filter:blur(3px);pointer-events:none}
.fp-ball{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:white;box-shadow:0 3px 12px rgba(0,0,0,.3);transition:all .3s;border:2.5px solid rgba(255,255,255,.5);text-align:center;line-height:1.1}
.fp-ball.atk{background:linear-gradient(135deg,#3B82F6,#2563EB)}.fp-ball.mid{background:linear-gradient(135deg,#F59E0B,#D97706)}.fp-ball.def{background:linear-gradient(135deg,#EF4444,#DC2626)}
.fp-dot:active .fp-ball{transform:scale(1.15)}
.fp-dot.active .fp-ball{transform:scale(1.1);box-shadow:0 0 0 4px rgba(255,255,255,.5),0 4px 16px rgba(0,0,0,.4)}
.fp-lbl{font-size:8px;font-weight:700;color:white;text-shadow:0 1px 4px rgba(0,0,0,.6);margin-top:3px;max-width:64px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fp-count{position:absolute;top:-4px;right:-4px;width:16px;height:16px;border-radius:50%;background:#DC2626;color:white;font-size:8px;font-weight:700;display:flex;align-items:center;justify-content:center;border:1.5px solid rgba(255,255,255,.7)}
/* Expanded card */
.fp-card{position:absolute;left:50%;transform:translateX(-50%);top:100%;margin-top:8px;width:240px;background:white;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,.25);padding:12px;z-index:20;animation:cardPop .25s ease}
@keyframes cardPop{from{opacity:0;transform:translateX(-50%) translateY(-8px) scale(.9)}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}
.fp-card::before{content:'';position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:12px;height:12px;background:white;border-radius:2px;rotate:45deg}
.fp-card-cat{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.fp-card-cat.atk{color:#2563EB}.fp-card-cat.mid{color:#D97706}.fp-card-cat.def{color:#DC2626}
.fp-card-task{display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid #f0f0f0}
.fp-card-task:last-child{border-bottom:none}
.fp-card-cb{width:16px;height:16px;border-radius:4px;border:2px solid #ccc;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fp-card-cb:hover{border-color:#3B82F6}
.fp-card-name{font-size:11px;font-weight:500;flex:1;color:#1a1a1a;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fp-card-btn{border:none;padding:3px 8px;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;cursor:pointer;flex-shrink:0}
.fp-card-btn.timer{background:#2563EB;color:white}.fp-card-btn.check{background:#059669;color:white}
.fp-card-close{position:absolute;top:6px;right:8px;border:none;background:none;font-size:14px;cursor:pointer;color:#999}
.fp-card.above{top:auto;bottom:100%;margin-top:0;margin-bottom:8px}
.fp-card.above::before{top:auto;bottom:-6px}
/* Empty pitch */
.fp-empty{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:rgba(255,255,255,.6)}
.fp-empty-icon{font-size:48px;margin-bottom:10px;opacity:.5}
.fp-empty-text{font-family:'Fraunces',serif;font-size:16px;font-weight:600}
.fp-empty-sub{font-size:11px;opacity:.7;margin-top:4px}
/* Rotation lock overlay */
.fp-lock-msg{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);color:white;padding:6px 16px;border-radius:20px;font-size:10px;font-weight:600;z-index:10;white-space:nowrap;backdrop-filter:blur(4px)}
/* Timer overlay on pitch */
.fp-timer{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:30;border-radius:18px;color:white;text-align:center}
.fp-timer-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;opacity:.8;margin-bottom:6px}
.fp-timer-title{font-family:'Fraunces',serif;font-size:20px;font-weight:700;margin-bottom:2px}
.fp-timer-cat{font-size:11px;opacity:.7;margin-bottom:16px}
.fp-timer-ring{width:150px;height:150px;position:relative;margin-bottom:16px}
.fp-timer-ring svg{width:150px;height:150px;transform:rotate(-90deg)}
.fp-timer-ring circle{fill:none;stroke-width:5}
.tr-bg{stroke:rgba(255,255,255,.2)}.tr-fill{stroke:white;stroke-linecap:round;transition:stroke-dashoffset 1s linear}
.fp-timer-digits{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:36px;font-weight:700;letter-spacing:-1px}
.fp-timer-status{font-size:10px;opacity:.6;margin-top:2px}
.fp-timer-btns{display:flex;gap:10px}
.fp-timer-btn{border:none;padding:10px 20px;border-radius:12px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer}
.fp-timer-btn.start{background:white;color:#1a1a1a}.fp-timer-btn.pause{background:#F59E0B;color:white}.fp-timer-btn.done{background:#059669;color:white}
/* Dev card (bench, outside) */
.dev-card{background:var(--card);border-radius:14px;padding:14px;margin-bottom:8px;box-shadow:0 1px 4px rgba(0,0,0,.05);display:flex;align-items:center;gap:10px}
.dev-cb{width:20px;height:20px;border-radius:6px;border:2px solid var(--accent);flex-shrink:0;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s}
.dev-cb.checked{background:var(--accent);border-color:var(--accent)}
.dev-cb.checked::after{content:'‚úì';color:white;font-size:11px;font-weight:700}
.dev-title{font-size:14px;font-weight:500;flex:1}.dev-tag{font-size:10px;color:var(--text2)}
.dev-rm{border:none;background:none;font-size:12px;cursor:pointer;color:var(--text2);flex-shrink:0}
.mood-bar{display:flex;gap:8px;margin-bottom:14px;width:100%}
.mood-btn{flex:1;border:2px solid var(--as);background:var(--card);border-radius:12px;padding:10px 6px;text-align:center;cursor:pointer;transition:all .3s;font-family:'DM Sans',sans-serif}
.mood-btn.active{border-color:var(--accent);background:var(--as);transform:scale(1.03)}
.mood-emoji{font-size:24px;display:block;margin-bottom:2px}.mood-lbl{font-size:10px;font-weight:600;color:var(--text2)}
.link-c{background:var(--card);border-radius:13px;padding:13px;margin-bottom:7px;box-shadow:0 1px 3px rgba(0,0,0,.05);display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .3s;text-decoration:none;color:var(--text);width:100%;max-width:420px}

/* ==== CENTERED OVERLAY ==== */
.ov-bg{display:none;position:fixed;inset:0;z-index:400;background:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
.ov-bg.show{display:flex;align-items:center;justify-content:center;animation:ovIn .3s ease}
@keyframes ovIn{from{opacity:0}to{opacity:1}}
.ov-panel{background:var(--bg);border-radius:20px;width:94%;max-width:480px;max-height:88vh;overflow-y:auto;padding:20px;box-shadow:0 16px 64px rgba(0,0,0,.25);animation:panUp .35s ease}
@keyframes panUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
.ov-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.ov-title{font-family:'Fraunces',serif;font-size:18px;font-weight:700}
.ov-close{border:none;background:var(--card);width:36px;height:36px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 4px rgba(0,0,0,.1);color:var(--text)}
.ov-tabs{display:flex;background:var(--card);border-radius:12px;padding:3px;margin-bottom:14px}
.ov-tab{flex:1;border:none;background:transparent;padding:8px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;color:var(--text2);cursor:pointer;transition:all .3s;text-align:center}
.ov-tab.active{background:var(--accent);color:white}

/* Player sections */
.player-sec{margin-bottom:14px;border-radius:12px;padding:12px;border:1.5px solid var(--as)}
.player-sec.atk{background:rgba(220,38,38,.03);border-color:rgba(220,38,38,.15)}
.player-sec.mid{background:rgba(245,158,11,.03);border-color:rgba(245,158,11,.15)}
.player-sec.def{background:rgba(139,92,246,.03);border-color:rgba(139,92,246,.15)}
.player-hdr{display:flex;align-items:center;gap:6px;margin-bottom:8px}
.player-icon{font-size:16px}.player-name{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px}
.player-hdr.atk .player-name{color:#DC2626}.player-hdr.mid .player-name{color:#D97706}.player-hdr.def .player-name{color:#7C3AED}
.player-add-btn{margin-left:auto;border:none;background:var(--as);color:var(--accent);padding:3px 8px;border-radius:6px;font-size:9px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif}
.dc-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:4px}
.dc-chip{padding:6px 12px;border-radius:10px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;border:1.5px solid var(--as);background:var(--card);color:var(--text);display:flex;align-items:center;gap:5px}
.dc-chip:active{transform:scale(.95)}
.dc-chip-count{font-size:9px;background:var(--as);color:var(--accent);padding:0 6px;border-radius:6px;font-weight:700}
.dc-item{display:flex;align-items:center;gap:6px;background:var(--card);border-radius:8px;padding:8px 10px;margin-bottom:4px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
.dc-item-info{flex:1;min-width:0}.dc-item-n{font-size:11px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.dc-item-c{font-size:8px;color:var(--text2)}
.dc-pri-btns{display:flex;gap:2px;flex-shrink:0}
.dc-pri-btn{border:none;width:22px;height:22px;border-radius:5px;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;background:var(--as);color:var(--text2)}
.dc-pri-btn:hover{background:var(--accent);color:white}
.pitch-btn{border:none;padding:3px 8px;border-radius:5px;font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;cursor:pointer;flex-shrink:0;transition:all .2s}
.pitch-btn.on{background:#059669;color:white}.pitch-btn.off{background:var(--as);color:var(--accent)}
.bench-task{background:var(--card);border-radius:11px;padding:11px;margin-bottom:5px;box-shadow:0 1px 3px rgba(0,0,0,.05);display:flex;align-items:center;gap:8px;position:relative;overflow:hidden}
.bench-task.done{opacity:.5}.bench-pbar{width:3px;height:100%;position:absolute;left:0;top:0;border-radius:11px 0 0 11px}
.bench-cb{width:18px;height:18px;border-radius:5px;border:2px solid var(--accent);flex-shrink:0;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s}
.bench-cb.checked{background:var(--accent);border-color:var(--accent)}
.bench-cb.checked::after{content:'‚úì';color:white;font-size:10px;font-weight:700}
.bench-info{flex:1;min-width:0}.bench-title{font-size:12px;font-weight:500}.bench-meta{display:flex;gap:4px;flex-wrap:wrap;margin-top:2px}
.bench-tag{font-size:9px;font-weight:600;padding:1px 5px;border-radius:4px}

/* ==== CATEGORY DETAIL VIEW ==== */
.cat-detail{display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);align-items:center;justify-content:center}
.cat-detail.show{display:flex;animation:ovIn .3s ease}
.cat-panel{background:var(--bg);border-radius:20px;width:94%;max-width:480px;max-height:88vh;overflow-y:auto;padding:20px;box-shadow:0 16px 64px rgba(0,0,0,.25);animation:panUp .35s ease}
.cat-top{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.cat-back{border:none;background:var(--card);width:32px;height:32px;border-radius:50%;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 4px rgba(0,0,0,.1);color:var(--text);flex-shrink:0}
.cat-badge{font-size:8px;font-weight:700;padding:2px 8px;border-radius:6px;color:white}
.cat-badge.atk{background:#DC2626}.cat-badge.mid{background:#D97706}.cat-badge.def{background:#7C3AED}
.cat-name{font-family:'Fraunces',serif;font-size:18px;font-weight:700;flex:1}
.cat-stats{display:flex;gap:12px;margin-bottom:16px}
.cat-stat{background:var(--card);border-radius:10px;padding:10px 14px;flex:1;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,.05)}
.cat-stat-num{font-size:20px;font-weight:700;color:var(--accent)}.cat-stat-lbl{font-size:9px;color:var(--text2);margin-top:2px}
/* Add new task */
.cat-add{display:flex;gap:8px;margin-bottom:16px}
.cat-add-input{flex:1;border:1.5px solid var(--as);border-radius:10px;padding:10px 14px;font-family:'DM Sans',sans-serif;font-size:12px;background:var(--card);color:var(--text);outline:none}
.cat-add-input:focus{border-color:var(--accent)}
.cat-add-btn{border:none;background:var(--accent);color:white;padding:10px 16px;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer}
/* Search uncat */
.cat-search{width:100%;border:1.5px solid var(--as);border-radius:10px;padding:10px 14px;font-family:'DM Sans',sans-serif;font-size:12px;background:var(--card);color:var(--text);outline:none;margin-bottom:8px}
.cat-search:focus{border-color:var(--accent)}
.cat-search-item{display:flex;align-items:center;gap:8px;background:var(--card);border-radius:8px;padding:8px 10px;margin-bottom:4px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
.cat-search-name{flex:1;font-size:11px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cat-pull-btn{border:none;background:var(--accent);color:white;padding:3px 10px;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;cursor:pointer}

/* Regen popup */
.regen-ov{display:none;position:fixed;inset:0;z-index:700;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);align-items:center;justify-content:center}
.regen-ov.show{display:flex;animation:ovIn .3s ease}
.regen-panel{background:var(--bg);border-radius:18px;padding:20px;width:92%;max-width:360px;box-shadow:0 16px 64px rgba(0,0,0,.25);animation:panUp .35s ease}
.regen-head{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.regen-title{font-family:'Fraunces',serif;font-size:15px;font-weight:700}
.regen-sub{font-size:11px;color:var(--text2);margin-top:2px}
.regen-cat-info{font-size:10px;color:var(--text2);margin-bottom:12px;padding:6px 10px;background:var(--card);border-radius:8px}
.regen-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.regen-chip{padding:6px 12px;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;border:1.5px solid var(--as);background:var(--card);color:var(--text);transition:all .2s}
.regen-chip.active{background:var(--accent);color:white;border-color:var(--accent)}
.regen-custom{width:100%;border:1.5px solid var(--as);border-radius:10px;padding:10px 14px;font-family:'DM Sans',sans-serif;font-size:13px;background:var(--card);color:var(--text);outline:none;margin-bottom:12px;-moz-appearance:textfield}
.regen-custom:focus{border-color:var(--accent)}
.regen-custom::-webkit-inner-spin-button,.regen-custom::-webkit-outer-spin-button{-webkit-appearance:none}
.regen-btns{display:flex;gap:8px}
.regen-btn{flex:1;padding:10px;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.regen-btn.cancel{background:var(--as);color:var(--text2)}
.regen-btn.done{background:#059669;color:white}

/* New category modal */
.cat-modal-ov{display:none;position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.5);align-items:center;justify-content:center}
.cat-modal-ov.show{display:flex}
.cat-modal{background:var(--bg);border-radius:16px;padding:20px;width:90%;max-width:340px;box-shadow:0 8px 32px rgba(0,0,0,.2)}
.cat-modal h3{font-family:'Fraunces',serif;font-size:16px;margin-bottom:12px}
.cat-modal input,.cat-modal select{width:100%;border:1.5px solid var(--as);border-radius:9px;padding:8px 12px;font-family:'DM Sans',sans-serif;font-size:12px;background:var(--card);color:var(--text);outline:none;margin-bottom:8px}
.cat-modal-btns{display:flex;gap:8px;margin-top:6px}
.cat-modal-btns button{flex:1;padding:8px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;border:none}
.cat-modal-btns .save{background:var(--accent);color:white}.cat-modal-btns .cancel{background:var(--as);color:var(--text2)}

/* Lock/break/nudge */
.lock-ov{display:none;position:fixed;inset:0;z-index:9999;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center}
.lock-ov.show{display:flex;animation:lockIn .6s ease}
@keyframes lockIn{from{opacity:0}to{opacity:1}}
.lock-ov.mid-m{background:linear-gradient(145deg,#78350F,#92400E,#B45309)}
.lock-ov.mid-l{background:linear-gradient(145deg,#065F46,#047857,#059669)}
.lock-ov.def-e{background:linear-gradient(145deg,#3B0764,#5B21B6,#7C3AED)}
.lock-ov::before{content:'';position:absolute;top:8%;left:-15%;width:350px;height:350px;background:radial-gradient(circle,rgba(255,255,255,.06) 0%,transparent 70%);border-radius:50%}
.lock-icon{font-size:56px;margin-bottom:14px;animation:breathe 3s ease-in-out infinite;position:relative;z-index:1}
@keyframes breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.lock-title{font-family:'Fraunces',serif;font-size:26px;font-weight:700;color:white;margin-bottom:4px;position:relative;z-index:1}
.lock-sub{font-size:13px;color:rgba(255,255,255,.85);margin-bottom:22px;max-width:280px;line-height:1.5;position:relative;z-index:1}
.lock-tasks{display:flex;flex-direction:column;gap:7px;margin-bottom:20px;width:100%;max-width:340px;position:relative;z-index:1}
.lock-task{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.12);padding:12px 14px;border-radius:11px;color:white;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s}
.lock-task.checked{opacity:.6}.lock-task.checked .lt-text{text-decoration:line-through}
.lt-cb{width:20px;height:20px;border-radius:6px;border:2px solid rgba(255,255,255,.5);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .3s}
.lt-cb.checked{background:white;border-color:white}.lt-cb.checked::after{content:'‚úì';font-size:12px;font-weight:700}
.lock-ov.mid-m .lt-cb.checked::after{color:#B45309}.lock-ov.mid-l .lt-cb.checked::after{color:#059669}.lock-ov.def-e .lt-cb.checked::after{color:#7C3AED}
.lt-text{flex:1;text-align:left}.lt-icon{font-size:18px;flex-shrink:0}
.lock-timer{position:relative;z-index:1;margin-bottom:10px}
.lock-timer-text{font-size:34px;font-weight:700;color:white;font-family:'DM Sans',sans-serif}
.lock-timer-lbl{font-size:11px;color:rgba(255,255,255,.6);margin-top:2px}
.lock-btn{border:none;padding:11px 26px;border-radius:11px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .3s;position:relative;z-index:1}
.lock-btn.ready{background:white;color:#1a1a1a;box-shadow:0 4px 16px rgba(0,0,0,.2)}.lock-btn.waiting{background:rgba(255,255,255,.15);color:rgba(255,255,255,.4);cursor:not-allowed}
.lock-status{font-size:10px;color:rgba(255,255,255,.5);margin-top:6px;position:relative;z-index:1}
.skip-btn{margin-top:14px;background:none;border:1px solid rgba(255,255,255,.3);color:rgba(255,255,255,.6);padding:7px 18px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:11px;cursor:pointer;position:relative;z-index:1}
.break-ov{display:none;position:fixed;inset:0;z-index:9998;background:linear-gradient(145deg,#064E3B,#065F46,#047857);color:white;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center}
.break-ov.show{display:flex;animation:lockIn .6s ease}
.break-title{font-family:'Fraunces',serif;font-size:24px;font-weight:700;margin-bottom:4px;position:relative;z-index:1}
.break-sub{font-size:14px;opacity:.85;margin-bottom:24px;position:relative;z-index:1}
.break-tips{display:flex;flex-direction:column;gap:8px;margin-bottom:24px;position:relative;z-index:1}
.break-tip{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.12);padding:11px 16px;border-radius:11px;font-size:13px;font-weight:500;opacity:0;transform:translateX(-20px);animation:tipSlide .5s ease forwards}
.break-tip:nth-child(1){animation-delay:.3s}.break-tip:nth-child(2){animation-delay:.5s}.break-tip:nth-child(3){animation-delay:.7s}
@keyframes tipSlide{to{opacity:1;transform:translateX(0)}}
.break-ring{width:90px;height:90px;position:relative;z-index:1}
.break-ring svg{transform:rotate(-90deg);width:90px;height:90px}
.break-ring circle{fill:none;stroke-width:4}.br-bg{stroke:rgba(255,255,255,.2)}.br-fill{stroke:white;stroke-linecap:round;transition:stroke-dashoffset 1s linear}
.break-time{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700}
.nudge{display:none;position:fixed;top:0;left:0;right:0;z-index:300;padding:10px 16px}
.nudge.show{display:block;animation:slideD .4s ease}
@keyframes slideD{from{transform:translateY(-100%)}to{transform:translateY(0)}}
.nudge-inner{max-width:488px;margin:0 auto;background:linear-gradient(135deg,#F59E0B,#D97706);color:white;border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:8px;box-shadow:0 4px 16px rgba(245,158,11,.3)}
.nudge-icon{font-size:20px;flex-shrink:0}.nudge-text{flex:1;font-size:12px;font-weight:500}
.nudge-x{border:none;background:rgba(255,255,255,.25);color:white;padding:5px 10px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;cursor:pointer;flex-shrink:0}
.sec-hdr{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text2);margin-bottom:6px;display:flex;align-items:center;gap:4px}
/* Delete confirm popup */
.del-ov{display:none;position:fixed;inset:0;z-index:800;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);align-items:center;justify-content:center}
.del-ov.show{display:flex;animation:ovIn .3s ease}
.del-panel{background:var(--bg);border-radius:16px;padding:20px;width:88%;max-width:320px;box-shadow:0 16px 64px rgba(0,0,0,.25);animation:panUp .35s ease;text-align:center}
.del-icon{font-size:36px;margin-bottom:8px}
.del-title{font-family:'Fraunces',serif;font-size:15px;font-weight:700;margin-bottom:4px}
.del-name{font-size:13px;font-weight:600;color:var(--accent);margin-bottom:4px;word-break:break-word}
.del-warn{font-size:10px;color:#DC2626;margin-bottom:14px}
.del-btns{display:flex;gap:8px}
.del-btn{flex:1;padding:10px;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.del-btn.cancel{background:var(--as);color:var(--text2)}
.del-btn.confirm{background:#DC2626;color:white}
/* Link edit */
.link-edit{width:100%;margin-top:4px}
.link-inp{width:100%;border:1.5px solid var(--as);border-radius:8px;padding:6px 10px;font-family:'DM Sans',sans-serif;font-size:11px;background:var(--bg);color:var(--text);outline:none}
.link-inp:focus{border-color:var(--accent)}
.link-edit-btns{display:flex;gap:4px;margin-top:4px}
.link-save,.link-rm,.link-cancel{border:none;padding:3px 8px;border-radius:5px;font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;cursor:pointer}
.link-save{background:var(--accent);color:white}
.link-rm{background:#DC262622;color:#DC2626}
.link-cancel{background:var(--as);color:var(--text2)}

/* Rules panel */
.rule-card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.05);border:1.5px solid var(--as)}
.rule-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.rule-name{font-size:13px;font-weight:600;color:var(--text)}
.rule-status{font-size:10px;font-weight:600;padding:2px 8px;border-radius:8px}
.rule-status.on{background:#05966922;color:#059669}.rule-status.off{background:#DC262622;color:#DC2626}
.rule-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.rule-label{font-size:10px;font-weight:600;color:var(--text2)}
.rule-inputs{display:flex;align-items:center;gap:6px}
.rule-sel{border:1.5px solid var(--as);border-radius:6px;padding:4px 6px;font-size:10px;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);outline:none;cursor:pointer}
.rule-toggle{border:1.5px solid var(--as);border-radius:6px;padding:4px 10px;font-size:10px;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;background:var(--card);color:var(--text2);transition:all .2s}
.rule-toggle.on{background:#05966922;color:#059669;border-color:#05966944}
.rule-presets{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
.rule-preset{border:1px solid var(--as);border-radius:6px;padding:3px 8px;font-size:9px;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;background:transparent;color:var(--text2);transition:all .2s}
.rule-preset:hover{background:var(--as);color:var(--accent)}

@keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<div class="app">
  <div class="loading" id="loadingView"><div class="loading-spinner"></div><div class="loading-text">Loading from Supabase...</div></div>
  <div class="pitch" id="pitch" style="display:none">
    <div class="pitch-top"><div class="pitch-name">ContextFlow</div><div class="pitch-r"><span class="day-badge" id="dayB"></span><button class="hol-btn" id="holB" onclick="toggleHol()">üéå</button><div class="pitch-time" id="timeD"></div></div></div>
    <div class="loc-bar"><div class="loc-g" id="locG"><button class="loc-b active" data-l="home" onclick="setLoc('home')">üè† Home</button><button class="loc-b" data-l="office" onclick="setLoc('office')">üè¢ Office</button><button class="loc-b" data-l="outside" onclick="setLoc('outside')">üå≥ Outside</button></div></div>
    <div id="possStrip"></div><div class="pitch-field" id="pitchField"></div>
  </div>
</div>
<button class="corner-btn" id="cornerBtn" onclick="openOv()" style="display:none">‚ò∞</button>

<!-- CENTERED OVERLAY -->
<div class="ov-bg" id="ovBg" onclick="if(event.target===this)closeOv()">
  <div class="ov-panel"><div class="ov-top"><div class="ov-title">Locker Room</div><div class="ov-close" onclick="closeOv()">‚úï</div></div>
    <div class="ov-tabs"><button class="ov-tab active" id="ovTabB" onclick="switchOvTab('bench')">üìã Bench</button><button class="ov-tab" id="ovTabD" onclick="switchOvTab('dc')">üéØ DC</button><button class="ov-tab" id="ovTabR" onclick="switchOvTab('rules')">‚öôÔ∏è Rules</button></div>
    <div id="ovContent"></div>
  </div>
</div>

<!-- CATEGORY DETAIL -->
<div class="cat-detail" id="catDetail" onclick="if(event.target===this)closeCatDetail()">
  <div class="cat-panel" id="catPanel"></div>
</div>

<!-- MODALS -->
<div class="cat-modal-ov" id="catModal"><div class="cat-modal"><h3 id="catModalTitle">New Category</h3><input id="catModalInput" placeholder="Category name..."><select id="catModalPlayer"><option value="attacker">‚öîÔ∏è Attacker</option><option value="midfielder">üç± Midfielder</option><option value="defender">ü™û Defender</option></select><div class="cat-modal-btns"><button class="cancel" onclick="closeCatModal()">Cancel</button><button class="save" onclick="saveCatModal()">Save</button></div></div></div>

<!-- REGEN POPUP -->
<div class="regen-ov" id="regenPopup">
  <div class="regen-panel">
    <div class="regen-head">
      <span style="font-size:20px">‚úÖ</span>
      <div><div class="regen-title" id="regenTaskName">Task</div><div class="regen-sub">Regenerate after how many days?</div></div>
    </div>
    <div class="regen-cat-info">Category default: <strong id="regenCatDefault">not set</strong></div>
    <div class="regen-chips">
      <div class="regen-chip" data-d="1" onclick="selectRegenPreset(1)">Daily</div>
      <div class="regen-chip" data-d="3" onclick="selectRegenPreset(3)">3 days</div>
      <div class="regen-chip" data-d="7" onclick="selectRegenPreset(7)">Weekly</div>
      <div class="regen-chip" data-d="14" onclick="selectRegenPreset(14)">2 weeks</div>
      <div class="regen-chip" data-d="30" onclick="selectRegenPreset(30)">Monthly</div>
    </div>
    <input class="regen-custom" id="regenCustom" type="number" min="1" placeholder="Custom days..." oninput="document.querySelectorAll('.regen-chip').forEach(c=>c.classList.remove('active'))">
    <div class="regen-btns">
      <button class="regen-btn cancel" onclick="closeRegenPopup()">Cancel</button>
      <button class="regen-btn done" onclick="confirmRegen()">‚úì Mark Done</button>
    </div>
  </div>
</div>

<!-- DELETE CONFIRM -->
<div class="del-ov" id="delPopup">
  <div class="del-panel">
    <div class="del-icon">üóëÔ∏è</div>
    <div class="del-title">Delete task?</div>
    <div class="del-name" id="delTaskName"></div>
    <div class="del-warn">This is permanent and cannot be undone.</div>
    <div class="del-btns">
      <button class="del-btn cancel" onclick="cancelDelete()">Cancel</button>
      <button class="del-btn confirm" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- LOCKS -->
<div class="lock-ov mid-m" id="lockM"><div class="lock-icon">‚òï</div><div class="lock-title">Morning Kickoff</div><div class="lock-sub">Midfield has the ball.</div><div class="lock-tasks" id="lockMT"></div><button class="lock-btn waiting" id="lockMB" onclick="unlockM()">‚öîÔ∏è Pass to Attackers</button><div class="lock-status" id="lockMS">Check at least one</div><button class="skip-btn" onclick="skipLock('morning')">Skip</button></div>
<div class="lock-ov mid-l" id="lockL"><div class="lock-icon">üç±</div><div class="lock-title">Lunch Break</div><div class="lock-sub">Midfield intervenes.</div><div class="lock-tasks" id="lockLT"></div><div class="lock-timer"><div class="lock-timer-text" id="lunchT">60:00</div><div class="lock-timer-lbl">minimum break</div></div><button class="lock-btn waiting" id="lockLB" onclick="unlockL()">‚öîÔ∏è Pass back</button><div class="lock-status" id="lockLS">Check one + wait</div><button class="skip-btn" onclick="skipLock('lunch')">Skip</button></div>
<div class="lock-ov def-e" id="lockD"><div class="lock-icon">ü™û</div><div class="lock-title">Defenders' Time</div><div class="lock-sub">Self-care mode.</div><div class="lock-tasks" id="lockDT"></div><div class="lock-timer"><div class="lock-timer-text" id="defT">30:00</div><div class="lock-timer-lbl">minimum self-care</div></div><button class="lock-btn waiting" id="lockDB" onclick="unlockD()">‚úÖ Done</button><div class="lock-status" id="lockDS">Check one + wait</div><button class="skip-btn" onclick="skipLock('defender')">Skip</button></div>
<div class="break-ov" id="breakOv"><div class="lock-icon" id="breakIcon">üåø</div><div class="break-title">5-Minute Break</div><div class="break-sub">Rest before next session</div><div class="break-tips" id="breakTips"></div><div class="break-ring"><svg viewBox="0 0 100 100"><circle class="br-bg" cx="50" cy="50" r="44"/><circle class="br-fill" id="bRing" cx="50" cy="50" r="44" stroke-dasharray="276.46" stroke-dashoffset="0"/></svg><div class="break-time" id="bTime">5:00</div></div><button class="skip-btn" onclick="skipBreak()">Skip</button></div>
<div class="nudge" id="nudge"><div class="nudge-inner"><span class="nudge-icon">üíß</span><span class="nudge-text" id="nudgeT">Drink water!</span><button class="nudge-x" onclick="dismissNudge()">Got it</button></div></div>

<script>
const sb=window.supabase.createClient('https://wylxvmkcrexwfpjpbhyy.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5bHh2bWtjcmV4d2ZwanBiaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzkxMDYsImV4cCI6MjA4NDIxNTEwNn0.6Bxo42hx4jwlJGWnfjiTpiDUsYfc1QLTN3YtrU1efak');

let allTags=[],tagMap={},allTasks=[],taskTags={},pitchSet=new Set(),playerMap={};
let loc='home',mood='Energetic',ovTab='bench',manHol=false,possession='mid_morning';
let lunchRem=3600,defRem=1800,lunchInt=null,defInt=null;
let morningCk=new Set(),lunchCk=new Set(),defCk=new Set();
let lastNudge=0,nudgeInt=null;
let studyTimerActive=false,studyTimerRem=0,studyTimerTotal=0,studyTimerInt=null,currentStudyId=null;
let breakRem=300,breakInt=null;
let catDetailSearch='',catDetailName='';
let pitchRotation='free';
let expandedDot='';
let lastDoneAtkCat=''; // individual attacker category that stays blurred after unlock
let regenDefaults={}; // categoryName ‚Üí days (default regen for all tasks in category)
let regenTasks={}; // taskId ‚Üí {days, done_at} (per-task override + last done timestamp)
let pendingDoneId=null; // task awaiting regen popup confirmation
let timeSlotRules={}; // categoryName ‚Üí {weekday_from:20, weekday_to:24, weekend:true, holiday:true}

const LOC_MAP={home:['Room','Share house'],office:['Company'],outside:['Train','Park','Cafe','Anywhere']};
const STUDY_CATS=['Paper study','Quick study','Reading'];
const DEV_CATS=['Coding','App generation'];
const PLAYER_INFO={attacker:{icon:'‚öîÔ∏è',name:'Attackers',cl:'atk'},midfielder:{icon:'üç±',name:'Midfield',cl:'mid'},defender:{icon:'ü™û',name:'Defenders',cl:'def'}};
const PRI_ORDER=['critical','high','medium','low','someday'];
const PITCH_LIMIT=3;

// Helpers
function todayK(){const d=new Date();return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function isWknd(){const d=new Date().getDay();return d===0||d===6}
const JP_HOL={'2025-01-01':1,'2025-01-13':1,'2025-02-11':1,'2025-02-23':1,'2025-02-24':1,'2025-03-20':1,'2025-04-29':1,'2025-05-03':1,'2025-05-04':1,'2025-05-05':1,'2025-05-06':1,'2025-07-21':1,'2025-08-11':1,'2025-09-15':1,'2025-09-23':1,'2025-10-13':1,'2025-11-03':1,'2025-11-23':1,'2025-11-24':1,'2026-01-01':1,'2026-01-12':1,'2026-02-11':1,'2026-02-23':1,'2026-03-20':1,'2026-04-29':1,'2026-05-03':1,'2026-05-04':1,'2026-05-05':1,'2026-05-06':1,'2026-07-20':1,'2026-08-11':1,'2026-09-21':1,'2026-09-23':1,'2026-10-12':1,'2026-11-03':1,'2026-11-23':1};
function dayType(){if(manHol)return'holiday';if(JP_HOL[todayK()])return'holiday';if(isWknd())return'weekend';return'weekday'}
function isOff(){return dayType()!=='weekday'}
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}

// Tag helpers
function tTagNames(id,type){return(taskTags[id]||[]).map(i=>tagMap[i]).filter(Boolean).filter(t=>t.type===type).map(t=>t.name)}
function tPriority(t){const p=tTagNames(t.id,'priority');if(p.includes('Critical'))return'critical';if(p.includes('High'))return'high';if(p.includes('Low'))return'low';if(p.includes('Someday'))return'someday';return'medium'}
function tCategory(t){return tTagNames(t.id,'category')[0]||''}
function tDuration(t){const d=tTagNames(t.id,'duration');if(d.includes('5min'))return 5;if(d.includes('15min'))return 15;if(d.includes('30min'))return 30;if(d.includes('1hour'))return 60;if(d.includes('2hours+'))return 120;return t.estimated_minutes||25}
function tInLoc(t,lk){const locs=tTagNames(t.id,'location');if(!locs.length)return false;const names=LOC_MAP[lk]||[];return locs.some(l=>names.includes(l))||locs.includes('Anywhere')}
function hasCategory(t){return tCategory(t)!==''}
function isStudy(t){return STUDY_CATS.includes(tCategory(t))}
function isDev(t){return DEV_CATS.includes(tCategory(t))}
function priColor(p){return{critical:'#c0392b',high:'#e74c3c',medium:'#f39c12',low:'#95a5a6',someday:'#bdc3c7'}[p]||'#f39c12'}
function locTasks(){return allTasks.filter(t=>t.status!=='done'&&tInLoc(t,loc))}
function pitched(){return allTasks.filter(t=>pitchSet.has(t.id)&&t.status!=='done')}
function catPlayer(c){return playerMap[c]||''}
function taskPlayer(t){return catPlayer(tCategory(t))}
function pitchCountForCat(cat){return[...pitchSet].filter(id=>{const t=allTasks.find(x=>x.id===id);return t&&t.status!=='done'&&tCategory(t)===cat}).length}
function canPitch(t){if(isInCooldown(t))return false;const cat=tCategory(t);if(!cat)return pitchSet.size<10;return pitchCountForCat(cat)<PITCH_LIMIT}

// Regen helpers
function getRegenDays(t){const r=regenTasks[t.id];if(r&&r.days!=null)return r.days;const cat=tCategory(t);return regenDefaults[cat]!=null?regenDefaults[cat]:null}
function isInCooldown(t){if(t.status!=='done')return false;const r=regenTasks[t.id];if(!r||!r.done_at)return false;const days=getRegenDays(t);if(days==null)return false;const doneDate=new Date(r.done_at);const now=new Date();const diff=Math.floor((now-doneDate)/(1000*60*60*24));return diff<days}
function cooldownDaysLeft(t){const r=regenTasks[t.id];if(!r||!r.done_at)return 0;const days=getRegenDays(t);if(days==null)return 0;const doneDate=new Date(r.done_at);const now=new Date();const diff=Math.floor((now-doneDate)/(1000*60*60*24));return Math.max(0,days-diff)}
function isActive(t){return t.status!=='done'||(t.status==='done'&&isInCooldown(t))}
async function checkAndReactivate(){
  let changed=false;
  for(const t of allTasks){
    if(t.status!=='done')continue;const r=regenTasks[t.id];if(!r||!r.done_at)continue;
    const days=getRegenDays(t);if(days==null)continue;
    const doneDate=new Date(r.done_at);const now=new Date();const diff=Math.floor((now-doneDate)/(1000*60*60*24));
    if(diff>=days){await markActive(t.id);await changePriority(t.id,'critical');changed=true;console.log('‚ôªÔ∏è Reactivated:',t.name)}
  }
  if(changed)renderAll();
}
// Time slot check ‚Äî only applies to attackers
function isCatAllowedNow(cat){
  const pl=catPlayer(cat);if(pl!=='attacker')return true; // mid/def always allowed
  const rule=timeSlotRules[cat];if(!rule)return true; // no rule = always allowed
  const dt=dayType();const hr=new Date().getHours();
  if(dt==='weekend'||dt==='holiday')return rule.weekend!==false; // default true
  // Weekday check
  const from=rule.weekday_from!=null?rule.weekday_from:0;
  const to=rule.weekday_to!=null?rule.weekday_to:24;
  return hr>=from&&hr<to;
}
// Attacker blur logic
function isAtkDotBlurred(cat){
  if(pitchRotation==='cooldown_atk')return true; // all attackers blurred
  if(lastDoneAtkCat===cat)return true; // individual cooldown
  return false;
}

// ===== SUPABASE =====
async function loadAll(){
  const[tR,taR,ttR]=await Promise.all([sb.from('mind_map_app_tasks').select('*'),sb.from('mind_map_app_tags').select('*'),sb.from('mind_map_app_task_tags').select('task_id,tag_id')]);
  allTags=taR.data||[];tagMap={};allTags.forEach(t=>tagMap[t.id]=t);
  allTasks=(tR.data||[]).map(r=>({id:r.id,name:r.name,status:r.status,parent_id:r.parent_id,estimated_minutes:r.estimated_minutes,due_date:r.due_date,created_at:r.created_at,links:r.links||''}));
  taskTags={};(ttR.data||[]).forEach(r=>{if(!taskTags[r.task_id])taskTags[r.task_id]=[];taskTags[r.task_id].push(r.tag_id)});
  const{data:mem}=await sb.from('mind_map_app_chat_memory').select('key,value').in('key',['cf_pitch','cf_possession','cf_players','cf_regen_defaults','cf_regen_tasks','cf_timeslots']);
  pitchSet=new Set();const dp={'Paper study':'attacker','Quick study':'attacker',Coding:'attacker','App generation':'attacker',Reading:'attacker',Documentation:'attacker',Exercise:'midfielder',Errands:'midfielder'};
  playerMap={...dp};regenDefaults={};regenTasks={};timeSlotRules={};
  (mem||[]).forEach(m=>{
    if(m.key==='cf_pitch')try{pitchSet=new Set(JSON.parse(m.value))}catch{};
    if(m.key==='cf_possession')try{const p=JSON.parse(m.value);if(p.date===todayK())possession=p.state||'mid_morning'}catch{};
    if(m.key==='cf_players')try{playerMap={...dp,...JSON.parse(m.value)}}catch{};
    if(m.key==='cf_regen_defaults')try{regenDefaults=JSON.parse(m.value)}catch{};
    if(m.key==='cf_regen_tasks')try{regenTasks=JSON.parse(m.value)}catch{};
    if(m.key==='cf_timeslots')try{timeSlotRules=JSON.parse(m.value)}catch{};
  });
}
async function memSave(key,val){
  const now=new Date().toISOString();try{const{data}=await sb.from('mind_map_app_chat_memory').select('id').eq('key',key).maybeSingle();
  if(data){await sb.from('mind_map_app_chat_memory').update({value:val,updated_at:now}).eq('key',key)}
  else{await sb.from('mind_map_app_chat_memory').insert({id:crypto.randomUUID(),key,value:val,updated_at:now})}}catch(e){console.error('memSave:',key,e)}
}
async function savePitch(){await memSave('cf_pitch',JSON.stringify([...pitchSet]))}
async function savePoss(){await memSave('cf_possession',JSON.stringify({date:todayK(),state:possession}))}
async function savePlayerMap(){await memSave('cf_players',JSON.stringify(playerMap))}
async function saveRegenDefaults(){await memSave('cf_regen_defaults',JSON.stringify(regenDefaults))}
async function saveRegenTasks(){await memSave('cf_regen_tasks',JSON.stringify(regenTasks))}
async function saveTimeSlots(){await memSave('cf_timeslots',JSON.stringify(timeSlotRules))}
async function markDone(id){const t=allTasks.find(x=>x.id===id);if(t)t.status='done';await sb.from('mind_map_app_tasks').update({status:'done',updated_at:new Date().toISOString()}).eq('id',id)}
async function markActive(id){const t=allTasks.find(x=>x.id===id);if(t)t.status='in_progress';await sb.from('mind_map_app_tasks').update({status:'in_progress',updated_at:new Date().toISOString()}).eq('id',id)}

// Pitch
function addPitch(id){const t=allTasks.find(x=>x.id===id);if(t&&!canPitch(t))return;pitchSet.add(id);savePitch();renderAll()}
function rmPitch(id){pitchSet.delete(id);savePitch();if(currentStudyId===id)stopTimer();renderAll()}
async function toggleTask(id){
  const t=allTasks.find(x=>x.id===id);if(!t)return;
  if(t.status==='done'){
    // Reactivate from done
    await markActive(id);renderAll();
  } else {
    // Show regen popup before marking done
    pendingDoneId=id;showRegenPopup(t);
  }
}
function showRegenPopup(t){
  const cat=tCategory(t);const catDefault=regenDefaults[cat];const taskOverride=regenTasks[t.id]?.days;
  const current=taskOverride!=null?taskOverride:catDefault!=null?catDefault:null;
  const el=document.getElementById('regenPopup');
  document.getElementById('regenTaskName').textContent=t.name;
  document.getElementById('regenCatDefault').textContent=catDefault!=null?catDefault+' days':'not set';
  document.getElementById('regenCustom').value=current||'';
  // Highlight active preset
  document.querySelectorAll('.regen-chip').forEach(c=>c.classList.toggle('active',current!=null&&parseInt(c.dataset.d)===current));
  el.classList.add('show');
}
async function confirmRegen(){
  const id=pendingDoneId;if(!id)return;const t=allTasks.find(x=>x.id===id);if(!t)return;
  const custom=document.getElementById('regenCustom').value;
  const days=custom?parseInt(custom):null;
  // Save regen info
  regenTasks[id]={days,done_at:new Date().toISOString()};
  await saveRegenTasks();
  // Mark done + rotation
  const pl=taskPlayer(t);const cat=tCategory(t);await markDone(id);pitchSet.delete(id);savePitch();
  if(pl==='attacker'){
    pitchRotation='cooldown_atk'; // blur ALL attackers
    lastDoneAtkCat=cat; // this one stays blurred even after unlock
  } else if(pitchRotation==='cooldown_atk'&&(pl==='midfielder'||pl==='defender')){
    pitchRotation='free'; // unlock attackers (except lastDoneAtkCat)
  }
  pendingDoneId=null;closeRegenPopup();
  // Auto-start next study if coming from study chain
  const next=pitched().filter(isStudy);
  if(isStudy(t)&&next.length){startStudy(next[0].id)}else{renderAll()}
}
function selectRegenPreset(days){document.getElementById('regenCustom').value=days;document.querySelectorAll('.regen-chip').forEach(c=>c.classList.toggle('active',parseInt(c.dataset.d)===days))}
function closeRegenPopup(){document.getElementById('regenPopup').classList.remove('show');pendingDoneId=null}

// ===== DELETE TASK =====
let pendingDeleteId=null;
function askDelete(id){
  const t=allTasks.find(x=>x.id===id);if(!t)return;
  pendingDeleteId=id;
  document.getElementById('delTaskName').textContent=t.name;
  document.getElementById('delPopup').classList.add('show');
}
function cancelDelete(){document.getElementById('delPopup').classList.remove('show');pendingDeleteId=null}
async function confirmDelete(){
  const id=pendingDeleteId;if(!id)return;
  // Remove from pitch
  pitchSet.delete(id);savePitch();
  if(currentStudyId===id)stopTimer();
  // Remove from regen tracking
  delete regenTasks[id];await saveRegenTasks();
  // Delete tag associations
  await sb.from('mind_map_app_task_tags').delete().eq('task_id',id);
  // Delete the task itself
  await sb.from('mind_map_app_tasks').delete().eq('id',id);
  // Remove from local state
  allTasks=allTasks.filter(t=>t.id!==id);
  delete taskTags[id];
  pendingDeleteId=null;
  document.getElementById('delPopup').classList.remove('show');
  renderAll();
}
// ===== TASK LINKS =====
let editingLinkId=null;
function showLinkEdit(id){editingLinkId=editingLinkId===id?null:id;renderCatDetail()}
async function saveTaskLink(id){
  const inp=document.getElementById('linkInp_'+id.replace(/-/g,''));if(!inp)return;
  const url=inp.value.trim();
  const t=allTasks.find(x=>x.id===id);if(t)t.links=url;
  await sb.from('mind_map_app_tasks').update({links:url,updated_at:new Date().toISOString()}).eq('id',id);
  editingLinkId=null;renderCatDetail();
}
async function removeTaskLink(id){
  const t=allTasks.find(x=>x.id===id);if(t)t.links='';
  await sb.from('mind_map_app_tasks').update({links:'',updated_at:new Date().toISOString()}).eq('id',id);
  editingLinkId=null;renderCatDetail();
}
function renderAll(){renderPitch();if(document.getElementById('ovBg').classList.contains('show'))renderOv();if(document.getElementById('catDetail').classList.contains('show'))renderCatDetail()}

// Priority
async function changePriority(taskId,newPri){
  const priTags=allTags.filter(t=>t.type==='priority');const newTag=priTags.find(t=>t.name.toLowerCase()===newPri);if(!newTag)return;
  const oldIds=priTags.map(t=>t.id);const cur=taskTags[taskId]||[];
  for(const id of cur.filter(i=>oldIds.includes(i)))await sb.from('mind_map_app_task_tags').delete().eq('task_id',taskId).eq('tag_id',id);
  await sb.from('mind_map_app_task_tags').insert({id:crypto.randomUUID(),task_id:taskId,tag_id:newTag.id,created_at:new Date().toISOString()});
  taskTags[taskId]=cur.filter(i=>!oldIds.includes(i)).concat([newTag.id]);renderAll();
}
function promoteTask(id){const c=tPriority(allTasks.find(t=>t.id===id)),i=PRI_ORDER.indexOf(c);if(i>0)changePriority(id,PRI_ORDER[i-1])}
function demoteTask(id){const c=tPriority(allTasks.find(t=>t.id===id)),i=PRI_ORDER.indexOf(c);if(i<PRI_ORDER.length-1)changePriority(id,PRI_ORDER[i+1])}

// Category assign
async function assignCat(taskId,catName){
  const catTag=allTags.find(t=>t.type==='category'&&t.name===catName);if(!catTag)return;
  const oldCatIds=allTags.filter(t=>t.type==='category').map(t=>t.id);const cur=taskTags[taskId]||[];
  for(const id of cur.filter(i=>oldCatIds.includes(i)))await sb.from('mind_map_app_task_tags').delete().eq('task_id',taskId).eq('tag_id',id);
  await sb.from('mind_map_app_task_tags').insert({id:crypto.randomUUID(),task_id:taskId,tag_id:catTag.id,created_at:new Date().toISOString()});
  taskTags[taskId]=cur.filter(i=>!oldCatIds.includes(i)).concat([catTag.id]);renderAll();
}

// Create new task
async function createTask(name,catName){
  const newId=crypto.randomUUID();const now=new Date().toISOString();
  const{data,error}=await sb.from('mind_map_app_tasks').insert({id:newId,name,status:'not_started',created_at:now,updated_at:now}).select().single();
  if(error){alert('Error: '+error.message);return}
  allTasks.push({id:newId,name,status:'not_started',created_at:now});
  if(catName){const catTag=allTags.find(t=>t.type==='category'&&t.name===catName);if(catTag){
    await sb.from('mind_map_app_task_tags').insert({id:crypto.randomUUID(),task_id:newId,tag_id:catTag.id,created_at:now});
    taskTags[newId]=[catTag.id];
  }}
  renderAll();
}

// Theme/UI
function applyTheme(l){const r=document.documentElement,p='--'+l;['bg','accent','as','card','text','text2'].forEach(k=>r.style.setProperty('--'+k,getComputedStyle(r).getPropertyValue(p+'-'+k)))}
function setLoc(l){loc=l;applyTheme(l);document.querySelectorAll('#locG .loc-b').forEach(b=>b.classList.toggle('active',b.dataset.l===l));checkPoss();renderPitch()}
function setMood(m){mood=m;renderPitch()}
function toggleHol(){manHol=!manHol;updateBadge();checkPoss();renderPitch()}
function updateBadge(){const dt=dayType(),b=document.getElementById('dayB');b.textContent=dt==='holiday'?'Holiday':dt==='weekend'?'Weekend':'Weekday';b.className='day-badge '+dt;document.getElementById('holB').classList.toggle('active',manHol)}
function updateClock(){document.getElementById('timeD').textContent=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}

// ===== OVERLAY =====
function openOv(){document.getElementById('ovBg').classList.add('show');renderOv()}
function closeOv(){document.getElementById('ovBg').classList.remove('show')}
function switchOvTab(t){ovTab=t;document.getElementById('ovTabB').classList.toggle('active',t==='bench');document.getElementById('ovTabD').classList.toggle('active',t==='dc');document.getElementById('ovTabR').classList.toggle('active',t==='rules');renderOv()}
function renderOv(){document.getElementById('ovContent').innerHTML=ovTab==='bench'?renderBench():ovTab==='dc'?renderDC():renderRules()}

// ===== BENCH =====
function renderBench(){
  const lt=locTasks(),done=allTasks.filter(t=>t.status==='done'&&tInLoc(t,loc)&&!isInCooldown(t)).slice(0,15);
  const cooldown=allTasks.filter(t=>isInCooldown(t)&&tInLoc(t,loc));
  const tagged=lt.filter(hasCategory),untagged=lt.filter(t=>!hasCategory(t));
  const groups={};tagged.forEach(t=>{const c=tCategory(t);if(!groups[c])groups[c]=[];groups[c].push(t)});
  let h='';for(const[cat,list]of Object.entries(groups)){h+=`<div style="margin-bottom:14px"><div class="sec-hdr">${cat} <span style="background:var(--as);color:var(--accent);padding:0 6px;border-radius:8px;font-size:9px">${list.length}</span></div>${list.map(benchHTML).join('')}</div>`}
  if(untagged.length)h+=`<div style="margin-bottom:14px"><div class="sec-hdr" style="cursor:pointer" onclick="document.getElementById('uncL').style.display=document.getElementById('uncL').style.display==='none'?'block':'none'">üì¶ Uncategorized (${untagged.length}) ‚ñ∏</div><div id="uncL" style="display:none">${untagged.map(benchHTML).join('')}</div></div>`;
  if(cooldown.length)h+=`<div style="margin-bottom:14px"><div class="sec-hdr" style="cursor:pointer;color:#8B5CF6" onclick="document.getElementById('cdL').style.display=document.getElementById('cdL').style.display==='none'?'block':'none'">üîÑ In Cooldown (${cooldown.length}) ‚ñ∏</div><div id="cdL" style="display:none">${cooldown.map(benchHTML).join('')}</div></div>`;
  if(done.length)h+=`<div><div class="sec-hdr" style="cursor:pointer" onclick="document.getElementById('doneL').style.display=document.getElementById('doneL').style.display==='none'?'block':'none'">‚úÖ Done (${done.length}) ‚ñ∏</div><div id="doneL" style="display:none">${done.map(benchHTML).join('')}</div></div>`;
  return h||'<div style="text-align:center;padding:24px;color:var(--text2);font-size:12px">No tasks for this location</div>';
}
function benchHTML(t){
  const pri=tPriority(t),onP=pitchSet.has(t.id),cat=tCategory(t),isDone=t.status==='done',inCD=isInCooldown(t);
  const left=inCD?cooldownDaysLeft(t):0;const rDays=getRegenDays(t);
  const delBtn=`<button style="border:none;background:none;font-size:11px;cursor:pointer;color:#DC2626;opacity:.35;flex-shrink:0;padding:2px 4px" onclick="event.stopPropagation();askDelete('${t.id}')">üóëÔ∏è</button>`;
  if(inCD)return`<div class="bench-task done" style="opacity:.45"><div class="bench-pbar" style="background:#8B5CF6"></div><div class="bench-cb checked" style="pointer-events:none"></div><div class="bench-info"><div class="bench-title">${esc(t.name)}</div><div class="bench-meta"><span class="bench-tag" style="background:#8B5CF622;color:#8B5CF6">‚Üª ${left}d left</span>${cat?`<span class="bench-tag" style="background:var(--as);color:var(--accent)">${cat}</span>`:''}</div></div>${delBtn}</div>`;
  return`<div class="bench-task ${isDone?'done':''}"><div class="bench-pbar" style="background:${priColor(pri)}"></div><div class="bench-cb ${isDone?'checked':''}" onclick="toggleTask('${t.id}')"></div><div class="bench-info"><div class="bench-title">${esc(t.name)}</div><div class="bench-meta">${cat?`<span class="bench-tag" style="background:${priColor(pri)}22;color:${priColor(pri)}">${pri}</span><span class="bench-tag" style="background:var(--as);color:var(--accent)">${cat}</span>`:''}</div></div>${!isDone?`<button class="pitch-btn ${onP?'on':'off'}" onclick="event.stopPropagation();${onP?`rmPitch('${t.id}')`:`addPitch('${t.id}')`}">${onP?'‚úì Pitch':'‚ñ∂ Pitch'}</button>`:''} ${delBtn}</div>`;
}

// ===== DECISION CENTRE =====
function renderDC(){
  const allActive=allTasks.filter(t=>t.status!=='done'&&!isInCooldown(t));const players={attacker:{},midfielder:{},defender:{}};
  allActive.filter(hasCategory).forEach(t=>{const cat=tCategory(t),pl=catPlayer(cat);if(pl&&players[pl]){if(!players[pl][cat])players[pl][cat]=[];players[pl][cat].push(t)}});
  let h='';
  ['attacker','midfielder','defender'].forEach(pl=>{
    const info=PLAYER_INFO[pl];const cats=Object.entries(players[pl]);
    const assigned=Object.entries(playerMap).filter(([,p])=>p===pl).map(([c])=>c);
    const allCats=[...new Set([...cats.map(([c])=>c),...assigned])];
    const total=cats.reduce((s,[,l])=>s+l.length,0);
    const totalCrit=cats.reduce((s,[,l])=>s+l.filter(t=>tPriority(t)==='critical').length,0);
    h+=`<div class="player-sec ${info.cl}"><div class="player-hdr ${info.cl}"><span class="player-icon">${info.icon}</span><span class="player-name">${info.name} ${totalCrit?'(üî¥'+totalCrit+')':'('+total+')'}</span><button class="player-add-btn" onclick="openNewCatModal('${pl}')" style="margin-left:auto">+ New</button></div>`;
    if(allCats.length){h+=`<div class="dc-chips">${allCats.map(cat=>{
      const list=players[pl][cat]||[];const onP=list.filter(t=>pitchSet.has(t.id)).length;
      const critCount=list.filter(t=>tPriority(t)==='critical').length;
      return`<div class="dc-chip" onclick="openCatDetail('${cat.replace(/'/g,"\\'")}')"><span>${cat}</span>${critCount?`<span class="dc-chip-count" style="background:#DC262622;color:#DC2626">üî¥${critCount}</span>`:`<span class="dc-chip-count">${list.length}</span>`}${onP?`<span style="font-size:8px;color:#059669">‚öΩ${onP}</span>`:''}</div>`
    }).join('')}</div>`}else{h+=`<div style="font-size:10px;color:var(--text2);opacity:.5;padding:4px">No categories assigned</div>`}
    h+=`</div>`;
  });
  return h;
}

// ===== CATEGORY DETAIL =====
function openCatDetail(cat){catDetailName=cat;catDetailSearch='';document.getElementById('catDetail').classList.add('show');renderCatDetail()}
function closeCatDetail(){editingLinkId=null;document.getElementById('catDetail').classList.remove('show')}
function renderCatDetail(){
  const cat=catDetailName;const pl=catPlayer(cat);const info=pl?PLAYER_INFO[pl]:null;
  const allInCat=allTasks.filter(t=>tCategory(t)===cat);
  const tasksInCat=allInCat.filter(t=>t.status!=='done');
  const cooldownTasks=allInCat.filter(t=>isInCooldown(t));
  const doneInCat=allInCat.filter(t=>t.status==='done'&&!isInCooldown(t));
  const onPitch=tasksInCat.filter(t=>pitchSet.has(t.id)).length;
  const uncategorized=allTasks.filter(t=>t.status!=='done'&&!hasCategory(t));
  const filtered=catDetailSearch?uncategorized.filter(t=>t.name.toLowerCase().includes(catDetailSearch.toLowerCase())):[];
  const catDef=regenDefaults[cat];

  let h=`<div class="cat-top"><div class="cat-back" onclick="closeCatDetail()">‚Üê</div><div class="cat-name">${esc(cat)}</div>${info?`<div class="cat-badge ${info.cl}">${info.icon} ${info.name}</div>`:''}</div>`;
  h+=`<div class="cat-stats"><div class="cat-stat"><div class="cat-stat-num">${tasksInCat.length}</div><div class="cat-stat-lbl">Active</div></div><div class="cat-stat"><div class="cat-stat-num">${onPitch}</div><div class="cat-stat-lbl">On Pitch</div></div><div class="cat-stat"><div class="cat-stat-num">${cooldownTasks.length}</div><div class="cat-stat-lbl">Cooldown</div></div><div class="cat-stat"><div class="cat-stat-num">${doneInCat.length}</div><div class="cat-stat-lbl">Done</div></div></div>`;

  // Regen default setting
  h+=`<div style="margin-bottom:12px;padding:10px 12px;background:var(--card);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.05)"><div style="display:flex;align-items:center;justify-content:space-between"><div style="font-size:10px;font-weight:700;color:var(--text2)">‚ôªÔ∏è DEFAULT REGEN INTERVAL</div><div style="display:flex;align-items:center;gap:6px"><input id="catRegenInput" type="number" min="0" value="${catDef||''}" placeholder="days" style="width:50px;border:1.5px solid var(--as);border-radius:6px;padding:4px 6px;font-size:11px;font-family:DM Sans,sans-serif;text-align:center;background:var(--bg);color:var(--text);outline:none"><button onclick="saveCatRegen()" style="border:none;background:var(--accent);color:white;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;font-family:DM Sans,sans-serif">Set</button></div></div><div style="font-size:9px;color:var(--text2);margin-top:4px">${catDef?'All new completions regen after '+catDef+' days':'Not set ‚Äî set days so tasks regenerate after completion'}</div></div>`;

  // Add new task
  h+=`<div class="cat-add"><input class="cat-add-input" id="catNewTask" placeholder="Add new task to ${esc(cat)}..." onkeydown="if(event.key==='Enter')addTaskToCat()"><button class="cat-add-btn" onclick="addTaskToCat()">+ Add</button></div>`;

  // Search uncategorized
  h+=`<div class="sec-hdr" style="margin-top:8px">üîç Pull from uncategorized (${uncategorized.length})</div>`;
  h+=`<input class="cat-search" id="catSearchInput" placeholder="Search tasks to add to ${esc(cat)}..." value="${esc(catDetailSearch)}" oninput="catDetailSearch=this.value;renderCatDetail()">`;
  if(catDetailSearch&&filtered.length){h+=filtered.slice(0,15).map(t=>`<div class="cat-search-item"><div class="cat-search-name">${esc(t.name)}</div><button class="cat-pull-btn" onclick="assignCat('${t.id}','${cat.replace(/'/g,"\\'")}')">+ Pull in</button></div>`).join('');
    if(filtered.length>15)h+=`<div style="font-size:9px;color:var(--text2);text-align:center;padding:4px">${filtered.length-15} more...</div>`}
  else if(catDetailSearch&&!filtered.length){h+=`<div style="font-size:10px;color:var(--text2);padding:8px;text-align:center">No matches</div>`}

  // Cooldown section
  if(cooldownTasks.length){
    h+=`<div class="sec-hdr" style="margin-top:16px;color:#8B5CF6">üîÑ In Cooldown (${cooldownTasks.length})</div>`;
    h+=cooldownTasks.map(t=>{
      const left=cooldownDaysLeft(t);const days=getRegenDays(t);
      return`<div class="dc-item" style="opacity:.5"><div class="dc-item-info" style="flex:1"><div class="dc-item-n">${esc(t.name)}</div><div class="dc-item-c" style="color:#8B5CF6">‚Üª ${left} day${left!==1?'s':''} left ¬∑ regen every ${days}d</div></div><button style="border:none;background:none;font-size:12px;cursor:pointer;color:#DC2626;opacity:.6;flex-shrink:0;padding:4px" onclick="event.stopPropagation();askDelete('${t.id}')">üóëÔ∏è</button></div>`
    }).join('');
  }

  // Existing tasks grouped by priority
  if(tasksInCat.length){
    const priGroups={critical:[],high:[],medium:[],low:[],someday:[]};
    tasksInCat.forEach(t=>priGroups[tPriority(t)].push(t));
    const priLabels={critical:{l:'üî¥ Critical',c:'#DC2626'},high:{l:'üü† High',c:'#E8722A'},medium:{l:'üü° Medium',c:'#F59E0B'},low:{l:'üîµ Low',c:'#95a5a6'},someday:{l:'üí≠ Someday',c:'#bdc3c7'}};
    h+=`<div style="margin-top:16px">`;
    for(const[pri,list]of Object.entries(priGroups)){
      if(!list.length)continue;const lb=priLabels[pri];
      h+=`<div class="sec-hdr" style="margin-top:10px;color:${lb.c}">${lb.l} (${list.length})</div>`;
      h+=list.map(t=>{
        const onP=pitchSet.has(t.id),dur=isStudy(t)?tDuration(t):null,full=!onP&&!canPitch(t);
        const hasLink=t.links&&t.links.trim();const isEditing=editingLinkId===t.id;const sid=t.id.replace(/-/g,'');
        let linkHtml='';
        if(isEditing){
          linkHtml=`<div class="link-edit"><input class="link-inp" id="linkInp_${sid}" value="${esc(t.links||'')}" placeholder="https://..." onkeydown="if(event.key==='Enter'){event.stopPropagation();saveTaskLink('${t.id}')}"><div class="link-edit-btns"><button class="link-save" onclick="event.stopPropagation();saveTaskLink('${t.id}')">Save</button>${hasLink?`<button class="link-rm" onclick="event.stopPropagation();removeTaskLink('${t.id}')">Remove</button>`:''}<button class="link-cancel" onclick="event.stopPropagation();editingLinkId=null;renderCatDetail()">Cancel</button></div></div>`;
        } else if(hasLink){
          linkHtml=`<div class="dc-item-c"><a href="${esc(t.links)}" target="_blank" onclick="event.stopPropagation()" style="color:var(--accent);font-size:10px;text-decoration:none">üîó ${t.links.length>30?t.links.slice(0,30)+'‚Ä¶':t.links}</a> <button style="border:none;background:none;font-size:9px;cursor:pointer;color:var(--text2);opacity:.5" onclick="event.stopPropagation();showLinkEdit('${t.id}')">‚úèÔ∏è</button></div>`;
        }
        return`<div class="dc-item" style="flex-wrap:wrap"><div class="dc-pri-btns"><button class="dc-pri-btn" onclick="event.stopPropagation();promoteTask('${t.id}')">‚Üë</button><button class="dc-pri-btn" onclick="event.stopPropagation();demoteTask('${t.id}')">‚Üì</button></div><div class="dc-item-info"><div class="dc-item-n">${esc(t.name)}</div><div class="dc-item-c">${dur?dur+'m':''}${!hasLink&&!isEditing?` <button style="border:none;background:none;font-size:9px;cursor:pointer;color:var(--text2);opacity:.4" onclick="event.stopPropagation();showLinkEdit('${t.id}')">+ link</button>`:''}</div>${linkHtml}</div><button class="pitch-btn ${onP?'on':'off'}" ${full&&!onP?'disabled style="opacity:.4;cursor:not-allowed"':''} onclick="event.stopPropagation();${onP?`rmPitch('${t.id}')`:`addPitch('${t.id}')`}">${onP?'‚úì Pitch':full?'Full':'‚ñ∂ Pitch'}</button><button style="border:none;background:none;font-size:12px;cursor:pointer;color:#DC2626;opacity:.4;flex-shrink:0;padding:4px" onclick="event.stopPropagation();askDelete('${t.id}')">üóëÔ∏è</button></div>`
      }).join('');
    }
    h+=`</div>`;
  }

  document.getElementById('catPanel').innerHTML=h;
  if(catDetailSearch){const inp=document.getElementById('catSearchInput');if(inp){inp.focus();inp.setSelectionRange(inp.value.length,inp.value.length)}}
  if(editingLinkId){const sid=editingLinkId.replace(/-/g,'');const inp=document.getElementById('linkInp_'+sid);if(inp){inp.focus();inp.setSelectionRange(inp.value.length,inp.value.length)}}
}
async function saveCatRegen(){const v=document.getElementById('catRegenInput').value;const days=v?parseInt(v):null;if(days!=null&&days>0)regenDefaults[catDetailName]=days;else delete regenDefaults[catDetailName];await saveRegenDefaults();renderCatDetail()}
async function addTaskToCat(){const inp=document.getElementById('catNewTask');const name=inp.value.trim();if(!name)return;await createTask(name,catDetailName);inp.value='';renderCatDetail()}

// ===== NEW CATEGORY MODAL =====
let catModalForPlayer='attacker';
function openNewCatModal(pl){catModalForPlayer=pl;document.getElementById('catModalTitle').textContent='New Category';document.getElementById('catModalInput').value='';document.getElementById('catModalPlayer').value=pl;document.getElementById('catModal').classList.add('show')}
function closeCatModal(){document.getElementById('catModal').classList.remove('show')}
async function saveCatModal(){
  const player=document.getElementById('catModalPlayer').value;
  const name=document.getElementById('catModalInput').value.trim();if(!name){alert('Enter a name');return}
  let catTag=allTags.find(t=>t.type==='category'&&t.name.toLowerCase()===name.toLowerCase());
  if(!catTag){const{data,error}=await sb.from('mind_map_app_tags').insert({id:crypto.randomUUID(),name,type:'category',color:'#7f8c8d',is_focused:false,sort_order:0,created_at:new Date().toISOString()}).select().single();if(error){alert('Error: '+error.message);return}if(data){allTags.push(data);tagMap[data.id]=data;catTag=data}}
  playerMap[catTag?catTag.name:name]=player;await savePlayerMap();closeCatModal();renderOv();
}

// ===== POSSESSION =====
const M_T=[{id:'mc',t:'Make coffee / tea',i:'‚òï'},{id:'mw',t:'Drink water',i:'üíß'},{id:'mf',t:'Face wash',i:'üßº'}];
const L_T=[{id:'le',t:'Eat a proper lunch',i:'üç±'},{id:'lw',t:'Drink water',i:'üíß'},{id:'lo',t:'Organize food',i:'üóÑÔ∏è'},{id:'ls',t:'Shopping list check',i:'üõí'}];
const D_T=[{id:'dg',t:'Grooming / skincare',i:'ü™û'},{id:'dl',t:'Laundry',i:'üëî'},{id:'dc',t:'Clean room',i:'üßπ'},{id:'ds',t:"Prep tomorrow's clothes",i:'üëï'},{id:'dd',t:'Wind down',i:'üò¥'}];
function checkPoss(){if(!isOff()||loc!=='home'){hideAllLocks();clearNudge();return}applyPoss()}
function applyPoss(){hideAllLocks();clearNudge();if(possession==='mid_morning')showLock('lockM','lockMT','lockMB','lockMS',M_T,morningCk);else if(possession==='attacker'||possession==='attacker2')startNudge();else if(possession==='mid_lunch')showLunchLock();else if(possession==='defender')showDefLock()}
function hideAllLocks(){['lockM','lockL','lockD'].forEach(id=>document.getElementById(id).classList.remove('show'))}
function showLock(ov,tid,bid,sid,list,set){set.clear();document.getElementById(tid).innerHTML=list.map(t=>`<div class="lock-task" id="lk_${t.id}" onclick="tglLock('${t.id}','${ov}')"><div class="lt-cb" id="lcb_${t.id}"></div><span class="lt-text">${t.t}</span><span class="lt-icon">${t.i}</span></div>`).join('');updLockBtn(bid,sid,set,ov==='lockM');document.getElementById(ov).classList.add('show')}
function tglLock(id,ov){const set=ov==='lockM'?morningCk:ov==='lockL'?lunchCk:defCk;set.has(id)?set.delete(id):set.add(id);const list=ov==='lockM'?M_T:ov==='lockL'?L_T:D_T;list.forEach(t=>{document.getElementById('lk_'+t.id)?.classList.toggle('checked',set.has(t.id));document.getElementById('lcb_'+t.id)?.classList.toggle('checked',set.has(t.id))});const td=ov==='lockM'?true:ov==='lockL'?lunchRem<=0:defRem<=0;updLockBtn(ov==='lockM'?'lockMB':ov==='lockL'?'lockLB':'lockDB',ov==='lockM'?'lockMS':ov==='lockL'?'lockLS':'lockDS',set,td)}
function updLockBtn(b,s,set,td){const r=set.size>=1&&td;document.getElementById(b).className='lock-btn '+(r?'ready':'waiting');document.getElementById(s).textContent=r?'Ready! ‚öΩ':set.size<1?'Check at least one':'‚úÖ Checked ‚Äî wait'}
function unlockM(){if(morningCk.size<1)return;possession='attacker';savePoss();hideAllLocks();startNudge();renderPitch()}
function showLunchLock(){lunchCk.clear();lunchRem=3600;showLock('lockL','lockLT','lockLB','lockLS',L_T,lunchCk);clearInterval(lunchInt);lunchInt=setInterval(()=>{lunchRem--;document.getElementById('lunchT').textContent=`${String(Math.floor(lunchRem/60)).padStart(2,'0')}:${String(lunchRem%60).padStart(2,'0')}`;updLockBtn('lockLB','lockLS',lunchCk,lunchRem<=0);if(lunchRem<=0)clearInterval(lunchInt)},1000)}
function unlockL(){if(lunchCk.size<1||lunchRem>0)return;clearInterval(lunchInt);possession='attacker2';savePoss();hideAllLocks();startNudge();renderPitch()}
function showDefLock(){defCk.clear();defRem=1800;showLock('lockD','lockDT','lockDB','lockDS',D_T,defCk);clearInterval(defInt);defInt=setInterval(()=>{defRem--;document.getElementById('defT').textContent=`${String(Math.floor(defRem/60)).padStart(2,'0')}:${String(defRem%60).padStart(2,'0')}`;updLockBtn('lockDB','lockDS',defCk,defRem<=0);if(defRem<=0)clearInterval(defInt)},1000)}
function unlockD(){if(defCk.size<1||defRem>0)return;clearInterval(defInt);possession='done';savePoss();hideAllLocks();renderPitch()}
function triggerDef(){possession='defender';savePoss();clearNudge();stopTimer();showDefLock();renderPitch()}
function skipLock(type){hideAllLocks();clearInterval(lunchInt);clearInterval(defInt);if(type==='morning')possession='attacker';else if(type==='lunch')possession='attacker2';else possession='done';savePoss();if(possession==='attacker'||possession==='attacker2')startNudge();renderPitch()}
setInterval(()=>{if(isOff()&&loc==='home'&&possession==='attacker'&&new Date().getHours()>=13){possession='mid_lunch';savePoss();stopTimer();applyPoss();renderPitch()}},60000);
const NUDGES=[{i:'üíß',t:'Drink water!'},{i:'üßò',t:'Quick stretch'},{i:'üëÄ',t:'Look away 20s'},{i:'ü´Å',t:'3 deep breaths'},{i:'üö∂',t:'Stand up'}];
function startNudge(){clearNudge();lastNudge=Date.now();nudgeInt=setInterval(()=>{if(Date.now()-lastNudge>=3600000){const n=NUDGES[Math.floor(Math.random()*NUDGES.length)];document.getElementById('nudgeT').textContent=n.t;document.querySelector('.nudge-icon').textContent=n.i;document.getElementById('nudge').classList.add('show');lastNudge=Date.now();setTimeout(dismissNudge,30000)}},60000)}
function dismissNudge(){document.getElementById('nudge').classList.remove('show')}
function clearNudge(){clearInterval(nudgeInt);dismissNudge()}

// ===== STUDY TIMER =====
function startStudy(id){const t=allTasks.find(x=>x.id===id);if(!t)return;studyTimerTotal=tDuration(t)*60;studyTimerRem=studyTimerTotal;currentStudyId=id;studyTimerActive=true;clearInterval(studyTimerInt);studyTimerInt=setInterval(()=>{studyTimerRem--;renderPitch();if(studyTimerRem<=0){studyTimerActive=false;clearInterval(studyTimerInt);triggerBreak()}},1000);renderPitch()}
function pauseStudy(){studyTimerActive=false;clearInterval(studyTimerInt);renderPitch()}
function resumeStudy(){if(!currentStudyId||studyTimerRem<=0)return;studyTimerActive=true;studyTimerInt=setInterval(()=>{studyTimerRem--;renderPitch();if(studyTimerRem<=0){studyTimerActive=false;clearInterval(studyTimerInt);triggerBreak()}},1000);renderPitch()}
async function completeStudy(){studyTimerActive=false;clearInterval(studyTimerInt);const id=currentStudyId;studyTimerRem=0;currentStudyId=null;const t=allTasks.find(x=>x.id===id);if(t){pendingDoneId=id;showRegenPopup(t);renderPitch()}}
function stopTimer(){studyTimerActive=false;clearInterval(studyTimerInt);currentStudyId=null;studyTimerRem=0}
const TIPS=[{i:'üíß',t:'Drink water'},{i:'üçô',t:'Snack'},{i:'üßò',t:'Stretch'},{i:'üëÄ',t:'Rest eyes'},{i:'üö∂',t:'Walk'},{i:'ü´Å',t:'Deep breaths'},{i:'üéµ',t:'Song'}];
function triggerBreak(){breakRem=300;document.getElementById('breakOv').classList.add('show');document.getElementById('breakIcon').textContent=['üåø','üåä','‚òÄÔ∏è','üçÉ'][Math.floor(Math.random()*4)];document.getElementById('breakTips').innerHTML=[...TIPS].sort(()=>Math.random()-.5).slice(0,3).map(t=>`<div class="break-tip"><span style="font-size:18px">${t.i}</span><span>${t.t}</span></div>`).join('');breakInt=setInterval(()=>{breakRem--;document.getElementById('bTime').textContent=`${Math.floor(breakRem/60)}:${String(breakRem%60).padStart(2,'0')}`;document.getElementById('bRing').style.strokeDashoffset=276.46*(1-breakRem/300);if(breakRem<=0)endBreak()},1000)}
async function endBreak(){clearInterval(breakInt);document.getElementById('breakOv').classList.remove('show');const t=allTasks.find(x=>x.id===currentStudyId);if(t){pendingDoneId=currentStudyId;currentStudyId=null;showRegenPopup(t)}else{currentStudyId=null;const next=pitched().filter(isStudy);if(next.length)startStudy(next[0].id);else renderPitch()}}
function skipBreak(){endBreak()}

// ===== RENDER PITCH =====
function renderPitch(){
  const field=document.getElementById('pitchField'),strip=document.getElementById('possStrip');
  if(loc==='home'&&isOff()){const p={attacker:{d:'d-atk',cl:'atk',t:'‚öîÔ∏è Attackers',s:'Focus'},attacker2:{d:'d-atk',cl:'atk',t:'‚öîÔ∏è Second Half',s:'Keep going'},mid_morning:{d:'d-mid',cl:'mid',t:'‚òï Midfield',s:'Morning'},mid_lunch:{d:'d-mid',cl:'mid',t:'üç± Midfield',s:'Lunch'},defender:{d:'d-def',cl:'def',t:'ü™û Defenders',s:'Self-care'},done:{d:'d-done',cl:'done',t:'‚úÖ Done',s:'Great day!'}}[possession]||{d:'d-atk',cl:'atk',t:'‚öîÔ∏è',s:''};strip.innerHTML=`<div class="poss-strip ${p.cl}"><div class="poss-dot ${p.d}"></div><span class="poss-text">${p.t}</span><span class="poss-sub">${p.s}</span>${(possession==='attacker'||possession==='attacker2')?`<button class="pass-def-btn" onclick="triggerDef()">ü™û Defenders</button>`:''}</div>`}else strip.innerHTML='';
  if(loc==='outside'){let h=`<div style="width:100%"><div class="mood-bar">${[['Energetic','üí™'],['Bit tired','üòä'],['Tired','üòî'],['Sleepy','üò¥']].map(([m,e])=>`<div class="mood-btn ${mood===m?'active':''}" onclick="setMood('${m}')"><span class="mood-emoji">${e}</span><span class="mood-lbl">${m}</span></div>`).join('')}</div></div>`;if(mood==='Sleepy')h+=`<a class="link-c" href="https://youtube.com" target="_blank"><span style="font-size:24px">üì∫</span><div style="font-size:13px;font-weight:600">YouTube</div></a>`;const pt=pitched();if(pt.length)h+=pt.map(t=>`<div class="dev-card"><div class="dev-cb" onclick="toggleTask('${t.id}')"></div><div class="dev-title">${esc(t.name)}</div><div class="dev-tag">${tCategory(t)}</div><button class="dev-rm" onclick="rmPitch('${t.id}')">‚úï</button></div>`).join('');field.innerHTML=h;return}
  
  const pt=pitched();
  if(!pt.length){field.innerHTML=`<div class="fp"><div class="fp-lines"><svg viewBox="0 0 300 450" preserveAspectRatio="none"><line x1="0" y1="225" x2="300" y2="225"/><circle cx="150" cy="225" r="45"/><circle cx="150" cy="225" r="2" fill="rgba(255,255,255,.3)"/><rect x="75" y="0" width="150" height="70"/><rect x="110" y="0" width="80" height="25"/><rect x="75" y="380" width="150" height="70"/><rect x="110" y="425" width="80" height="25"/><line x1="0" y1="0" x2="300" y2="0"/><line x1="0" y1="450" x2="300" y2="450"/><line x1="0" y1="0" x2="0" y2="450"/><line x1="300" y1="0" x2="300" y2="450"/></svg></div><div class="fp-empty"><div class="fp-empty-icon">‚öΩ</div><div class="fp-empty-text">The pitch is empty</div><div class="fp-empty-sub">Open ‚ò∞ and select tasks</div></div></div>`;return}

  // Group pitched tasks by category ‚Üí player type (filter by timeslot)
  const catGroups={};
  pt.forEach(t=>{const cat=tCategory(t)||'Other';if(!catGroups[cat])catGroups[cat]=[];catGroups[cat].push(t)});
  const zones={attacker:[],midfielder:[],defender:[],other:[]};
  for(const[cat,tasks]of Object.entries(catGroups)){
    const pl=catPlayer(cat);
    // Time slot filter: hide attackers outside their allowed window
    if(pl==='attacker'&&!isCatAllowedNow(cat))continue;
    if(pl&&zones[pl])zones[pl].push({cat,tasks});else zones.other.push({cat,tasks});
  }
  // Merge other into midfielder
  zones.midfielder.push(...zones.other);zones.other=[];
  
  const CIRC=2*Math.PI*60;

  // Position calculator ‚Äî vertical pitch: attackers top, mid center, def bottom
  function getPositions(list,yCenter,ySpread){
    const n=list.length;if(!n)return[];
    const positions=[];
    if(n===1){positions.push({x:50,y:yCenter})}
    else if(n===2){positions.push({x:30,y:yCenter},{x:70,y:yCenter})}
    else if(n===3){positions.push({x:50,y:yCenter-ySpread},{x:25,y:yCenter+ySpread},{x:75,y:yCenter+ySpread})}
    else if(n===4){positions.push({x:25,y:yCenter-ySpread},{x:75,y:yCenter-ySpread},{x:25,y:yCenter+ySpread},{x:75,y:yCenter+ySpread})}
    else{for(let i=0;i<n;i++){const angle=(i/(n))*Math.PI*2-Math.PI/2;positions.push({x:50+Math.cos(angle)*25,y:yCenter+Math.sin(angle)*ySpread})}}
    return positions;
  }

  const atkPos=getPositions(zones.attacker,18,7);
  const midPos=getPositions(zones.midfielder,50,8);
  const defPos=getPositions(zones.defender,82,7);

  let dots='';
  function renderDots(list,positions,cl){
    list.forEach((g,i)=>{
      const pos=positions[i]||{x:50,y:50};const isExp=expandedDot===g.cat;const taskCount=g.tasks.length;
      // Per-category blur for attackers
      const blur=cl==='atk'&&isAtkDotBlurred(g.cat);
      dots+=`<div class="fp-dot ${isExp?'active':''} ${blur?'blurred':''}" style="left:${pos.x}%;top:${pos.y}%" onclick="${blur?'':`event.stopPropagation();toggleDot('${g.cat.replace(/'/g,"\\'")}')`}"><div class="fp-ball ${cl}" style="position:relative"><span style="font-size:${g.cat.length>6?'7':'8'}px;line-height:1.2">${g.cat.length>10?g.cat.slice(0,9)+'‚Ä¶':g.cat}</span>${taskCount>1?`<div class="fp-count">${taskCount}</div>`:''}</div><div class="fp-lbl">${g.cat}</div>`;
      // Expanded card
      if(isExp&&!blur){
        const cardDir=pos.y>60?'above':'';
        dots+=`<div class="fp-card ${cardDir}" onclick="event.stopPropagation()"><button class="fp-card-close" onclick="event.stopPropagation();expandedDot='';renderPitch()">‚úï</button><div class="fp-card-cat ${cl}">${g.cat} ‚Äî ${taskCount} task${taskCount>1?'s':''}</div>`;
        g.tasks.forEach(t=>{
          const dur=tDuration(t);const isSt=isStudy(t);
          const hasLnk=t.links&&t.links.trim();
          dots+=`<div class="fp-card-task" style="flex-wrap:wrap"><div class="fp-card-cb" onclick="event.stopPropagation();toggleTask('${t.id}')"></div><div class="fp-card-name">${esc(t.name)}</div>${hasLnk?`<a href="${esc(t.links)}" target="_blank" onclick="event.stopPropagation()" style="font-size:10px;text-decoration:none;flex-shrink:0">üîó</a>`:''}${isSt?`<button class="fp-card-btn timer" onclick="event.stopPropagation();startStudy('${t.id}')">‚ñ∂ ${dur}m</button>`:`<button class="fp-card-btn check" onclick="event.stopPropagation();toggleTask('${t.id}')">‚úì</button>`}</div>`;
        });
        dots+=`</div>`;
      }
      dots+=`</div>`;
    });
  }
  renderDots(zones.attacker,atkPos,'atk');
  renderDots(zones.midfielder,midPos,'mid');
  renderDots(zones.defender,defPos,'def');

  // Timer overlay
  let timerHtml='';
  const activeStudy=currentStudyId?pt.find(t=>t.id===currentStudyId):null;
  if(activeStudy&&(studyTimerActive||studyTimerRem>0)){
    const pct=studyTimerTotal>0?studyTimerRem/studyTimerTotal:1,off=CIRC*(1-pct);
    const m=Math.floor(studyTimerRem/60),s=studyTimerRem%60;
    timerHtml=`<div class="fp-timer"><div class="fp-timer-label">üìì NOW STUDYING</div><div class="fp-timer-title">${esc(activeStudy.name)}</div><div class="fp-timer-cat">${tCategory(activeStudy)}</div><div class="fp-timer-ring"><svg viewBox="0 0 140 140"><circle class="tr-bg" cx="70" cy="70" r="60"/><circle class="tr-fill" cx="70" cy="70" r="60" stroke-dasharray="${CIRC}" stroke-dashoffset="${off}"/></svg><div class="fp-timer-digits">${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}<div class="fp-timer-status">${studyTimerActive?'studying':'paused'}</div></div></div><div class="fp-timer-btns">${studyTimerActive?`<button class="fp-timer-btn pause" onclick="pauseStudy()">‚è∏ Pause</button>`:`<button class="fp-timer-btn start" onclick="resumeStudy()">‚ñ∂ Resume</button>`}<button class="fp-timer-btn done" onclick="completeStudy()">‚úì Done</button></div></div>`;
  }

  let lockMsg='';
  if(pitchRotation==='cooldown_atk')lockMsg=`<div class="fp-lock-msg">üîÑ Do a Mid/Defender task to unlock Attackers</div>`;
  else if(lastDoneAtkCat&&zones.attacker.some(g=>g.cat===lastDoneAtkCat))lockMsg=`<div class="fp-lock-msg">üîí ${lastDoneAtkCat} resting ‚Äî use other attackers</div>`;

  field.innerHTML=`<div class="fp" onclick="expandedDot='';renderPitch()"><div class="fp-lines"><svg viewBox="0 0 300 450" preserveAspectRatio="none"><line x1="0" y1="225" x2="300" y2="225"/><circle cx="150" cy="225" r="45"/><circle cx="150" cy="225" r="2" fill="rgba(255,255,255,.3)"/><rect x="75" y="0" width="150" height="70"/><rect x="110" y="0" width="80" height="25"/><rect x="75" y="380" width="150" height="70"/><rect x="110" y="425" width="80" height="25"/><line x1="0" y1="0" x2="300" y2="0"/><line x1="0" y1="450" x2="300" y2="450"/><line x1="0" y1="0" x2="0" y2="450"/><line x1="300" y1="0" x2="300" y2="450"/></svg></div>${dots}${timerHtml}${lockMsg}</div>`;
}
function toggleDot(cat){expandedDot=expandedDot===cat?'':cat;renderPitch()}

// ===== RULES PANEL =====
function renderRules(){
  // Get all attacker categories
  const atkCats=Object.entries(playerMap).filter(([,p])=>p==='attacker').map(([c])=>c);
  const hr=new Date().getHours();
  const dt=dayType();

  let h=`<div style="margin-bottom:16px"><div style="font-family:'Fraunces',serif;font-size:15px;font-weight:700;margin-bottom:4px">‚öîÔ∏è Attacker Time Slots</div><div style="font-size:10px;color:var(--text2);line-height:1.5">Set when each attacker can appear on the pitch during weekdays. Mid/Def are always available.</div></div>`;

  if(!atkCats.length){h+=`<div style="font-size:11px;color:var(--text2);text-align:center;padding:20px">No attacker categories assigned yet</div>`;return h}

  atkCats.forEach(cat=>{
    const rule=timeSlotRules[cat]||{};
    const wdFrom=rule.weekday_from!=null?rule.weekday_from:0;
    const wdTo=rule.weekday_to!=null?rule.weekday_to:24;
    const wkend=rule.weekend!==false;
    const allowed=isCatAllowedNow(cat);

    h+=`<div class="rule-card"><div class="rule-top"><div class="rule-name">${esc(cat)}</div><div class="rule-status ${allowed?'on':'off'}">${allowed?'‚óè Available':'‚óã Blocked'}</div></div>`;

    // Weekday hours
    h+=`<div class="rule-row"><div class="rule-label">Weekday hours</div><div class="rule-inputs"><select class="rule-sel" id="rs_${cat.replace(/\s/g,'_')}_from" onchange="updateTimeSlot('${cat.replace(/'/g,"\\'")}')">`;
    for(let i=0;i<=23;i++){h+=`<option value="${i}" ${i===wdFrom?'selected':''}>${String(i).padStart(2,'0')}:00</option>`}
    h+=`</select><span style="font-size:10px;color:var(--text2)">to</span><select class="rule-sel" id="rs_${cat.replace(/\s/g,'_')}_to" onchange="updateTimeSlot('${cat.replace(/'/g,"\\'")}')">`;
    for(let i=1;i<=24;i++){h+=`<option value="${i}" ${i===wdTo?'selected':''}>${i===24?'24:00':String(i).padStart(2,'0')+':00'}</option>`}
    h+=`</select></div></div>`;

    // Weekend toggle
    h+=`<div class="rule-row"><div class="rule-label">Weekends & holidays</div><button class="rule-toggle ${wkend?'on':''}" onclick="toggleWeekend('${cat.replace(/'/g,"\\'")}')">${wkend?'‚úì Available':'‚úï Blocked'}</button></div>`;

    // Quick presets
    h+=`<div class="rule-presets"><button class="rule-preset" onclick="setPreset('${cat.replace(/'/g,"\\'")}','always')">Always</button><button class="rule-preset" onclick="setPreset('${cat.replace(/'/g,"\\'")}','evening')">Evening (18+)</button><button class="rule-preset" onclick="setPreset('${cat.replace(/'/g,"\\'")}','morning')">Morning (6-12)</button><button class="rule-preset" onclick="setPreset('${cat.replace(/'/g,"\\'")}','offhours')">Off-hours (20+)</button></div>`;

    h+=`</div>`;
  });

  // Rotation info
  h+=`<div style="margin-top:20px;padding:12px;background:var(--card);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.05)"><div style="font-size:10px;font-weight:700;color:var(--text2);margin-bottom:6px">üîÑ ROTATION STATUS</div>`;
  h+=`<div style="font-size:11px;color:var(--text);line-height:1.6">`;
  h+=`State: <strong>${pitchRotation==='cooldown_atk'?'All attackers blocked':'Free'}</strong><br>`;
  h+=`Last completed attacker: <strong>${lastDoneAtkCat||'None'}</strong>${lastDoneAtkCat?' (individually resting)':''}`;
  h+=`</div>`;
  if(lastDoneAtkCat||pitchRotation==='cooldown_atk'){h+=`<button onclick="pitchRotation='free';lastDoneAtkCat='';renderAll()" style="margin-top:6px;border:none;background:#DC262622;color:#DC2626;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif">Reset Rotation</button>`}
  h+=`</div>`;

  return h;
}
async function updateTimeSlot(cat){
  const safeId=cat.replace(/\s/g,'_');
  const from=parseInt(document.getElementById('rs_'+safeId+'_from').value);
  const to=parseInt(document.getElementById('rs_'+safeId+'_to').value);
  if(!timeSlotRules[cat])timeSlotRules[cat]={};
  timeSlotRules[cat].weekday_from=from;timeSlotRules[cat].weekday_to=to;
  await saveTimeSlots();renderOv();
}
async function toggleWeekend(cat){
  if(!timeSlotRules[cat])timeSlotRules[cat]={};
  timeSlotRules[cat].weekend=timeSlotRules[cat].weekend===false?true:false;
  await saveTimeSlots();renderOv();
}
async function setPreset(cat,preset){
  if(!timeSlotRules[cat])timeSlotRules[cat]={};
  if(preset==='always'){timeSlotRules[cat]={weekday_from:0,weekday_to:24,weekend:true}}
  else if(preset==='evening'){timeSlotRules[cat]={weekday_from:18,weekday_to:24,weekend:true}}
  else if(preset==='morning'){timeSlotRules[cat]={weekday_from:6,weekday_to:12,weekend:true}}
  else if(preset==='offhours'){timeSlotRules[cat]={weekday_from:20,weekday_to:24,weekend:true}}
  await saveTimeSlots();renderOv();
}

async function init(){applyTheme(loc);updateBadge();updateClock();setInterval(updateClock,60000);await loadAll();await checkAndReactivate();document.getElementById('loadingView').style.display='none';document.getElementById('pitch').style.display='';document.getElementById('cornerBtn').style.display='';checkPoss();renderPitch()}
init();
</script>
</body>
</html>
