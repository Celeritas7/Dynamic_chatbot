<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ContextFlow</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&display=swap" rel="stylesheet">
<style>
:root{
  --home-bg:#FFF8F0;--home-accent:#E8722A;--home-as:#FFF0E5;--home-card:#FFF;--home-text:#2D1B0E;--home-text2:#8B7355;
  --office-bg:#F0F4FF;--office-accent:#3B5BDB;--office-as:#E5EAFF;--office-card:#FFF;--office-text:#0E1B3D;--office-text2:#5B6B8A;
  --outside-bg:#F0FFF4;--outside-accent:#38A169;--outside-as:#E6FFED;--outside-card:#FFF;--outside-text:#1A3A2A;--outside-text2:#5A8A6A;
  --bg:var(--home-bg);--accent:var(--home-accent);--as:var(--home-as);--card:var(--home-card);--text:var(--home-text);--text2:var(--home-text2);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background .5s,color .4s;-webkit-tap-highlight-color:transparent;overflow-x:hidden}
.app{max-width:520px;margin:0 auto;min-height:100vh;position:relative}
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:12px}
.loading-spinner{width:32px;height:32px;border:3px solid var(--as);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:13px;color:var(--text2)}
.pitch{display:flex;flex-direction:column;min-height:100vh;padding:16px}
.pitch-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.pitch-name{font-family:'Fraunces',serif;font-size:18px;font-weight:700}
.pitch-r{display:flex;align-items:center;gap:8px}
.pitch-time{font-size:11px;color:var(--text2)}
.day-badge{font-size:9px;font-weight:700;padding:2px 8px;border-radius:12px}
.day-badge.weekday{background:#E5EAFF;color:#3B5BDB}.day-badge.weekend{background:#FFF0E5;color:#E8722A}.day-badge.holiday{background:#FFE5E5;color:#DC2626}
.hol-btn{background:none;border:1.5px solid var(--as);border-radius:7px;padding:2px 7px;font-size:9px;font-family:'DM Sans',sans-serif;cursor:pointer;color:var(--text2);transition:all .2s}
.hol-btn.active{background:#DC2626;color:white;border-color:#DC2626}
.corner-btn{position:fixed;bottom:20px;right:20px;width:48px;height:48px;border-radius:50%;border:none;background:var(--accent);color:white;font-size:20px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,.2);z-index:200;transition:all .3s;display:flex;align-items:center;justify-content:center}
.loc-bar{display:flex;gap:6px;margin-bottom:12px}
.loc-g{display:flex;background:var(--card);border-radius:12px;padding:3px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.loc-b{border:none;background:transparent;padding:6px 12px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:500;color:var(--text2);cursor:pointer;transition:all .3s;white-space:nowrap}
.loc-b.active{background:var(--accent);color:white}
.poss-strip{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:14px;margin-bottom:16px;transition:all .4s}
.poss-strip.atk{background:linear-gradient(135deg,rgba(220,38,38,.1),rgba(220,38,38,.05))}
.poss-strip.mid{background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(245,158,11,.05))}
.poss-strip.def{background:linear-gradient(135deg,rgba(139,92,246,.1),rgba(139,92,246,.05))}
.poss-strip.done{background:linear-gradient(135deg,rgba(5,150,105,.1),rgba(5,150,105,.05))}
.poss-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.4)}}
.poss-dot.d-atk{background:#DC2626}.poss-dot.d-mid{background:#F59E0B}.poss-dot.d-def{background:#8B5CF6}.poss-dot.d-done{background:#059669}
.poss-text{flex:1;font-size:12px;font-weight:600}.poss-sub{font-size:10px;color:var(--text2)}
.pass-def-btn{border:none;padding:6px 12px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;cursor:pointer;background:#8B5CF6;color:white;transition:all .2s;flex-shrink:0}
.pitch-field{flex:1;display:flex;flex-direction:column;align-items:center;padding:8px 0}
/* Football pitch */
.fp{position:relative;width:100%;max-width:420px;min-height:520px;background:linear-gradient(180deg,#2d8a4e 0%,#34a058 20%,#2d8a4e 40%,#34a058 60%,#2d8a4e 80%,#34a058 100%);border-radius:18px;overflow:visible;box-shadow:inset 0 0 0 3px rgba(255,255,255,.25),0 8px 32px rgba(0,0,0,.15)}
.fp-lines{position:absolute;inset:0;pointer-events:none;overflow:hidden;border-radius:18px}
.fp-lines svg{width:100%;height:100%}
.fp-lines line,.fp-lines circle,.fp-lines rect{stroke:rgba(255,255,255,.3);stroke-width:1.5;fill:none}
/* Player dot */
.fp-dot{position:absolute;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:all .35s ease;z-index:5;transform:translateX(-50%)}
.fp-dot.blurred{opacity:.25;filter:blur(3px);pointer-events:none}
.fp-ball{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:white;box-shadow:0 3px 12px rgba(0,0,0,.3);transition:all .3s;border:2.5px solid rgba(255,255,255,.5);text-align:center;line-height:1.1}
.fp-ball.atk{background:linear-gradient(135deg,#EF4444,#DC2626)}.fp-ball.mid{background:linear-gradient(135deg,#F59E0B,#D97706)}.fp-ball.def{background:linear-gradient(135deg,#3B82F6,#2563EB)}
.fp-dot:active .fp-ball{transform:scale(1.15)}
.fp-dot.active .fp-ball{transform:scale(1.1);box-shadow:0 0 0 4px rgba(255,255,255,.5),0 4px 16px rgba(0,0,0,.4)}
.fp-lbl{font-size:8px;font-weight:700;color:white;text-shadow:0 1px 4px rgba(0,0,0,.6);margin-top:3px;max-width:64px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fp-count{position:absolute;top:-4px;right:-4px;width:16px;height:16px;border-radius:50%;background:#DC2626;color:white;font-size:8px;font-weight:700;display:flex;align-items:center;justify-content:center;border:1.5px solid rgba(255,255,255,.7)}
/* Expanded card */
.fp-card{position:absolute;left:50%;transform:translateX(-50%);top:100%;margin-top:8px;width:240px;background:white;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,.25);padding:12px;z-index:20;animation:cardPop .25s ease}
@keyframes cardPop{from{opacity:0;transform:translateX(-50%) translateY(-8px) scale(.9)}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}
.fp-card::before{content:'';position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:12px;height:12px;background:white;border-radius:2px;rotate:45deg}
.fp-card-cat{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.fp-card-cat.atk{color:#DC2626}.fp-card-cat.mid{color:#D97706}.fp-card-cat.def{color:#2563EB}
.fp-card-task{display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid #f0f0f0}
.fp-card-task:last-child{border-bottom:none}
.fp-card-cb{width:16px;height:16px;border-radius:4px;border:2px solid #ccc;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fp-card-cb:hover{border-color:#3B82F6}
.fp-card-name{font-size:11px;font-weight:500;flex:1;color:#1a1a1a;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fp-card-btn{border:none;padding:3px 8px;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;cursor:pointer;flex-shrink:0}
.fp-card-btn.timer{background:#2563EB;color:white}.fp-card-btn.check{background:#059669;color:white}
.fp-card-close{position:absolute;top:6px;right:8px;border:none;background:none;font-size:14px;cursor:pointer;color:#999}
.fp-card.above{top:auto;bottom:100%;margin-top:0;margin-bottom:8px}
.fp-card.above::before{top:auto;bottom:-6px}
/* Empty pitch */
.fp-empty{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:rgba(255,255,255,.6)}
.fp-empty-icon{font-size:48px;margin-bottom:10px;opacity:.5}
.fp-empty-text{font-family:'Fraunces',serif;font-size:16px;font-weight:600}
.fp-empty-sub{font-size:11px;opacity:.7;margin-top:4px}
/* Rotation lock overlay */
.fp-lock-msg{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);color:white;padding:6px 16px;border-radius:20px;font-size:10px;font-weight:600;z-index:10;white-space:nowrap;backdrop-filter:blur(4px)}
/* Timer overlay on pitch */
.fp-timer{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:30;border-radius:18px;color:white;text-align:center}
.fp-timer-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;opacity:.8;margin-bottom:6px}
.fp-timer-title{font-family:'Fraunces',serif;font-size:20px;font-weight:700;margin-bottom:2px}
.fp-timer-cat{font-size:11px;opacity:.7;margin-bottom:16px}
.fp-timer-ring{width:150px;height:150px;position:relative;margin-bottom:16px}
.fp-timer-ring svg{width:150px;height:150px;transform:rotate(-90deg)}
.fp-timer-ring circle{fill:none;stroke-width:5}
.tr-bg{stroke:rgba(255,255,255,.2)}.tr-fill{stroke:white;stroke-linecap:round;transition:stroke-dashoffset 1s linear}
.fp-timer-digits{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:36px;font-weight:700;letter-spacing:-1px}
.fp-timer-status{font-size:10px;opacity:.6;margin-top:2px}
.fp-timer-btns{display:flex;gap:10px}
.fp-timer-btn{border:none;padding:10px 20px;border-radius:12px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer}
.fp-timer-btn.start{background:white;color:#1a1a1a}.fp-timer-btn.pause{background:#F59E0B;color:white}.fp-timer-btn.done{background:#059669;color:white}
/* Dev card (bench, outside) */
.dev-card{background:var(--card);border-radius:14px;padding:14px;margin-bottom:8px;box-shadow:0 1px 4px rgba(0,0,0,.05);display:flex;align-items:center;gap:10px}
.dev-cb{width:20px;height:20px;border-radius:6px;border:2px solid var(--accent);flex-shrink:0;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s}
.dev-cb.checked{background:var(--accent);border-color:var(--accent)}
.dev-cb.checked::after{content:'✓';color:white;font-size:11px;font-weight:700}
.dev-title{font-size:14px;font-weight:500;flex:1}.dev-tag{font-size:10px;color:var(--text2)}
.dev-rm{border:none;background:none;font-size:12px;cursor:pointer;color:var(--text2);flex-shrink:0}
.mood-bar{display:flex;gap:8px;margin-bottom:14px;width:100%}
.mood-btn{flex:1;border:2px solid var(--as);background:var(--card);border-radius:12px;padding:10px 6px;text-align:center;cursor:pointer;transition:all .3s;font-family:'DM Sans',sans-serif}
.mood-btn.active{border-color:var(--accent);background:var(--as);transform:scale(1.03)}
.mood-emoji{font-size:24px;display:block;margin-bottom:2px}.mood-lbl{font-size:10px;font-weight:600;color:var(--text2)}
.link-c{background:var(--card);border-radius:13px;padding:13px;margin-bottom:7px;box-shadow:0 1px 3px rgba(0,0,0,.05);display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .3s;text-decoration:none;color:var(--text);width:100%;max-width:420px}

/* ==== CENTERED OVERLAY ==== */
.ov-bg{display:none;position:fixed;inset:0;z-index:400;background:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
.ov-bg.show{display:flex;align-items:center;justify-content:center;animation:ovIn .3s ease}
@keyframes ovIn{from{opacity:0}to{opacity:1}}
.ov-panel{background:var(--bg);border-radius:20px;width:94%;max-width:480px;max-height:88vh;overflow-y:auto;padding:20px;box-shadow:0 16px 64px rgba(0,0,0,.25);animation:panUp .35s ease}
@keyframes panUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
.ov-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.ov-title{font-family:'Fraunces',serif;font-size:18px;font-weight:700}
.ov-close{border:none;background:var(--card);width:36px;height:36px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 4px rgba(0,0,0,.1);color:var(--text)}
.ov-tabs{display:flex;background:var(--card);border-radius:12px;padding:3px;margin-bottom:14px}
.ov-tab{flex:1;border:none;background:transparent;padding:8px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;color:var(--text2);cursor:pointer;transition:all .3s;text-align:center}
.ov-tab.active{background:var(--accent);color:white}

/* Player sections */
.player-sec{margin-bottom:14px;border-radius:12px;padding:12px;border:1.5px solid var(--as)}
.player-sec.atk{background:rgba(220,38,38,.03);border-color:rgba(220,38,38,.15)}
.player-sec.mid{background:rgba(245,158,11,.03);border-color:rgba(245,158,11,.15)}
.player-sec.def{background:rgba(139,92,246,.03);border-color:rgba(139,92,246,.15)}
.player-hdr{display:flex;align-items:center;gap:6px;margin-bottom:8px}
.player-icon{font-size:16px}.player-name{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px}
.player-hdr.atk .player-name{color:#DC2626}.player-hdr.mid .player-name{color:#D97706}.player-hdr.def .player-name{color:#7C3AED}
.player-add-btn{margin-left:auto;border:none;background:var(--as);color:var(--accent);padding:3px 8px;border-radius:6px;font-size:9px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif}
.dc-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:4px}
.dc-chip{padding:6px 12px;border-radius:10px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;border:1.5px solid var(--as);background:var(--card);color:var(--text);display:flex;align-items:center;gap:5px}
.dc-chip:active{transform:scale(.95)}
.dc-chip-count{font-size:9px;background:var(--as);color:var(--accent);padding:0 6px;border-radius:6px;font-weight:700}
.dc-item{display:flex;align-items:center;gap:6px;background:var(--card);border-radius:8px;padding:8px 10px;margin-bottom:4px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
.dc-item-info{flex:1;min-width:0}.dc-item-n{font-size:11px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.dc-item-c{font-size:8px;color:var(--text2)}
.dc-pri-btns{display:flex;gap:2px;flex-shrink:0}
.dc-pri-btn{border:none;width:22px;height:22px;border-radius:5px;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;background:var(--as);color:var(--text2)}
.dc-pri-btn:hover{background:var(--accent);color:white}
.pitch-btn{border:none;padding:3px 8px;border-radius:5px;font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;cursor:pointer;flex-shrink:0;transition:all .2s}
.pitch-btn.on{background:#059669;color:white}.pitch-btn.off{background:var(--as);color:var(--accent)}
.bench-task{background:var(--card);border-radius:11px;padding:11px;margin-bottom:5px;box-shadow:0 1px 3px rgba(0,0,0,.05);display:flex;align-items:center;gap:8px;position:relative;overflow:hidden}
.bench-task.done{opacity:.5}.bench-pbar{width:3px;height:100%;position:absolute;left:0;top:0;border-radius:11px 0 0 11px}
.bench-cb{width:18px;height:18px;border-radius:5px;border:2px solid var(--accent);flex-shrink:0;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s}
.bench-cb.checked{background:var(--accent);border-color:var(--accent)}
.bench-cb.checked::after{content:'✓';color:white;font-size:10px;font-weight:700}
.bench-info{flex:1;min-width:0}.bench-title{font-size:12px;font-weight:500}.bench-meta{display:flex;gap:4px;flex-wrap:wrap;margin-top:2px}
.bench-tag{font-size:9px;font-weight:600;padding:1px 5px;border-radius:4px}

/* ==== CATEGORY DETAIL VIEW ==== */
.cat-detail{display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);align-items:center;justify-content:center}
.cat-detail.show{display:flex;animation:ovIn .3s ease}
.cat-panel{background:var(--bg);border-radius:20px;width:94%;max-width:480px;max-height:88vh;overflow-y:auto;padding:20px;box-shadow:0 16px 64px rgba(0,0,0,.25);animation:panUp .35s ease}
.cat-top{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.cat-back{border:none;background:var(--card);width:32px;height:32px;border-radius:50%;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 4px rgba(0,0,0,.1);color:var(--text);flex-shrink:0}
.cat-badge{font-size:8px;font-weight:700;padding:2px 8px;border-radius:6px;color:white}
.cat-badge.atk{background:#DC2626}.cat-badge.mid{background:#D97706}.cat-badge.def{background:#7C3AED}
.cat-name{font-family:'Fraunces',serif;font-size:18px;font-weight:700;flex:1}
.cat-stats{display:flex;gap:12px;margin-bottom:16px}
.cat-stat{background:var(--card);border-radius:10px;padding:10px 14px;flex:1;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,.05)}
.cat-stat-num{font-size:20px;font-weight:700;color:var(--accent)}.cat-stat-lbl{font-size:9px;color:var(--text2);margin-top:2px}
/* Add new task */
.cat-add{display:flex;gap:8px;margin-bottom:16px}
.cat-add-input{flex:1;border:1.5px solid var(--as);border-radius:10px;padding:10px 14px;font-family:'DM Sans',sans-serif;font-size:12px;background:var(--card);color:var(--text);outline:none}
.cat-add-input:focus{border-color:var(--accent)}
.cat-add-btn{border:none;background:var(--accent);color:white;padding:10px 16px;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer}
/* Search uncat */
.cat-search{width:100%;border:1.5px solid var(--as);border-radius:10px;padding:10px 14px;font-family:'DM Sans',sans-serif;font-size:12px;background:var(--card);color:var(--text);outline:none;margin-bottom:8px}
.cat-search:focus{border-color:var(--accent)}
.cat-search-item{display:flex;align-items:center;gap:8px;background:var(--card);border-radius:8px;padding:8px 10px;margin-bottom:4px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
.cat-search-name{flex:1;font-size:11px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cat-pull-btn{border:none;background:var(--accent);color:white;padding:3px 10px;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;cursor:pointer}

/* Regen popup */
.regen-ov{display:none;position:fixed;inset:0;z-index:700;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);align-items:center;justify-content:center}
.regen-ov.show{display:flex;animation:ovIn .3s ease}
.regen-panel{background:var(--bg);border-radius:18px;padding:20px;width:92%;max-width:360px;box-shadow:0 16px 64px rgba(0,0,0,.25);animation:panUp .35s ease}
.regen-head{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.regen-title{font-family:'Fraunces',serif;font-size:15px;font-weight:700}
.regen-sub{font-size:11px;color:var(--text2);margin-top:2px}
.regen-cat-info{font-size:10px;color:var(--text2);margin-bottom:12px;padding:6px 10px;background:var(--card);border-radius:8px}
.regen-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.regen-chip{padding:6px 12px;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;border:1.5px solid var(--as);background:var(--card);color:var(--text);transition:all .2s}
.regen-chip.active{background:var(--accent);color:white;border-color:var(--accent)}
.regen-custom{width:100%;border:1.5px solid var(--as);border-radius:10px;padding:10px 14px;font-family:'DM Sans',sans-serif;font-size:13px;background:var(--card);color:var(--text);outline:none;margin-bottom:12px;-moz-appearance:textfield}
.regen-custom:focus{border-color:var(--accent)}
.regen-custom::-webkit-inner-spin-button,.regen-custom::-webkit-outer-spin-button{-webkit-appearance:none}
.regen-btns{display:flex;gap:8px}
.regen-btn{flex:1;padding:10px;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.regen-btn.cancel{background:var(--as);color:var(--text2)}
.regen-btn.done{background:#059669;color:white}

/* New category modal */
.cat-modal-ov{display:none;position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.5);align-items:center;justify-content:center}
.cat-modal-ov.show{display:flex}
.cat-modal{background:var(--bg);border-radius:16px;padding:20px;width:90%;max-width:340px;box-shadow:0 8px 32px rgba(0,0,0,.2)}
.cat-modal h3{font-family:'Fraunces',serif;font-size:16px;margin-bottom:12px}
.cat-modal input,.cat-modal select{width:100%;border:1.5px solid var(--as);border-radius:9px;padding:8px 12px;font-family:'DM Sans',sans-serif;font-size:12px;background:var(--card);color:var(--text);outline:none;margin-bottom:8px}
.cat-modal-btns{display:flex;gap:8px;margin-top:6px}
.cat-modal-btns button{flex:1;padding:8px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;border:none}
.cat-modal-btns .save{background:var(--accent);color:white}.cat-modal-btns .cancel{background:var(--as);color:var(--text2)}

/* Lock/break/nudge */
.lock-ov{display:none;position:fixed;inset:0;z-index:9999;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center}
.lock-ov.show{display:flex;animation:lockIn .6s ease}
@keyframes lockIn{from{opacity:0}to{opacity:1}}
.lock-ov.mid-m{background:linear-gradient(145deg,#78350F,#92400E,#B45309)}
.lock-ov.mid-l{background:linear-gradient(145deg,#065F46,#047857,#059669)}
.lock-ov.def-e{background:linear-gradient(145deg,#3B0764,#5B21B6,#7C3AED)}
.lock-ov::before{content:'';position:absolute;top:8%;left:-15%;width:350px;height:350px;background:radial-gradient(circle,rgba(255,255,255,.06) 0%,transparent 70%);border-radius:50%}
.lock-icon{font-size:56px;margin-bottom:14px;animation:breathe 3s ease-in-out infinite;position:relative;z-index:1}
@keyframes breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.lock-title{font-family:'Fraunces',serif;font-size:26px;font-weight:700;color:white;margin-bottom:4px;position:relative;z-index:1}
.lock-sub{font-size:13px;color:rgba(255,255,255,.85);margin-bottom:22px;max-width:280px;line-height:1.5;position:relative;z-index:1}
.lock-tasks{display:flex;flex-direction:column;gap:7px;margin-bottom:20px;width:100%;max-width:340px;position:relative;z-index:1}
.lock-task{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.12);padding:12px 14px;border-radius:11px;color:white;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s}
.lock-task.checked{opacity:.6}.lock-task.checked .lt-text{text-decoration:line-through}
.lt-cb{width:20px;height:20px;border-radius:6px;border:2px solid rgba(255,255,255,.5);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .3s}
.lt-cb.checked{background:white;border-color:white}.lt-cb.checked::after{content:'✓';font-size:12px;font-weight:700}
.lock-ov.mid-m .lt-cb.checked::after{color:#B45309}.lock-ov.mid-l .lt-cb.checked::after{color:#059669}.lock-ov.def-e .lt-cb.checked::after{color:#7C3AED}
.lt-text{flex:1;text-align:left}.lt-icon{font-size:18px;flex-shrink:0}
.lock-timer{position:relative;z-index:1;margin-bottom:10px}
.lock-timer-text{font-size:34px;font-weight:700;color:white;font-family:'DM Sans',sans-serif}
.lock-timer-lbl{font-size:11px;color:rgba(255,255,255,.6);margin-top:2px}
.lock-btn{border:none;padding:11px 26px;border-radius:11px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .3s;position:relative;z-index:1}
.lock-btn.ready{background:white;color:#1a1a1a;box-shadow:0 4px 16px rgba(0,0,0,.2)}.lock-btn.waiting{background:rgba(255,255,255,.15);color:rgba(255,255,255,.4);cursor:not-allowed}
.lock-status{font-size:10px;color:rgba(255,255,255,.5);margin-top:6px;position:relative;z-index:1}
.skip-btn{margin-top:14px;background:none;border:1px solid rgba(255,255,255,.3);color:rgba(255,255,255,.6);padding:7px 18px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:11px;cursor:pointer;position:relative;z-index:1}
.break-ov{display:none;position:fixed;inset:0;z-index:9998;background:linear-gradient(145deg,#064E3B,#065F46,#047857);color:white;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center}
.break-ov.show{display:flex;animation:lockIn .6s ease}
.break-title{font-family:'Fraunces',serif;font-size:24px;font-weight:700;margin-bottom:4px;position:relative;z-index:1}
.break-sub{font-size:14px;opacity:.85;margin-bottom:24px;position:relative;z-index:1}
.break-tips{display:flex;flex-direction:column;gap:8px;margin-bottom:24px;position:relative;z-index:1}
.break-tip{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.12);padding:11px 16px;border-radius:11px;font-size:13px;font-weight:500;opacity:0;transform:translateX(-20px);animation:tipSlide .5s ease forwards}
.break-tip:nth-child(1){animation-delay:.3s}.break-tip:nth-child(2){animation-delay:.5s}.break-tip:nth-child(3){animation-delay:.7s}
@keyframes tipSlide{to{opacity:1;transform:translateX(0)}}
.break-ring{width:90px;height:90px;position:relative;z-index:1}
.break-ring svg{transform:rotate(-90deg);width:90px;height:90px}
.break-ring circle{fill:none;stroke-width:4}.br-bg{stroke:rgba(255,255,255,.2)}.br-fill{stroke:white;stroke-linecap:round;transition:stroke-dashoffset 1s linear}
.break-time{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700}
.nudge{display:none;position:fixed;top:0;left:0;right:0;z-index:300;padding:10px 16px}
.nudge.show{display:block;animation:slideD .4s ease}
@keyframes slideD{from{transform:translateY(-100%)}to{transform:translateY(0)}}
.nudge-inner{max-width:488px;margin:0 auto;background:linear-gradient(135deg,#F59E0B,#D97706);color:white;border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:8px;box-shadow:0 4px 16px rgba(245,158,11,.3)}
.nudge-icon{font-size:20px;flex-shrink:0}.nudge-text{flex:1;font-size:12px;font-weight:500}
.nudge-x{border:none;background:rgba(255,255,255,.25);color:white;padding:5px 10px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;cursor:pointer;flex-shrink:0}
.sec-hdr{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text2);margin-bottom:6px;display:flex;align-items:center;gap:4px}
/* Delete confirm popup */
.del-ov{display:none;position:fixed;inset:0;z-index:950;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);align-items:center;justify-content:center}
.del-ov.show{display:flex;animation:ovIn .3s ease}
.del-panel{background:var(--bg);border-radius:16px;padding:20px;width:88%;max-width:320px;box-shadow:0 16px 64px rgba(0,0,0,.25);animation:panUp .35s ease;text-align:center}
.del-icon{font-size:36px;margin-bottom:8px}
.del-title{font-family:'Fraunces',serif;font-size:15px;font-weight:700;margin-bottom:4px}
.del-name{font-size:13px;font-weight:600;color:var(--accent);margin-bottom:4px;word-break:break-word}
.del-warn{font-size:10px;color:#DC2626;margin-bottom:14px}
.del-btns{display:flex;gap:8px}
.del-btn{flex:1;padding:10px;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.del-btn.cancel{background:var(--as);color:var(--text2)}
.del-btn.confirm{background:#DC2626;color:white}
/* Link edit */
.link-edit{width:100%;margin-top:4px}
.link-inp{width:100%;border:1.5px solid var(--as);border-radius:8px;padding:6px 10px;font-family:'DM Sans',sans-serif;font-size:11px;background:var(--bg);color:var(--text);outline:none}
.link-inp:focus{border-color:var(--accent)}
.link-edit-btns{display:flex;gap:4px;margin-top:4px}
.link-save,.link-rm,.link-cancel{border:none;padding:3px 8px;border-radius:5px;font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;cursor:pointer}
.link-save{background:var(--accent);color:white}
.link-rm{background:#DC262622;color:#DC2626}
.link-cancel{background:var(--as);color:var(--text2)}

/* Rules panel */
.rule-card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.05);border:1.5px solid var(--as)}
.rule-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.rule-name{font-size:13px;font-weight:600;color:var(--text)}
.rule-status{font-size:10px;font-weight:600;padding:2px 8px;border-radius:8px}
.rule-status.on{background:#05966922;color:#059669}.rule-status.off{background:#DC262622;color:#DC2626}
.rule-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.rule-label{font-size:10px;font-weight:600;color:var(--text2)}
.rule-inputs{display:flex;align-items:center;gap:6px}
.rule-sel{border:1.5px solid var(--as);border-radius:6px;padding:4px 6px;font-size:10px;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);outline:none;cursor:pointer}
.rule-toggle{border:1.5px solid var(--as);border-radius:6px;padding:4px 10px;font-size:10px;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;background:var(--card);color:var(--text2);transition:all .2s}
.rule-toggle.on{background:#05966922;color:#059669;border-color:#05966944}
.rule-presets{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
.rule-preset{border:1px solid var(--as);border-radius:6px;padding:3px 8px;font-size:9px;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;background:transparent;color:var(--text2);transition:all .2s}
.rule-preset:hover{background:var(--as);color:var(--accent)}

/* ===== OFFICE UI ===== */
.ofc-blocker{position:fixed;inset:0;z-index:998;display:none;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center}
.ofc-blocker.show{display:flex}
.ofc-blocker.morning{background:linear-gradient(160deg,#1e3a5f 0%,#2a5298 40%,#3B5BDB 100%)}
.ofc-blocker.evening{background:linear-gradient(160deg,#1a1a2e 0%,#16213e 40%,#0f3460 100%)}
.ofc-bl-icon{font-size:56px;margin-bottom:16px;animation:ofcPulse 2s ease infinite}
@keyframes ofcPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
.ofc-bl-title{font-family:'Fraunces',serif;font-size:24px;font-weight:700;color:white;margin-bottom:6px}
.ofc-bl-sub{font-size:13px;color:rgba(255,255,255,.6);margin-bottom:32px;max-width:320px;line-height:1.5}
.ofc-bl-card{background:rgba(255,255,255,.1);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:16px 20px;margin-bottom:12px;width:100%;max-width:360px;display:flex;align-items:center;gap:14px;transition:all .3s}
.ofc-bl-card.done{background:rgba(5,150,105,.15);border-color:rgba(5,150,105,.3)}
.ofc-bl-card-ico{font-size:28px;flex-shrink:0}
.ofc-bl-card-info{flex:1;text-align:left}
.ofc-bl-card-name{font-size:14px;font-weight:600;color:white;margin-bottom:2px}
.ofc-bl-card-desc{font-size:10px;color:rgba(255,255,255,.5)}
.ofc-bl-btn{border:none;padding:8px 16px;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:700;cursor:pointer;flex-shrink:0;transition:all .2s}
.ofc-bl-btn.go{background:white;color:#3B5BDB}.ofc-bl-btn.go:active{transform:scale(.95)}
.ofc-bl-btn.confirm{background:#059669;color:white}.ofc-bl-btn.confirm:active{transform:scale(.95)}
.ofc-bl-btn.dim{background:rgba(255,255,255,.1);color:rgba(255,255,255,.3);border:1px solid rgba(255,255,255,.1)}
.ofc-bl-btn.ready{background:#059669!important;color:white!important;border-color:#059669!important}
.ofc-bl-actions{display:flex;gap:8px;width:100%;max-width:360px;margin-top:8px}
.ofc-bl-actions .ofc-bl-btn{flex:1;padding:10px;text-align:center;cursor:pointer}
.ofc-bl-hint{font-size:10px;color:rgba(255,255,255,.3);margin-top:24px}
.ofc-bl-hint.ok{color:rgba(5,150,105,.8)}
.ofc-bl-skip{border:none;background:none;color:rgba(255,255,255,.25);font-size:10px;font-family:'DM Sans',sans-serif;cursor:pointer;margin-top:12px;padding:6px 16px;border-radius:8px}
.ofc-bl-skip:hover{color:rgba(255,255,255,.5);background:rgba(255,255,255,.05)}

/* Office dashboard */
.ofc-dash{width:100%}
.ofc-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.ofc-hdr-title{font-family:'Fraunces',serif;font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px}
.ofc-badge{font-size:9px;font-weight:700;padding:3px 10px;border-radius:12px;background:var(--accent);color:white;letter-spacing:.5px}

/* Pending office banner (cross-location) */
.ofc-pending{background:#FEF2F2;border:1.5px solid rgba(220,38,38,.15);border-radius:14px;padding:12px;margin-bottom:14px;animation:ofcPendPulse 3s ease infinite}
@keyframes ofcPendPulse{0%,100%{box-shadow:0 0 0 0 rgba(220,38,38,0)}50%{box-shadow:0 0 0 4px rgba(220,38,38,.1)}}
.ofc-pend-hdr{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#DC2626;margin-bottom:8px}
.ofc-pend-task{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(220,38,38,.08)}
.ofc-pend-task:last-child{border-bottom:none}
.ofc-pend-ico{font-size:18px;flex-shrink:0}
.ofc-pend-info{flex:1}.ofc-pend-name{font-size:12px;font-weight:600}.ofc-pend-desc{font-size:9px;color:var(--text2)}
.ofc-pend-btn{border:none;padding:6px 10px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;cursor:pointer;flex-shrink:0}
.ofc-pend-btn.link{background:white;color:#3B5BDB;border:1px solid #E5EAFF}
.ofc-pend-btn.dn{background:#059669;color:white}

/* Freee banner */
.ofc-freee{background:linear-gradient(135deg,#FFFBEB,#FEF3C7);border:1.5px solid rgba(217,119,6,.15);border-radius:14px;padding:14px;margin-bottom:14px;position:relative;overflow:hidden}
.ofc-freee::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:#D97706}
.ofc-freee-hdr{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.ofc-freee-title{font-size:13px;font-weight:700}.ofc-freee-badge{font-size:8px;font-weight:700;padding:2px 7px;border-radius:5px;background:rgba(217,119,6,.15);color:#D97706}
.ofc-freee-desc{font-size:11px;color:var(--text2);line-height:1.5;margin-bottom:10px}
.ofc-freee-gen{background:white;border:1.5px dashed #E5EAFF;border-radius:10px;padding:20px;text-align:center;color:var(--text2);font-size:11px;margin-bottom:10px}
.ofc-freee-actions{display:flex;gap:6px}
.ofc-freee-btn{border:none;padding:8px 14px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer}
.ofc-freee-btn.pri{background:#D97706;color:white}.ofc-freee-btn.sec{background:rgba(217,119,6,.1);color:#D97706}

/* Apps dock */
.ofc-dock{margin-bottom:14px}
.ofc-dock-hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--card);border-radius:14px;cursor:pointer;border:1.5px solid var(--as);user-select:none}
.ofc-dock-hdr:active{background:var(--as)}
.ofc-dock-hdr.open{border-radius:14px 14px 0 0;border-bottom-color:transparent}
.ofc-dock-chev{font-size:10px;color:var(--text2);transition:transform .3s}
.ofc-dock-hdr.open .ofc-dock-chev{transform:rotate(180deg)}
.ofc-dock-body{background:var(--card);border:1.5px solid var(--as);border-top:none;border-radius:0 0 14px 14px;overflow:hidden;max-height:0;transition:max-height .3s ease,padding .2s}
.ofc-dock-body.open{max-height:200px;padding:10px}
.ofc-app-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.ofc-app-tile{background:var(--bg);border-radius:12px;padding:12px 6px;text-align:center;cursor:pointer;border:1.5px solid transparent;transition:all .15s}
.ofc-app-tile:active{transform:scale(.94)}
.ofc-app-ico{font-size:22px;display:block;margin-bottom:3px}
.ofc-app-nm{font-size:8px;font-weight:600;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Grouped quick links */
.ofc-ql{margin-bottom:14px}
.ofc-ql-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.ofc-ql-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text2)}
.ofc-ql-edit{border:none;background:var(--as);padding:3px 10px;border-radius:6px;font-size:9px;color:var(--accent);font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif}
.ofc-ql-row{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch}
.ofc-ql-row::-webkit-scrollbar{display:none}
.ofc-ql-grp{flex-shrink:0;position:relative}
.ofc-ql-btn{display:flex;align-items:center;gap:5px;background:var(--card);border:1.5px solid var(--as);border-radius:10px;padding:7px 12px;cursor:pointer;white-space:nowrap;transition:all .15s;font-size:10px;font-weight:600;color:var(--text)}
.ofc-ql-btn:active{transform:scale(.96)}
.ofc-ql-btn.open{border-color:var(--accent);background:var(--as);border-radius:10px 10px 0 0}
.ofc-ql-arr{font-size:8px;color:var(--text2);transition:transform .2s;margin-left:2px}
.ofc-ql-btn.open .ofc-ql-arr{transform:rotate(180deg)}
.ofc-ql-dd{display:none;position:absolute;top:100%;left:0;min-width:100%;background:var(--card);border:1.5px solid var(--accent);border-top:none;border-radius:0 0 10px 10px;box-shadow:0 8px 24px rgba(59,91,219,.12);z-index:50;overflow:hidden}
.ofc-ql-dd.show{display:block;animation:ofcSlideD .2s ease}
.ofc-ql-dd-item{display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;white-space:nowrap;font-size:10px;font-weight:500;color:var(--text)}
.ofc-ql-dd-item:hover{background:var(--as)}
.ofc-ql-dd-item:last-child{border-radius:0 0 8px 8px}

/* Quick links edit mode */
.ofc-ql-ep{background:var(--card);border:1.5px solid var(--as);border-radius:12px;padding:12px;margin-top:4px}
.ofc-ql-eg{margin-bottom:10px;border-bottom:1px solid #f0f0f0;padding-bottom:10px}
.ofc-ql-eg:last-child{border-bottom:none;padding-bottom:0;margin-bottom:0}
.ofc-ql-eg-hd{display:flex;align-items:center;gap:6px;margin-bottom:6px}
.ofc-ql-eg-nm{font-size:11px;font-weight:700;flex:1}
.ofc-ql-eg-del{border:none;background:none;font-size:10px;cursor:pointer;color:#DC2626;opacity:.4}
.ofc-ql-eg-row{display:flex;align-items:center;gap:4px;margin-bottom:4px;padding-left:12px}
.ofc-ql-eg-inp{flex:1;border:1px solid var(--as);border-radius:5px;padding:4px 6px;font-size:9px;font-family:'DM Sans',sans-serif;outline:none;background:var(--bg);color:var(--text)}
.ofc-ql-eg-ico{width:26px;border:1px solid var(--as);border-radius:5px;padding:4px 2px;font-size:9px;font-family:'DM Sans',sans-serif;outline:none;text-align:center;background:var(--bg)}
.ofc-ql-eg-xb{border:none;background:none;font-size:9px;cursor:pointer;color:#DC2626;opacity:.3}
.ofc-ql-addl{font-size:9px;color:var(--accent);cursor:pointer;padding-left:12px;font-weight:500}
.ofc-ql-addg{border:1.5px dashed var(--as);border-radius:8px;padding:7px;text-align:center;font-size:10px;color:var(--text2);cursor:pointer;margin-top:6px}

/* QL overlay (full screen window) */
.ofc-ql-overlay{position:fixed;inset:0;z-index:900;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;padding:16px}
.ofc-ql-overlay.show{display:flex;animation:ofcFadeIn .2s ease}
@keyframes ofcFadeIn{from{opacity:0}to{opacity:1}}
.ofc-ql-sheet{background:var(--card);border-radius:20px;width:100%;max-width:480px;max-height:80vh;overflow-y:auto;padding:20px 16px 24px;animation:alPopIn .3s ease;box-shadow:0 24px 64px rgba(0,0,0,.25)}
.ofc-ql-sheet-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.ofc-ql-sheet-title{font-family:'Fraunces',serif;font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px}
.ofc-ql-sheet-close{border:none;background:var(--as);width:30px;height:30px;border-radius:10px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;color:var(--text2)}
.ofc-ql-sheet-link{display:flex;align-items:center;gap:12px;padding:14px 12px;border-radius:12px;cursor:pointer;transition:all .15s;border:1.5px solid var(--as);margin-bottom:8px}
.ofc-ql-sheet-link:hover{background:var(--as)}.ofc-ql-sheet-link:active{background:var(--accent);color:white;border-color:var(--accent)}
.ofc-ql-sheet-link:active .ofc-ql-slink-url{color:rgba(255,255,255,.6)}
.ofc-ql-slink-ico{font-size:22px;flex-shrink:0;width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:var(--as);border-radius:10px}
.ofc-ql-slink-info{flex:1;min-width:0}
.ofc-ql-slink-nm{font-size:13px;font-weight:600}
.ofc-ql-slink-url{font-size:9px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:2px}
.ofc-ql-slink-go{font-size:14px;color:var(--accent);flex-shrink:0}

/* App add form */
.ofc-app-add{background:var(--card);border:1.5px solid var(--as);border-radius:14px;padding:14px;margin-top:8px;animation:ofcSlideD .2s ease}
.ofc-app-add-title{font-size:12px;font-weight:700;margin-bottom:10px}
.ofc-app-add-row{display:flex;gap:6px;margin-bottom:8px;align-items:center}
.ofc-app-add-ico{width:40px;border:1.5px solid var(--as);border-radius:8px;padding:6px 4px;font-size:12px;text-align:center;font-family:'DM Sans',sans-serif;outline:none;background:var(--bg)}
.ofc-app-add-inp{flex:1;border:1.5px solid var(--as);border-radius:8px;padding:7px 10px;font-family:'DM Sans',sans-serif;font-size:11px;background:var(--bg);color:var(--text);outline:none}
.ofc-app-add-inp:focus{border-color:var(--accent)}
.ofc-app-add-btns{display:flex;gap:6px}
.ofc-app-add-btn{border:none;padding:8px 14px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;cursor:pointer}
.ofc-app-add-btn.save{background:var(--accent);color:white}
.ofc-app-add-btn.cancel{background:var(--as);color:var(--text2)}

/* App tile edit badge */
.ofc-app-tile-wrap{position:relative}
.ofc-app-xbtn{position:absolute;top:-4px;right:-4px;width:16px;height:16px;border-radius:50%;background:#DC2626;color:white;font-size:8px;font-weight:700;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5;box-shadow:0 1px 4px rgba(0,0,0,.2)}

/* ===== UNIVERSAL QUICK TILES ===== */
.utiles{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.utile{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:10px;background:var(--card);border:1.5px solid var(--as);cursor:pointer;transition:all .15s;white-space:nowrap}
.utile:active{transform:scale(.95)}
.utile-ico{font-size:14px}
.utile-nm{font-size:10px;font-weight:600;color:var(--text)}

/* ===== APP LAUNCHER OVERLAY ===== */
.applaunch-btn{position:fixed;bottom:72px;right:16px;width:42px;height:42px;border-radius:50%;border:none;background:linear-gradient(135deg,#6366F1,#8B5CF6);color:white;font-size:18px;cursor:pointer;box-shadow:0 4px 16px rgba(99,102,241,.35);z-index:199;transition:all .3s;display:flex;align-items:center;justify-content:center}
.applaunch-btn:active{transform:scale(.9)}
.applaunch-ov{position:fixed;inset:0;z-index:800;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;padding:16px}
.applaunch-ov.show{display:flex;animation:ofcFadeIn .2s ease}
.applaunch-sheet{background:var(--card);border-radius:20px;width:100%;max-width:480px;max-height:80vh;overflow-y:auto;padding:20px 16px 24px;animation:alPopIn .3s ease;box-shadow:0 24px 64px rgba(0,0,0,.25)}
@keyframes alPopIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
.applaunch-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.applaunch-title{font-family:'Fraunces',serif;font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px}
.applaunch-close{border:none;background:var(--as);width:30px;height:30px;border-radius:10px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;color:var(--text2)}
.alcat{margin-bottom:14px}
.alcat-hd{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding-bottom:6px;border-bottom:1.5px solid var(--as)}
.alcat-ico{font-size:16px}.alcat-nm{font-size:13px;font-weight:700;flex:1}
.alcat-badge{font-size:8px;font-weight:700;padding:2px 7px;border-radius:5px;background:var(--as);color:var(--text2)}
.alcat-toggle{border:none;background:none;font-size:10px;cursor:pointer;color:var(--text2);transition:transform .2s;padding:4px}
.alcat-toggle.open{transform:rotate(180deg)}
.alcat-body{display:none;padding-left:4px}
.alcat-body.open{display:block;animation:ofcSlideD .2s ease}
/* Sub-categories */
.alsub{margin:8px 0 4px 4px}
.alsub-hd{display:flex;align-items:center;gap:6px;padding:6px 0;cursor:pointer;border-bottom:1px solid var(--as);margin-bottom:6px}
.alsub-ico{font-size:14px}
.alsub-nm{font-size:11px;font-weight:600;flex:1;color:var(--text)}
.alsub-arr{font-size:8px;color:var(--text2);transition:transform .2s}
.alsub-arr.open{transform:rotate(180deg)}
.alsub-body{display:none;padding-left:8px}
.alsub-body.open{display:block}
/* App link item */
.alapp{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:10px;cursor:pointer;transition:all .15s;border:1.5px solid var(--as);margin-bottom:6px}
.alapp:hover{background:var(--as)}.alapp:active{background:var(--accent);color:white;border-color:var(--accent)}
.alapp:active .alapp-url{color:rgba(255,255,255,.6)}
.alapp-ico{font-size:18px;flex-shrink:0;width:34px;height:34px;display:flex;align-items:center;justify-content:center;background:var(--as);border-radius:9px}
.alapp-info{flex:1;min-width:0}
.alapp-nm{font-size:12px;font-weight:600}
.alapp-url{font-size:8px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:1px}
.alapp-go{font-size:12px;color:var(--accent);flex-shrink:0}
.alapp-loc{font-size:7px;font-weight:700;padding:1px 5px;border-radius:3px;flex-shrink:0}
.alapp-loc.all{background:#E5EAFF;color:#3B5BDB}.alapp-loc.office{background:#E5EAFF;color:#3B5BDB}.alapp-loc.home{background:#FFF0E5;color:#E8722A}

/* App launcher edit mode */
.al-edit-btn{border:none;background:var(--as);padding:3px 10px;border-radius:6px;font-size:9px;color:var(--accent);font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;margin-left:8px}
.al-edit-row{display:flex;gap:4px;align-items:center;margin-bottom:6px;padding:6px 8px;background:var(--bg);border-radius:8px;border:1px solid var(--as)}
.al-edit-ico{width:28px;border:1px solid var(--as);border-radius:6px;padding:4px 2px;font-size:11px;text-align:center;font-family:'DM Sans',sans-serif;outline:none;background:white}
.al-edit-inp{flex:1;border:1px solid var(--as);border-radius:6px;padding:5px 8px;font-size:10px;font-family:'DM Sans',sans-serif;outline:none;background:white;color:var(--text);min-width:0}
.al-edit-inp:focus{border-color:var(--accent)}
.al-edit-inp.url{font-size:9px;color:var(--text2)}
.al-edit-del{border:none;background:none;font-size:10px;cursor:pointer;color:#DC2626;opacity:.4;flex-shrink:0;padding:2px}
.al-edit-del:hover{opacity:1}
.al-cat-edit{display:flex;gap:4px;align-items:center;margin-bottom:6px}
.al-add-btn{border:1.5px dashed var(--as);border-radius:8px;padding:7px;text-align:center;font-size:9px;color:var(--text2);cursor:pointer;margin-top:4px;margin-bottom:4px}
.al-add-btn:hover{background:var(--as);color:var(--accent)}

/* Critical surface */
.ofc-crit{margin-bottom:14px}
.ofc-crit-hd{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:#DC2626;margin-bottom:8px}
.ofc-crit-card{background:#FEF2F2;border:1.5px solid rgba(220,38,38,.1);border-radius:12px;padding:10px 12px;margin-bottom:6px;display:flex;align-items:center;gap:10px;position:relative;overflow:hidden}
.ofc-crit-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px}
.ofc-crit-card.s-mgr::before{background:#DC2626}.ofc-crit-card.s-me::before{background:#D97706}.ofc-crit-card.s-ppl::before{background:#5C7CFA}
.ofc-crit-pri{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.ofc-crit-info{flex:1;min-width:0}
.ofc-crit-name{font-size:12px;font-weight:600;line-height:1.3}
.ofc-crit-meta{font-size:9px;color:var(--text2);margin-top:1px}
.ofc-crit-src{font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px}
.ofc-crit-src.mgr{background:rgba(220,38,38,.1);color:#DC2626}.ofc-crit-src.me{background:rgba(217,119,6,.1);color:#D97706}.ofc-crit-src.ppl{background:rgba(92,124,250,.1);color:#5C7CFA}
.ofc-crit-dn{width:26px;height:26px;border-radius:7px;border:1.5px solid rgba(220,38,38,.15);background:white;display:flex;align-items:center;justify-content:center;font-size:11px;cursor:pointer;flex-shrink:0;color:var(--text2)}

/* Square box cards */
.ofc-box-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px}
.ofc-box{background:var(--card);border-radius:16px;border:1.5px solid var(--as);padding:14px;text-align:center;cursor:pointer;transition:all .2s;position:relative}
.ofc-box:active{transform:scale(.96)}
.ofc-box.active{border-color:var(--accent);box-shadow:0 4px 20px rgba(59,91,219,.12)}
.ofc-box-ico{font-size:28px;margin-bottom:6px;display:block}
.ofc-box-cnt{font-size:20px;font-weight:700;color:var(--accent);font-family:'Fraunces',serif}
.ofc-box-nm{font-size:11px;font-weight:700;margin-top:2px}
.ofc-box-badges{position:absolute;top:8px;right:8px;display:flex;gap:2px}
.ofc-box-bdot{width:8px;height:8px;border-radius:50%}

/* Expanded panel */
.ofc-panel{background:var(--card);border:1.5px solid var(--as);border-radius:16px;padding:14px;margin-bottom:14px;animation:ofcSlideD .25s ease}
.ofc-panel-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.ofc-panel-title{font-size:14px;font-weight:700;display:flex;align-items:center;gap:6px}
.ofc-panel-close{border:none;background:var(--as);width:24px;height:24px;border-radius:6px;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;color:var(--text2)}
.ofc-box-add{display:flex;gap:6px;margin-bottom:10px}
.ofc-box-inp{flex:1;border:1.5px solid var(--as);border-radius:8px;padding:8px 10px;font-family:'DM Sans',sans-serif;font-size:11px;background:var(--bg);color:var(--text);outline:none}
.ofc-box-sub{border:none;padding:8px 12px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:10px;font-weight:600;cursor:pointer;color:white}
.ofc-pri-grp{margin-bottom:6px}
.ofc-pri-hd{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px;display:flex;align-items:center;gap:4px}
.ofc-pri-dot{width:6px;height:6px;border-radius:50%;display:inline-block}
.ofc-titem{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid #f5f5f5}
.ofc-titem:last-child{border-bottom:none}
.ofc-titem.cooldown{opacity:.35;filter:blur(.4px)}
.ofc-titem-cb{width:18px;height:18px;border-radius:5px;border:2px solid var(--as);flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center}
.ofc-titem-cb.done{background:#059669;border-color:#059669}
.ofc-titem-cb.done::after{content:'✓';color:white;font-size:9px;font-weight:700}
.ofc-titem-info{flex:1;min-width:0}
.ofc-titem-nm{font-size:11px;font-weight:500}
.ofc-titem-meta{font-size:8px;color:var(--text2);margin-top:1px}
.ofc-titem-pri{font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px;flex-shrink:0}
.ofc-titem-del{border:none;background:none;font-size:10px;cursor:pointer;padding:2px;opacity:.25;flex-shrink:0}
.ofc-from{font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px}
.ofc-from.mgr{background:rgba(220,38,38,.08);color:#DC2626}.ofc-from.ppl{background:rgba(92,124,250,.08);color:#5C7CFA}
.ofc-empty{text-align:center;padding:16px;font-size:11px;color:var(--text2);opacity:.5}

/* Office task inline edit */
.ofc-titem-edit{background:var(--bg);border-radius:8px;padding:8px;margin-bottom:6px;animation:ofcSlideD .15s ease}
.ofc-titem-edit-row{display:flex;gap:4px;margin-bottom:4px}
.ofc-titem-edit-inp{flex:1;border:1.5px solid var(--as);border-radius:6px;padding:6px 8px;font-family:'DM Sans',sans-serif;font-size:10px;background:white;color:var(--text);outline:none}
.ofc-titem-edit-inp:focus{border-color:var(--accent)}
.ofc-titem-edit-sel{border:1.5px solid var(--as);border-radius:6px;padding:5px 6px;font-size:9px;font-family:'DM Sans',sans-serif;background:white;color:var(--text);outline:none;cursor:pointer}
.ofc-titem-edit-btns{display:flex;gap:4px}
.ofc-titem-edit-btn{border:none;padding:5px 10px;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:9px;font-weight:600;cursor:pointer}
.ofc-titem-edit-btn.save{background:var(--accent);color:white}
.ofc-titem-edit-btn.del{background:#FEF2F2;color:#DC2626}
.ofc-titem-edit-btn.cancel{background:var(--as);color:var(--text2)}
@keyframes ofcSlideD{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

@keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<div class="app">
  <div class="loading" id="loadingView"><div class="loading-spinner"></div><div class="loading-text">Loading from Supabase...</div></div>
  <div class="pitch" id="pitch" style="display:none">
    <div class="pitch-top"><div class="pitch-name">ContextFlow</div><div class="pitch-r"><span class="day-badge" id="dayB"></span><button class="hol-btn" id="holB" onclick="toggleHol()">🎌</button><div class="pitch-time" id="timeD"></div></div></div>
    <div class="loc-bar"><div class="loc-g" id="locG"><button class="loc-b active" data-l="home" onclick="setLoc('home')">🏠 Home</button><button class="loc-b" data-l="office" onclick="setLoc('office')">🏢 Office</button><button class="loc-b" data-l="outside" onclick="setLoc('outside')">🌳 Outside</button></div></div>
    <div id="possStrip"></div><div class="pitch-field" id="pitchField"></div>
  </div>
</div>
<button class="corner-btn" id="cornerBtn" onclick="openOv()" style="display:none">☰</button>

<!-- CENTERED OVERLAY -->
<div class="ov-bg" id="ovBg" onclick="if(event.target===this)closeOv()">
  <div class="ov-panel"><div class="ov-top"><div class="ov-title">Locker Room</div><div class="ov-close" onclick="closeOv()">✕</div></div>
    <div class="ov-tabs"><button class="ov-tab active" id="ovTabB" onclick="switchOvTab('bench')">📋 Bench</button><button class="ov-tab" id="ovTabD" onclick="switchOvTab('dc')">🎯 DC</button><button class="ov-tab" id="ovTabR" onclick="switchOvTab('rules')">⚙️ Rules</button></div>
    <div id="ovContent"></div>
  </div>
</div>

<!-- CATEGORY DETAIL -->
<div class="cat-detail" id="catDetail" onclick="if(event.target===this)closeCatDetail()">
  <div class="cat-panel" id="catPanel"></div>
</div>

<!-- MODALS -->
<div class="cat-modal-ov" id="catModal"><div class="cat-modal"><h3 id="catModalTitle">New Category</h3><input id="catModalInput" placeholder="Category name..."><select id="catModalPlayer"><option value="attacker">⚔️ Attacker</option><option value="midfielder">🍱 Midfielder</option><option value="defender">🪞 Defender</option></select><div class="cat-modal-btns"><button class="cancel" onclick="closeCatModal()">Cancel</button><button class="save" onclick="saveCatModal()">Save</button></div></div></div>

<!-- REGEN POPUP -->
<div class="regen-ov" id="regenPopup">
  <div class="regen-panel">
    <div class="regen-head">
      <span style="font-size:20px">✅</span>
      <div><div class="regen-title" id="regenTaskName">Task</div><div class="regen-sub">Regenerate after how many days?</div></div>
    </div>
    <div class="regen-cat-info">Category default: <strong id="regenCatDefault">not set</strong></div>
    <div class="regen-chips">
      <div class="regen-chip" data-d="1" onclick="selectRegenPreset(1)">Daily</div>
      <div class="regen-chip" data-d="3" onclick="selectRegenPreset(3)">3 days</div>
      <div class="regen-chip" data-d="7" onclick="selectRegenPreset(7)">Weekly</div>
      <div class="regen-chip" data-d="14" onclick="selectRegenPreset(14)">2 weeks</div>
      <div class="regen-chip" data-d="30" onclick="selectRegenPreset(30)">Monthly</div>
    </div>
    <input class="regen-custom" id="regenCustom" type="number" min="1" placeholder="Custom days..." oninput="document.querySelectorAll('.regen-chip').forEach(c=>c.classList.remove('active'))">
    <div class="regen-btns">
      <button class="regen-btn cancel" onclick="closeRegenPopup()">Cancel</button>
      <button class="regen-btn done" onclick="confirmRegen()">✓ Mark Done</button>
    </div>
  </div>
</div>

<!-- DELETE CONFIRM -->
<div class="del-ov" id="delPopup">
  <div class="del-panel">
    <div class="del-icon">🗑️</div>
    <div class="del-title">Delete task?</div>
    <div class="del-name" id="delTaskName"></div>
    <div class="del-warn">This is permanent and cannot be undone.</div>
    <div class="del-btns">
      <button class="del-btn cancel" onclick="cancelDelete()">Cancel</button>
      <button class="del-btn confirm" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- LOCKS -->
<div class="lock-ov mid-m" id="lockM"><div class="lock-icon">☕</div><div class="lock-title">Morning Kickoff</div><div class="lock-sub">Midfield has the ball.</div><div class="lock-tasks" id="lockMT"></div><button class="lock-btn waiting" id="lockMB" onclick="unlockM()">⚔️ Pass to Attackers</button><div class="lock-status" id="lockMS">Check at least one</div><button class="skip-btn" onclick="skipLock('morning')">Skip</button></div>
<div class="lock-ov mid-l" id="lockL"><div class="lock-icon">🍱</div><div class="lock-title">Lunch Break</div><div class="lock-sub">Midfield intervenes.</div><div class="lock-tasks" id="lockLT"></div><div class="lock-timer"><div class="lock-timer-text" id="lunchT">60:00</div><div class="lock-timer-lbl">minimum break</div></div><button class="lock-btn waiting" id="lockLB" onclick="unlockL()">⚔️ Pass back</button><div class="lock-status" id="lockLS">Check one + wait</div><button class="skip-btn" onclick="skipLock('lunch')">Skip</button></div>
<div class="lock-ov def-e" id="lockD"><div class="lock-icon">🪞</div><div class="lock-title">Defenders' Time</div><div class="lock-sub">Self-care mode.</div><div class="lock-tasks" id="lockDT"></div><div class="lock-timer"><div class="lock-timer-text" id="defT">30:00</div><div class="lock-timer-lbl">minimum self-care</div></div><button class="lock-btn waiting" id="lockDB" onclick="unlockD()">✅ Done</button><div class="lock-status" id="lockDS">Check one + wait</div><button class="skip-btn" onclick="skipLock('defender')">Skip</button></div>
<div class="break-ov" id="breakOv"><div class="lock-icon" id="breakIcon">🌿</div><div class="break-title">5-Minute Break</div><div class="break-sub">Rest before next session</div><div class="break-tips" id="breakTips"></div><div class="break-ring"><svg viewBox="0 0 100 100"><circle class="br-bg" cx="50" cy="50" r="44"/><circle class="br-fill" id="bRing" cx="50" cy="50" r="44" stroke-dasharray="276.46" stroke-dashoffset="0"/></svg><div class="break-time" id="bTime">5:00</div></div><button class="skip-btn" onclick="skipBreak()">Skip</button></div>
<div class="nudge" id="nudge"><div class="nudge-inner"><span class="nudge-icon">💧</span><span class="nudge-text" id="nudgeT">Drink water!</span><button class="nudge-x" onclick="dismissNudge()">Got it</button></div></div>

<!-- QUICK LINKS OVERLAY -->
<div class="ofc-ql-overlay" id="ofcQLOverlay" onclick="if(event.target===this)ofcCloseQLOverlay()">
  <div class="ofc-ql-sheet" id="ofcQLSheet"></div>
</div>

<!-- APP LAUNCHER OVERLAY -->
<div class="applaunch-ov" id="appLaunchOv" onclick="if(event.target===this)closeAppLaunch()">
  <div class="applaunch-sheet" id="appLaunchSheet"></div>
</div>
<button class="applaunch-btn" id="appLaunchBtn" onclick="openAppLaunch()" style="display:none" title="My Apps">📚</button>

<!-- OFFICE BLOCKERS -->
<div class="ofc-blocker morning" id="ofcMorning">
  <div class="ofc-bl-icon">🌅</div><div class="ofc-bl-title">Good Morning!</div>
  <div class="ofc-bl-sub">Complete your daily check-in to unlock the app.</div>
  <div class="ofc-bl-card"><div class="ofc-bl-card-ico">🔐</div><div class="ofc-bl-card-info"><div class="ofc-bl-card-name">Daily Check-in Entry</div><div class="ofc-bl-card-desc">Open login site and mark attendance</div></div><button class="ofc-bl-btn go" onclick="window.open(ofcLinks.checkin||'#','_blank')">Open ↗</button></div>
  <div class="ofc-bl-card"><div class="ofc-bl-card-ico">✅</div><div class="ofc-bl-card-info"><div class="ofc-bl-card-name">Confirm check-in</div><div class="ofc-bl-card-desc">I've completed my check-in entry</div></div><button class="ofc-bl-btn confirm" onclick="ofcDoCheckin()">Check In ✓</button></div>
  <div class="ofc-bl-hint">⚠️ App locked until check-in</div>
</div>
<div class="ofc-blocker evening" id="ofcEvening">
  <div class="ofc-bl-icon">🌙</div><div class="ofc-bl-title">Before You Leave</div>
  <div class="ofc-bl-sub">Complete both tasks. Reappears every 15 min until done.</div>
  <div class="ofc-bl-card" id="ofcBlCO"><div class="ofc-bl-card-ico">🔐</div><div class="ofc-bl-card-info"><div class="ofc-bl-card-name">Daily Check-out Entry</div><div class="ofc-bl-card-desc">Open login and mark departure</div></div><button class="ofc-bl-btn go" onclick="window.open(ofcLinks.checkin||'#','_blank')">Open ↗</button></div>
  <div class="ofc-bl-card" id="ofcBlTS"><div class="ofc-bl-card-ico">📋</div><div class="ofc-bl-card-info"><div class="ofc-bl-card-name">Daily Timesheet Entry</div><div class="ofc-bl-card-desc">Log today's hours</div></div><button class="ofc-bl-btn go" onclick="window.open(ofcLinks.timesheet||'#','_blank')">Open ↗</button></div>
  <div class="ofc-bl-actions"><button class="ofc-bl-btn dim" id="ofcEvBtn0" onclick="ofcEvMark(0)">✓ Checkout done</button><button class="ofc-bl-btn dim" id="ofcEvBtn1" onclick="ofcEvMark(1)">✓ Timesheet done</button></div>
  <div class="ofc-bl-hint" id="ofcEvHint">⚠️ Complete both to stop reminders</div>
  <button class="ofc-bl-skip" onclick="ofcEvSkip()">Still working — remind me in 15 min</button>
</div>

<script>
const sb=window.supabase.createClient('https://wylxvmkcrexwfpjpbhyy.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5bHh2bWtjcmV4d2ZwanBiaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzkxMDYsImV4cCI6MjA4NDIxNTEwNn0.6Bxo42hx4jwlJGWnfjiTpiDUsYfc1QLTN3YtrU1efak');

let allTags=[],tagMap={},allTasks=[],taskTags={},pitchSet=new Set(),playerMap={};
let loc='home',mood='Energetic',ovTab='bench',manHol=false,possession='mid_morning';
let lunchRem=3600,defRem=1800,lunchInt=null,defInt=null;
let morningCk=new Set(),lunchCk=new Set(),defCk=new Set();
let lastNudge=0,nudgeInt=null;
let studyTimerActive=false,studyTimerRem=0,studyTimerTotal=0,studyTimerInt=null,currentStudyId=null;
let breakRem=300,breakInt=null;
let catDetailSearch='',catDetailName='';
let pitchRotation='free';
let expandedDot='';
let lastDoneAtkCat=''; // individual attacker category that stays blurred after unlock
let regenDefaults={}; // categoryName → days (default regen for all tasks in category)
let regenTasks={}; // taskId → {days, done_at} (per-task override + last done timestamp)
let pendingDoneId=null; // task awaiting regen popup confirmation
let timeSlotRules={}; // categoryName → {weekday_from:20, weekday_to:24, weekend:true, holiday:true}

// ===== OFFICE STATE =====
let ofcCheckedIn=false, ofcCheckoutDone=false, ofcTimesheetDone=false, ofcFreeeDone=false;
let ofcDockOpen=false, ofcQLEdit=false, ofcOpenBox='', ofcOpenQL='', ofcAppEdit=false;
let ofcEvDismissedAt=null, ofcEvMarks=[false,false];
const ofcLinks={checkin:'',freee:'https://freee.co.jp',timesheet:''};
let ofcQLGroups=[
  {id:'login',ico:'🔐',name:'Check-in / Timesheet',items:[
    {ico:'🔐',name:'Check-in Login',url:''},
    {ico:'💴',name:'Freee (Transport)',url:'https://freee.co.jp'},
    {ico:'📋',name:'Timesheet Entry',url:''},
  ]},
  {id:'sops',ico:'📄',name:'SOPs',workHours:true,items:[
    {ico:'🦾',name:'Head SOP',url:''},{ico:'💪',name:'Arm SOP',url:''},{ico:'🤖',name:'Gripper SOP',url:''},
  ]},
  {id:'ecn',ico:'📁',name:'ECN Folder',workHours:true,items:[
    {ico:'📋',name:'ECN 101',url:''},{ico:'📋',name:'ECN 100',url:''},
  ]},
  {id:'misc',ico:'📧',name:'Outlook',items:[
    {ico:'📧',name:'Outlook Web',url:'https://outlook.office.com'},
  ]},
];
let ofcApps=[
  {ico:'📊',name:'Eagle Eye',url:''},{ico:'🗾',name:'JP Grammar',url:''},
  {ico:'📝',name:'JLPT N1',url:''},{ico:'🍳',name:'Cooking',url:''},
  {ico:'💰',name:'Commute Calc',url:''},{ico:'⚽',name:'ContextFlow',url:''},
];
// Demo office tasks (will connect to Supabase later)
let ofcMgrTasks=[
  {id:'om1',name:'Review Q4 budget proposal',pri:'critical',from:'Manager-san',due:'Today',done:false,doneAt:null},
  {id:'om2',name:'Prepare slides for Wed standup',pri:'high',from:'Manager-san',due:'Wed',done:false,doneAt:null},
  {id:'om3',name:'Send commuting expense report',pri:'medium',from:'Manager-san',due:'Fri',done:false,doneAt:null},
  {id:'om4',name:'Update project timeline',pri:'low',from:'Manager-san',due:'Next week',done:false,doneAt:null},
];
let ofcReminders=[
  {id:'or1',name:'Take medicine after lunch',pri:'critical',time:'12:30 PM',done:false,doneAt:null},
  {id:'or2',name:'Submit timesheet before 6',pri:'high',time:'5:30 PM',done:false,doneAt:null},
  {id:'or3',name:'Buy Suica card reload',pri:'medium',time:'After work',done:false,doneAt:null},
];
let ofcPplTasks=[
  {id:'op1',name:'Check Tofes 17 form for errors',pri:'critical',from:'Yamada-san',role:'Team lead',done:false,doneAt:null},
  {id:'op2',name:'Review pull request #247',pri:'high',from:'Suzuki-san',role:'Dev',done:false,doneAt:null},
  {id:'op3',name:'Share meeting notes from Fri',pri:'medium',from:'Tanaka-san',role:'PM',done:false,doneAt:null},
];
const OFC_PRI={critical:{l:'Critical',c:'#DC2626',bg:'#FEF2F2'},high:{l:'High',c:'#E8722A',bg:'#FFF7ED'},medium:{l:'Medium',c:'#D97706',bg:'#FFFBEB'},low:{l:'Low',c:'#6B7280',bg:'#F9FAFB'}};
const OFC_PRI_ORD=['critical','high','medium','low'];
const OFC_BOX={mgr:{ico:'📨',name:'From Manager',color:'#DC2626'},rem:{ico:'⏰',name:'My Reminders',color:'#D97706'},ppl:{ico:'👥',name:'From People',color:'#5C7CFA'}};

// ===== APP DATABASE =====
// Universal quick tiles (shown on ALL screens)
let uniTiles=[
  {id:'cal',ico:'📅',name:'Calendar',url:'https://celeritas7.github.io/Calender_app/',locs:['home','office','outside']},
  {id:'cost',ico:'💰',name:'Cost Management',url:'https://celeritas7.github.io/Cost_management/',locs:['home','office','outside']},
];
// App database — categorized, with sub-categories for Language Study
let appDB=[
  {id:'general',ico:'🔧',name:'General Purpose',apps:[
    {id:'a_cal',ico:'📅',name:'Calendar',url:'https://celeritas7.github.io/Calender_app/',locs:['home','office','outside']},
    {id:'a_cost',ico:'💰',name:'Cost Management',url:'https://celeritas7.github.io/Cost_management/',locs:['home','office','outside']},
  ]},
  {id:'lang',ico:'🌏',name:'Language Study',subs:[
    {id:'lang_jp',ico:'🇯🇵',name:'Japanese',apps:[
      {id:'a_jpgram',ico:'🗾',name:'JP Grammar',url:''},
      {id:'a_jlpt',ico:'📝',name:'JLPT N1',url:''},
    ]},
    {id:'lang_cn',ico:'🇨🇳',name:'Chinese',apps:[
      {id:'a_cngram',ico:'🈶',name:'CN Grammar',url:''},
    ]},
    {id:'lang_mm',ico:'🇲🇲',name:'Burmese',apps:[
      {id:'a_mmscript',ico:'✍️',name:'Burmese Script',url:''},
    ]},
  ]},
  {id:'coding',ico:'💻',name:'Coding',apps:[
    {id:'a_codecmp',ico:'🔀',name:'Code Comparison',url:''},
  ]},
];
// Track which categories/subs are expanded in launcher
let alOpen={};// id → boolean

const LOC_MAP={home:['Room','Share house'],office:['Company'],outside:['Train','Park','Cafe','Anywhere']};
const STUDY_CATS=['Paper study','Quick study','Reading'];
const DEV_CATS=['Coding','App generation'];
const PLAYER_INFO={attacker:{icon:'⚔️',name:'Attackers',cl:'atk'},midfielder:{icon:'🍱',name:'Midfield',cl:'mid'},defender:{icon:'🪞',name:'Defenders',cl:'def'}};
const PRI_ORDER=['critical','high','medium','low','someday'];
const PITCH_LIMIT=3;

// Helpers
function todayK(){const d=new Date();return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function isWknd(){const d=new Date().getDay();return d===0||d===6}
const JP_HOL={'2025-01-01':1,'2025-01-13':1,'2025-02-11':1,'2025-02-23':1,'2025-02-24':1,'2025-03-20':1,'2025-04-29':1,'2025-05-03':1,'2025-05-04':1,'2025-05-05':1,'2025-05-06':1,'2025-07-21':1,'2025-08-11':1,'2025-09-15':1,'2025-09-23':1,'2025-10-13':1,'2025-11-03':1,'2025-11-23':1,'2025-11-24':1,'2026-01-01':1,'2026-01-12':1,'2026-02-11':1,'2026-02-23':1,'2026-03-20':1,'2026-04-29':1,'2026-05-03':1,'2026-05-04':1,'2026-05-05':1,'2026-05-06':1,'2026-07-20':1,'2026-08-11':1,'2026-09-21':1,'2026-09-23':1,'2026-10-12':1,'2026-11-03':1,'2026-11-23':1};
function dayType(){if(manHol)return'holiday';if(JP_HOL[todayK()])return'holiday';if(isWknd())return'weekend';return'weekday'}
function isOff(){return dayType()!=='weekday'}
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}

// Tag helpers
function tTagNames(id,type){return(taskTags[id]||[]).map(i=>tagMap[i]).filter(Boolean).filter(t=>t.type===type).map(t=>t.name)}
function tPriority(t){const p=tTagNames(t.id,'priority');if(p.includes('Critical'))return'critical';if(p.includes('High'))return'high';if(p.includes('Low'))return'low';if(p.includes('Someday'))return'someday';return'medium'}
function tCategory(t){return tTagNames(t.id,'category')[0]||''}
function tDuration(t){const d=tTagNames(t.id,'duration');if(d.includes('5min'))return 5;if(d.includes('15min'))return 15;if(d.includes('30min'))return 30;if(d.includes('1hour'))return 60;if(d.includes('2hours+'))return 120;return t.estimated_minutes||25}
function tInLoc(t,lk){const locs=tTagNames(t.id,'location');if(!locs.length)return false;const names=LOC_MAP[lk]||[];return locs.some(l=>names.includes(l))||locs.includes('Anywhere')}
function hasCategory(t){return tCategory(t)!==''}
function isStudy(t){return STUDY_CATS.includes(tCategory(t))}
function isDev(t){return DEV_CATS.includes(tCategory(t))}
function priColor(p){return{critical:'#c0392b',high:'#e74c3c',medium:'#f39c12',low:'#95a5a6',someday:'#bdc3c7'}[p]||'#f39c12'}
function locTasks(){return allTasks.filter(t=>t.status!=='done'&&tInLoc(t,loc))}
function pitched(){return allTasks.filter(t=>pitchSet.has(t.id)&&t.status!=='done')}
function catPlayer(c){return playerMap[c]||''}
function taskPlayer(t){return catPlayer(tCategory(t))}
function pitchCountForCat(cat){return[...pitchSet].filter(id=>{const t=allTasks.find(x=>x.id===id);return t&&t.status!=='done'&&tCategory(t)===cat}).length}
function canPitch(t){if(isInCooldown(t))return false;const cat=tCategory(t);if(!cat)return pitchSet.size<10;return pitchCountForCat(cat)<PITCH_LIMIT}

// Regen helpers
function getRegenDays(t){const r=regenTasks[t.id];if(r&&r.days!=null)return r.days;const cat=tCategory(t);return regenDefaults[cat]!=null?regenDefaults[cat]:null}
function isInCooldown(t){if(t.status!=='done')return false;const r=regenTasks[t.id];if(!r||!r.done_at)return false;const days=getRegenDays(t);if(days==null)return false;const doneDate=new Date(r.done_at);const now=new Date();const diff=Math.floor((now-doneDate)/(1000*60*60*24));return diff<days}
function cooldownDaysLeft(t){const r=regenTasks[t.id];if(!r||!r.done_at)return 0;const days=getRegenDays(t);if(days==null)return 0;const doneDate=new Date(r.done_at);const now=new Date();const diff=Math.floor((now-doneDate)/(1000*60*60*24));return Math.max(0,days-diff)}
function isActive(t){return t.status!=='done'||(t.status==='done'&&isInCooldown(t))}
async function checkAndReactivate(){
  let changed=false;
  for(const t of allTasks){
    if(t.status!=='done')continue;const r=regenTasks[t.id];if(!r||!r.done_at)continue;
    const days=getRegenDays(t);if(days==null)continue;
    const doneDate=new Date(r.done_at);const now=new Date();const diff=Math.floor((now-doneDate)/(1000*60*60*24));
    if(diff>=days){await markActive(t.id);await changePriority(t.id,'critical');changed=true;console.log('♻️ Reactivated:',t.name)}
  }
  if(changed)renderAll();
}
// Time slot check — only applies to attackers
function isCatAllowedNow(cat){
  const pl=catPlayer(cat);if(pl!=='attacker')return true; // mid/def always allowed
  const rule=timeSlotRules[cat];if(!rule)return true; // no rule = always allowed
  const dt=dayType();const hr=new Date().getHours();
  if(dt==='weekend'||dt==='holiday')return rule.weekend!==false; // default true
  // Weekday check
  const from=rule.weekday_from!=null?rule.weekday_from:0;
  const to=rule.weekday_to!=null?rule.weekday_to:24;
  return hr>=from&&hr<to;
}
// Attacker blur logic
function isAtkDotBlurred(cat){
  if(pitchRotation==='cooldown_atk')return true; // all attackers blurred
  if(lastDoneAtkCat===cat)return true; // individual cooldown
  return false;
}

// ===== SUPABASE =====
async function loadAll(){
  const[tR,taR,ttR]=await Promise.all([sb.from('mind_map_app_tasks').select('*'),sb.from('mind_map_app_tags').select('*'),sb.from('mind_map_app_task_tags').select('task_id,tag_id')]);
  allTags=taR.data||[];tagMap={};allTags.forEach(t=>tagMap[t.id]=t);
  allTasks=(tR.data||[]).map(r=>({id:r.id,name:r.name,status:r.status,parent_id:r.parent_id,estimated_minutes:r.estimated_minutes,due_date:r.due_date,created_at:r.created_at,links:r.links||''}));
  taskTags={};(ttR.data||[]).forEach(r=>{if(!taskTags[r.task_id])taskTags[r.task_id]=[];taskTags[r.task_id].push(r.tag_id)});
  const{data:mem}=await sb.from('mind_map_app_chat_memory').select('key,value').in('key',['cf_pitch','cf_possession','cf_players','cf_regen_defaults','cf_regen_tasks','cf_timeslots','cf_office','cf_ofc_qlinks','cf_ofc_apps','cf_app_db']);
  pitchSet=new Set();const dp={'Paper study':'attacker','Quick study':'attacker',Coding:'attacker','App generation':'attacker',Reading:'attacker',Documentation:'attacker',Exercise:'midfielder',Errands:'midfielder'};
  playerMap={...dp};regenDefaults={};regenTasks={};timeSlotRules={};
  (mem||[]).forEach(m=>{
    if(m.key==='cf_pitch')try{pitchSet=new Set(JSON.parse(m.value))}catch{};
    if(m.key==='cf_possession')try{const p=JSON.parse(m.value);if(p.date===todayK())possession=p.state||'mid_morning'}catch{};
    if(m.key==='cf_players')try{playerMap={...dp,...JSON.parse(m.value)}}catch{};
    if(m.key==='cf_regen_defaults')try{regenDefaults=JSON.parse(m.value)}catch{};
    if(m.key==='cf_regen_tasks')try{regenTasks=JSON.parse(m.value)}catch{};
    if(m.key==='cf_timeslots')try{timeSlotRules=JSON.parse(m.value)}catch{};
    if(m.key==='cf_office')try{const o=JSON.parse(m.value);if(o.date===todayK()){ofcCheckedIn=o.checkedIn||false;ofcCheckoutDone=o.checkoutDone||false;ofcTimesheetDone=o.timesheetDone||false;ofcFreeeDone=o.freeeDone||false}
      // Legacy: migrate old format
      if(o.qlGroups&&!mem.find(x=>x.key==='cf_ofc_qlinks')){ofcQLGroups=o.qlGroups}
      if(o.apps&&!mem.find(x=>x.key==='cf_ofc_apps')){ofcApps=o.apps}
    }catch{};
    if(m.key==='cf_ofc_qlinks')try{ofcQLGroups=JSON.parse(m.value)}catch{};
    if(m.key==='cf_ofc_apps')try{ofcApps=JSON.parse(m.value)}catch{};
    if(m.key==='cf_app_db')try{const d=JSON.parse(m.value);if(d.uniTiles)uniTiles=d.uniTiles;if(d.appDB)appDB=d.appDB}catch{};
  });
  // Migrate: ensure uniTiles have URLs (fixes old saves before URLs were added)
  const defaultUrls={cal:'https://celeritas7.github.io/Calender_app/',cost:'https://celeritas7.github.io/Cost_management/'};
  let migrated=false;
  uniTiles.forEach(t=>{if(defaultUrls[t.id]&&!t.url){t.url=defaultUrls[t.id];migrated=true}});
  appDB.forEach(cat=>{(cat.apps||[]).forEach(a=>{if(a.id==='a_cal'&&!a.url){a.url=defaultUrls.cal;migrated=true}if(a.id==='a_cost'&&!a.url){a.url=defaultUrls.cost;migrated=true}})});
  if(migrated)saveAppDB();
}
async function memSave(key,val){
  const now=new Date().toISOString();try{const{data}=await sb.from('mind_map_app_chat_memory').select('id').eq('key',key).maybeSingle();
  if(data){await sb.from('mind_map_app_chat_memory').update({value:val,updated_at:now}).eq('key',key)}
  else{await sb.from('mind_map_app_chat_memory').insert({id:crypto.randomUUID(),key,value:val,updated_at:now})}}catch(e){console.error('memSave:',key,e)}
}
async function savePitch(){await memSave('cf_pitch',JSON.stringify([...pitchSet]))}
async function savePoss(){await memSave('cf_possession',JSON.stringify({date:todayK(),state:possession}))}
async function savePlayerMap(){await memSave('cf_players',JSON.stringify(playerMap))}
async function saveRegenDefaults(){await memSave('cf_regen_defaults',JSON.stringify(regenDefaults))}
async function saveRegenTasks(){await memSave('cf_regen_tasks',JSON.stringify(regenTasks))}
async function saveTimeSlots(){await memSave('cf_timeslots',JSON.stringify(timeSlotRules))}
async function saveOfcState(){await memSave('cf_office',JSON.stringify({checkedIn:ofcCheckedIn,checkoutDone:ofcCheckoutDone,timesheetDone:ofcTimesheetDone,freeeDone:ofcFreeeDone,date:todayK()}))}
async function saveOfcQL(){await memSave('cf_ofc_qlinks',JSON.stringify(ofcQLGroups))}
async function saveOfcApps(){await memSave('cf_ofc_apps',JSON.stringify(ofcApps))}
async function saveAppDB(){await memSave('cf_app_db',JSON.stringify({uniTiles,appDB}))}

// ===== APP LAUNCHER =====
let alEditMode=false;
let alDelTarget=null; // {type:'alcat'|'alsub'|'alapp', catIdx, subIdx?, appIdx?}

function openAppLaunch(){
  const sheet=document.getElementById('appLaunchSheet');
  let h=`<div class="applaunch-hd"><div class="applaunch-title">📚 My Apps</div><div style="display:flex;align-items:center;gap:6px"><button class="al-edit-btn" onclick="alEditMode=!alEditMode;openAppLaunch()">${alEditMode?'✓ Done':'✏️ Edit'}</button><button class="applaunch-close" onclick="closeAppLaunch()">✕</button></div></div>`;

  appDB.forEach((cat,ci)=>{
    const isOpen=alOpen[cat.id]===true; // default CLOSED
    const count=cat.apps?cat.apps.length:(cat.subs||[]).reduce((s,sub)=>s+(sub.apps||[]).length,0);

    // Category header
    h+=`<div class="alcat">`;
    if(alEditMode){
      h+=`<div class="al-cat-edit"><input class="al-edit-ico" value="${esc(cat.ico)}" onchange="appDB[${ci}].ico=this.value;saveAppDB()"><input class="al-edit-inp" value="${esc(cat.name)}" style="font-weight:700" onchange="appDB[${ci}].name=this.value;saveAppDB()"><span class="alcat-badge">${count}</span><button class="al-edit-del" onclick="alAskDel('alcat',${ci})" title="Delete category">🗑️</button><span class="alcat-toggle ${isOpen?'open':''}" onclick="alOpen['${cat.id}']=!${isOpen};openAppLaunch()" style="cursor:pointer">▼</span></div>`;
    } else {
      h+=`<div class="alcat-hd" onclick="alOpen['${cat.id}']=!${isOpen};openAppLaunch()"><span class="alcat-ico">${cat.ico}</span><span class="alcat-nm">${esc(cat.name)}</span><span class="alcat-badge">${count}</span><span class="alcat-toggle ${isOpen?'open':''}">▼</span></div>`;
    }
    h+=`<div class="alcat-body ${isOpen?'open':''}">`;

    if(cat.apps){
      cat.apps.forEach((a,ai)=>{h+=alEditMode?renderALAppEdit(a,ci,null,ai):renderALApp(a)});
      if(alEditMode)h+=`<div class="al-add-btn" onclick="appDB[${ci}].apps.push({id:'a_'+Date.now(),ico:'📱',name:'New App',url:''});saveAppDB();openAppLaunch()">+ Add app</div>`;
    }
    if(cat.subs){
      cat.subs.forEach((sub,si)=>{
        const subOpen=alOpen[sub.id]===true;
        if(alEditMode){
          h+=`<div class="alsub"><div class="al-cat-edit" style="padding-left:8px"><input class="al-edit-ico" value="${esc(sub.ico)}" onchange="appDB[${ci}].subs[${si}].ico=this.value;saveAppDB()"><input class="al-edit-inp" value="${esc(sub.name)}" style="font-weight:600" onchange="appDB[${ci}].subs[${si}].name=this.value;saveAppDB()"><span class="alcat-badge">${(sub.apps||[]).length}</span><button class="al-edit-del" onclick="alAskDel('alsub',${ci},${si})" title="Delete sub">🗑️</button><span class="alsub-arr ${subOpen?'open':''}" onclick="alOpen['${sub.id}']=!${subOpen};openAppLaunch()" style="cursor:pointer">▼</span></div>`;
        } else {
          h+=`<div class="alsub"><div class="alsub-hd" onclick="event.stopPropagation();alOpen['${sub.id}']=!${subOpen};openAppLaunch()"><span class="alsub-ico">${sub.ico}</span><span class="alsub-nm">${esc(sub.name)}</span><span class="alcat-badge">${(sub.apps||[]).length}</span><span class="alsub-arr ${subOpen?'open':''}">▼</span></div>`;
        }
        h+=`<div class="alsub-body ${subOpen?'open':''}">`;
        (sub.apps||[]).forEach((a,ai)=>{h+=alEditMode?renderALAppEdit(a,ci,si,ai):renderALApp(a)});
        if(alEditMode)h+=`<div class="al-add-btn" onclick="appDB[${ci}].subs[${si}].apps.push({id:'a_'+Date.now(),ico:'📱',name:'New App',url:''});saveAppDB();openAppLaunch()">+ Add app</div>`;
        h+=`</div></div>`;
      });
      if(alEditMode)h+=`<div class="al-add-btn" onclick="appDB[${ci}].subs.push({id:'sub_'+Date.now(),ico:'🏷️',name:'New Sub',apps:[]});saveAppDB();openAppLaunch()">+ Add sub-category</div>`;
    }
    h+=`</div></div>`;
  });

  if(alEditMode){
    h+=`<div class="al-add-btn" style="margin-top:8px;font-size:10px;font-weight:600" onclick="appDB.push({id:'cat_'+Date.now(),ico:'📂',name:'New Category',apps:[]});saveAppDB();openAppLaunch()">+ Add Category</div>`;
  }

  sheet.innerHTML=h;
  document.getElementById('appLaunchOv').classList.add('show');
}

function renderALApp(a){
  const dispUrl=a.url?(a.url.length>35?a.url.slice(0,35)+'…':a.url):'No URL set';
  const hasUrl=a.url&&a.url.trim();
  const locTag=a.locs?`<span class="alapp-loc all">All</span>`:'';
  return`<div class="alapp" onclick="${hasUrl?`window.open('${esc(a.url)}','_blank');closeAppLaunch()`:``}"><div class="alapp-ico">${a.ico}</div><div class="alapp-info"><div class="alapp-nm">${esc(a.name)}</div><div class="alapp-url">${esc(dispUrl)}</div></div>${locTag}${hasUrl?'<span class="alapp-go">↗</span>':''}</div>`;
}

function renderALAppEdit(a,ci,si,ai){
  const path=si!=null?`appDB[${ci}].subs[${si}].apps[${ai}]`:`appDB[${ci}].apps[${ai}]`;
  return`<div class="al-edit-row"><input class="al-edit-ico" value="${esc(a.ico)}" onchange="${path}.ico=this.value;saveAppDB()"><div style="flex:1;display:flex;flex-direction:column;gap:3px;min-width:0"><input class="al-edit-inp" value="${esc(a.name)}" placeholder="App name" onchange="${path}.name=this.value;saveAppDB()"><input class="al-edit-inp url" value="${esc(a.url||'')}" placeholder="https://... (URL)" onchange="${path}.url=this.value;saveAppDB()"></div><button class="al-edit-del" onclick="alAskDel('alapp',${ci},${si!=null?si:'null'},${ai})" title="Delete app">🗑️</button></div>`;
}

function alAskDel(type,ci,si,ai){
  let name='';
  if(type==='alcat')name=appDB[ci].name;
  else if(type==='alsub')name=appDB[ci].subs[si].name;
  else if(type==='alapp')name=si!=null?appDB[ci].subs[si].apps[ai].name:appDB[ci].apps[ai].name;
  alDelTarget={type,ci,si,ai};
  document.getElementById('delTaskName').textContent=name;
  document.getElementById('delPopup').classList.add('show');
}

function closeAppLaunch(){document.getElementById('appLaunchOv').classList.remove('show');alEditMode=false}

// Universal quick tiles rendering
function renderUniTiles(){
  let h='<div class="utiles">';
  uniTiles.filter(t=>t.locs.includes(loc)).forEach(t=>{
    const hasUrl=t.url&&t.url.trim();
    h+=`<div class="utile" onclick="${hasUrl?`window.open('${esc(t.url)}','_blank')`:'openAppLaunch()'}"><span class="utile-ico">${t.ico}</span><span class="utile-nm">${esc(t.name)}</span></div>`;
  });
  h+=`</div>`;
  return h;
}
// Confirm delete for QL groups
let ofcDelTarget=null; // {type:'qlgroup',idx} or {type:'app',idx}
function ofcAskDel(type,idx){
  ofcDelTarget={type,idx};
  const name=type==='qlgroup'?ofcQLGroups[idx].name:ofcApps[idx].name;
  document.getElementById('delTaskName').textContent=name;
  document.getElementById('delPopup').classList.add('show');
}
// Add app modal
let ofcAddingApp=false;
function ofcShowAddApp(){ofcAddingApp=true;renderPitch()}
function ofcCancelAddApp(){ofcAddingApp=false;renderPitch()}

// Quick links overlay
function ofcOpenQLOverlay(groupId){
  const g=ofcQLGroups.find(x=>x.id===groupId);if(!g)return;
  const sheet=document.getElementById('ofcQLSheet');
  let h=`<div class="ofc-ql-sheet-hd"><div class="ofc-ql-sheet-title"><span style="font-size:22px">${g.ico}</span> ${esc(g.name)}</div><button class="ofc-ql-sheet-close" onclick="ofcCloseQLOverlay()">✕</button></div>`;
  g.items.forEach(it=>{
    const dispUrl=it.url?(it.url.length>40?it.url.slice(0,40)+'…':it.url):'No URL set';
    const hasUrl=it.url&&it.url.trim();
    h+=`<div class="ofc-ql-sheet-link" onclick="${hasUrl?`window.open('${esc(it.url)}','_blank');ofcCloseQLOverlay()`:``}"><div class="ofc-ql-slink-ico">${it.ico}</div><div class="ofc-ql-slink-info"><div class="ofc-ql-slink-nm">${esc(it.name)}</div><div class="ofc-ql-slink-url">${esc(dispUrl)}</div></div>${hasUrl?'<span class="ofc-ql-slink-go">↗</span>':''}</div>`;
  });
  sheet.innerHTML=h;
  document.getElementById('ofcQLOverlay').classList.add('show');
}
function ofcCloseQLOverlay(){document.getElementById('ofcQLOverlay').classList.remove('show')}
function ofcSaveApp(){
  const ico=document.getElementById('ofcNewAppIco')?.value||'📱';
  const name=document.getElementById('ofcNewAppName')?.value?.trim();
  const url=document.getElementById('ofcNewAppUrl')?.value?.trim()||'';
  if(!name){alert('Enter an app name');return}
  ofcApps.push({ico,name,url});saveOfcApps();ofcAddingApp=false;renderPitch();
}
function ofcRemoveApp(idx){ofcAskDel('app',idx)}

// ===== OFFICE BLOCKER LOGIC =====
function ofcShouldMorning(){return dayType()==='weekday'&&new Date().getHours()>=9&&(new Date().getHours()>9||new Date().getMinutes()>=50)&&!ofcCheckedIn&&loc==='office'}
function ofcShouldEvening(){
  if(dayType()!=='weekday')return false;
  if(ofcCheckoutDone&&ofcTimesheetDone)return false;if(new Date().getHours()<19)return false;
  if(ofcEvDismissedAt&&(Date.now()-ofcEvDismissedAt)/60000<15)return false;
  return loc==='office';
}
function ofcUpdateBlockers(){
  const mE=document.getElementById('ofcMorning'),eE=document.getElementById('ofcEvening');
  if(ofcShouldMorning()){mE.classList.add('show');eE.classList.remove('show')}
  else if(ofcShouldEvening()){mE.classList.remove('show');eE.classList.add('show');ofcResetEvUI()}
  else{mE.classList.remove('show');eE.classList.remove('show')}
}
function ofcDoCheckin(){ofcCheckedIn=true;saveOfcState();ofcUpdateBlockers();renderPitch()}
function ofcEvMark(i){
  ofcEvMarks[i]=true;const btn=document.getElementById('ofcEvBtn'+i);btn.className='ofc-bl-btn ready';btn.textContent='✓ Done!';
  document.getElementById(i===0?'ofcBlCO':'ofcBlTS').classList.add('done');
  if(ofcEvMarks[0]&&ofcEvMarks[1]){
    ofcCheckoutDone=true;ofcTimesheetDone=true;saveOfcState();
    document.getElementById('ofcEvHint').textContent='✅ All done!';document.getElementById('ofcEvHint').className='ofc-bl-hint ok';
    setTimeout(()=>{setLoc('home');ofcUpdateBlockers()},800);
  }
}
function ofcEvSkip(){ofcEvDismissedAt=Date.now();ofcUpdateBlockers();renderPitch()}
function ofcResetEvUI(){
  ofcEvMarks=[ofcCheckoutDone,ofcTimesheetDone];
  ['ofcEvBtn0','ofcEvBtn1'].forEach((id,i)=>{const b=document.getElementById(id);if(ofcEvMarks[i]){b.className='ofc-bl-btn ready';b.textContent='✓ Done!'}else{b.className='ofc-bl-btn dim';b.textContent=i===0?'✓ Checkout done':'✓ Timesheet done'}});
  [['ofcBlCO',0],['ofcBlTS',1]].forEach(([id,i])=>{if(ofcEvMarks[i])document.getElementById(id).classList.add('done');else document.getElementById(id).classList.remove('done')});
  document.getElementById('ofcEvHint').textContent='⚠️ Complete both to stop reminders';document.getElementById('ofcEvHint').className='ofc-bl-hint';
}
function ofcMarkPending(key){
  if(key==='checkedIn')ofcCheckedIn=true;
  else if(key==='timesheetDone')ofcTimesheetDone=true;
  else if(key==='checkoutDone')ofcCheckoutDone=true;
  saveOfcState();renderPitch();
}
function ofcGetPending(){
  const p=[];const hr=new Date().getHours();
  if(dayType()==='weekday'&&!ofcCheckedIn&&hr>=9&&(hr>9||new Date().getMinutes()>=50))p.push({id:'ci',ico:'🔐',name:'Daily Check-in Entry',desc:'Haven\'t checked in today',key:'checkedIn'});
  if(dayType()==='weekday'&&hr>=19&&!ofcCheckoutDone)p.push({id:'co',ico:'🔐',name:'Daily Check-out Entry',desc:'Checkout not completed',key:'checkoutDone'});
  if(dayType()==='weekday'&&hr>=19&&!ofcTimesheetDone)p.push({id:'ts',ico:'📋',name:'Daily Timesheet Entry',desc:'Timesheet not submitted',key:'timesheetDone'});
  return p;
}
function ofcIsFreeeDay(){
  const n=new Date(),y=n.getFullYear(),m=n.getMonth(),last=new Date(y,m+1,0);
  let lwd=new Date(last);while(lwd.getDay()===0||lwd.getDay()===6)lwd.setDate(lwd.getDate()-1);
  let dlwd=new Date(lwd);dlwd.setDate(dlwd.getDate()-1);while(dlwd.getDay()===0||dlwd.getDay()===6)dlwd.setDate(dlwd.getDate()-1);
  return n.toDateString()===dlwd.toDateString();
}
function ofcWorkDays(){const n=new Date(),y=n.getFullYear(),m=n.getMonth(),last=new Date(y,m+1,0).getDate();let c=0;for(let d=1;d<=last;d++){const day=new Date(y,m,d).getDay();if(day>=1&&day<=5)c++}return c}

// Office task helpers
function ofcGetList(key){return key==='mgr'?ofcMgrTasks:key==='rem'?ofcReminders:ofcPplTasks}
function ofcToggleDone(key,id){const l=ofcGetList(key),t=l.find(x=>x.id===id);if(!t)return;if(!t.done){t.done=true;t.doneAt=Date.now()}else{const cd=t.doneAt&&Math.floor((Date.now()-t.doneAt)/86400000)<7;if(!cd){t.done=false;t.doneAt=null}}renderPitch()}

// Office task CRUD
let ofcEditingTask=null; // {key, id}
let ofcDelTaskTarget=null; // {key, id}
function ofcAddTask(key){
  const inp=document.getElementById('ofcAddInp_'+key);if(!inp)return;
  const name=inp.value.trim();if(!name)return;
  const list=ofcGetList(key);
  const newT={id:'ot_'+Date.now(),name,pri:'medium',done:false,doneAt:null};
  if(key==='mgr'){newT.from='Me';newT.due=''}
  else if(key==='rem'){newT.time=''}
  else{newT.from='';newT.role=''}
  list.push(newT);inp.value='';renderPitch();
}
function ofcStartEdit(key,id){ofcEditingTask={key,id};renderPitch()}
function ofcCancelEdit(){ofcEditingTask=null;renderPitch()}
function ofcSaveEdit(key,id){
  const list=ofcGetList(key),t=list.find(x=>x.id===id);if(!t)return;
  const nameInp=document.getElementById('ofcEd_name_'+id.replace(/\W/g,''));
  const priSel=document.getElementById('ofcEd_pri_'+id.replace(/\W/g,''));
  const metaInp=document.getElementById('ofcEd_meta_'+id.replace(/\W/g,''));
  if(nameInp)t.name=nameInp.value.trim()||t.name;
  if(priSel)t.pri=priSel.value;
  if(metaInp){if(key==='mgr')t.due=metaInp.value;else if(key==='rem')t.time=metaInp.value;else t.from=metaInp.value}
  ofcEditingTask=null;renderPitch();
}
function ofcAskDelTask(key,id){
  const list=ofcGetList(key),t=list.find(x=>x.id===id);if(!t)return;
  ofcDelTaskTarget={key,id};
  document.getElementById('delTaskName').textContent=t.name;
  document.getElementById('delPopup').classList.add('show');
}
function ofcCounts(list){const a=list.filter(t=>!t.done);return{crit:a.filter(t=>t.pri==='critical').length,high:a.filter(t=>t.pri==='high').length,total:a.length}}
function ofcTopPri(){
  const all=[];
  ofcMgrTasks.filter(t=>!t.done&&(t.pri==='critical'||t.pri==='high')).forEach(t=>all.push({...t,src:'mgr',srcLabel:'Manager',bk:'mgr'}));
  ofcReminders.filter(t=>!t.done&&(t.pri==='critical'||t.pri==='high')).forEach(t=>all.push({...t,src:'me',srcLabel:'Reminder',bk:'rem'}));
  ofcPplTasks.filter(t=>!t.done&&(t.pri==='critical'||t.pri==='high')).forEach(t=>all.push({...t,src:'ppl',srcLabel:t.from,bk:'ppl'}));
  all.sort((a,b)=>OFC_PRI_ORD.indexOf(a.pri)-OFC_PRI_ORD.indexOf(b.pri));return all;
}
function ofcPriTag(p){return`<span class="ofc-titem-pri" style="background:${OFC_PRI[p].bg};color:${OFC_PRI[p].c}">${OFC_PRI[p].l}</span>`}

// 15-min evening re-check
setInterval(()=>{if(loc==='office')ofcUpdateBlockers()},60000);
// Close QL overlay on outside click is handled by the overlay itself

// ===== OFFICE RENDER =====
function renderOffice(){
  const field=document.getElementById('pitchField'),strip=document.getElementById('possStrip');
  strip.innerHTML='';ofcUpdateBlockers();
  const hr=new Date().getHours(),isWork=ofcCheckedIn&&hr>=10&&hr<20;
  const showFreee=ofcIsFreeeDay()&&!ofcFreeeDone;
  const topTasks=ofcTopPri();
  const mgrC=ofcCounts(ofcMgrTasks),remC=ofcCounts(ofcReminders),pplC=ofcCounts(ofcPplTasks);
  let h='<div class="ofc-dash">';

  // Header
  h+=`<div class="ofc-hdr"><div class="ofc-hdr-title">🏢 Office <span class="ofc-badge">${dayType().toUpperCase()}</span></div></div>`;
  // Universal quick tiles
  h+=renderUniTiles();

  // Freee banner
  if(showFreee){const wd=ofcWorkDays();
    h+=`<div class="ofc-freee"><div class="ofc-freee-hdr"><span style="font-size:20px">💴</span><div class="ofc-freee-title">Transport Reimbursement</div><span class="ofc-freee-badge">Due tomorrow</span></div>`;
    h+=`<div class="ofc-freee-desc">This month has <strong>${wd} working days</strong>. Prepare your Freee application.</div>`;
    h+=`<div class="ofc-freee-gen">📝 Application format generation<br><span style="font-size:9px;color:var(--text2)">(${wd} working days × ¥ rate — logic placeholder)</span></div>`;
    h+=`<div class="ofc-freee-actions"><button class="ofc-freee-btn pri" onclick="window.open('${ofcLinks.freee}','_blank')">Open Freee ↗</button><button class="ofc-freee-btn sec" onclick="ofcFreeeDone=true;saveOfcState();renderPitch()">✓ Done</button></div></div>`;
  }

  // Apps dock
  h+=`<div class="ofc-dock"><div class="ofc-dock-hdr ${ofcDockOpen?'open':''}" onclick="ofcDockOpen=!ofcDockOpen;renderPitch()"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:16px">📱</span><span style="font-size:12px;font-weight:600">My Apps</span></div><div style="display:flex;align-items:center;gap:8px"><button style="border:none;background:none;font-size:9px;color:var(--accent);font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif" onclick="event.stopPropagation();ofcAppEdit=!ofcAppEdit;ofcDockOpen=true;renderPitch()">${ofcAppEdit?'✓ Done':'✏️'}</button><div class="ofc-dock-chev">▼</div></div></div>`;
  h+=`<div class="ofc-dock-body ${ofcDockOpen?'open':''}"><div class="ofc-app-grid">`;
  ofcApps.forEach((a,i)=>{
    if(ofcAppEdit){
      h+=`<div class="ofc-app-tile-wrap"><button class="ofc-app-xbtn" onclick="event.stopPropagation();ofcRemoveApp(${i})">✕</button><div class="ofc-app-tile"><span class="ofc-app-ico">${a.ico}</span><div class="ofc-app-nm">${esc(a.name)}</div></div></div>`;
    } else {
      h+=`<div class="ofc-app-tile"${a.url?` onclick="window.open('${esc(a.url)}','_blank')"`:``}><span class="ofc-app-ico">${a.ico}</span><div class="ofc-app-nm">${esc(a.name)}</div></div>`;
    }
  });
  h+=`<div class="ofc-app-tile" style="border:1.5px dashed var(--as);opacity:.6" onclick="event.stopPropagation();ofcShowAddApp()"><span class="ofc-app-ico">➕</span><div class="ofc-app-nm">Add</div></div></div></div></div>`;
  // Add app form
  if(ofcAddingApp){
    h+=`<div class="ofc-app-add"><div class="ofc-app-add-title">Add New App</div><div class="ofc-app-add-row"><input class="ofc-app-add-ico" id="ofcNewAppIco" value="📱" placeholder="🔗"><input class="ofc-app-add-inp" id="ofcNewAppName" placeholder="App name"></div><div class="ofc-app-add-row"><input class="ofc-app-add-inp" id="ofcNewAppUrl" placeholder="https://... (URL)"></div><div class="ofc-app-add-btns"><button class="ofc-app-add-btn save" onclick="ofcSaveApp()">Save</button><button class="ofc-app-add-btn cancel" onclick="ofcCancelAddApp()">Cancel</button></div></div>`;
  }

  // Grouped quick links — tap opens overlay window
  const visGroups=ofcQLGroups.filter(g=>g.workHours?isWork:true);
  h+=`<div class="ofc-ql"><div class="ofc-ql-hdr"><div class="ofc-ql-title">🔗 Quick Links</div><button class="ofc-ql-edit" onclick="ofcQLEdit=!ofcQLEdit;renderPitch()">${ofcQLEdit?'✓ Done':'✏️ Edit'}</button></div>`;
  if(!ofcQLEdit){
    h+=`<div class="ofc-ql-row">`;
    visGroups.forEach(g=>{
      if(g.items.length===1&&g.items[0].url){
        // Single link — open directly
        h+=`<div class="ofc-ql-grp"><div class="ofc-ql-btn" onclick="window.open('${esc(g.items[0].url)}','_blank')"><span>${g.ico}</span> ${esc(g.name)}</div></div>`;
      } else {
        // Multi-link — open overlay
        h+=`<div class="ofc-ql-grp"><div class="ofc-ql-btn" onclick="ofcOpenQLOverlay('${g.id}')"><span>${g.ico}</span> ${esc(g.name)} <span style="font-size:8px;color:var(--text2);margin-left:2px">${g.items.length}</span></div></div>`;
      }
    });
    h+=`</div>`;
  } else {
    // Edit mode — with group rename and delete with warning
    h+=`<div class="ofc-ql-ep">`;
    ofcQLGroups.forEach((g,gi)=>{
      h+=`<div class="ofc-ql-eg"><div class="ofc-ql-eg-hd"><input class="ofc-ql-eg-ico" value="${esc(g.ico)}" style="width:26px;font-size:12px" onchange="ofcQLGroups[${gi}].ico=this.value;saveOfcQL()"><input class="ofc-ql-eg-inp" value="${esc(g.name)}" style="font-size:11px;font-weight:700;flex:1" onchange="ofcQLGroups[${gi}].name=this.value;saveOfcQL()"><button class="ofc-ql-eg-del" onclick="ofcAskDel('qlgroup',${gi})" title="Delete group">🗑️</button></div>`;
      g.items.forEach((it,ii)=>{h+=`<div class="ofc-ql-eg-row"><input class="ofc-ql-eg-ico" value="${esc(it.ico)}" onchange="ofcQLGroups[${gi}].items[${ii}].ico=this.value;saveOfcQL()"><input class="ofc-ql-eg-inp" value="${esc(it.name)}" onchange="ofcQLGroups[${gi}].items[${ii}].name=this.value;saveOfcQL()"><input class="ofc-ql-eg-inp" value="${esc(it.url)}" placeholder="URL" onchange="ofcQLGroups[${gi}].items[${ii}].url=this.value;saveOfcQL()"><button class="ofc-ql-eg-xb" onclick="ofcQLGroups[${gi}].items.splice(${ii},1);saveOfcQL();renderPitch()">✕</button></div>`});
      h+=`<div class="ofc-ql-addl" onclick="ofcQLGroups[${gi}].items.push({ico:'🔗',name:'New Link',url:''});saveOfcQL();renderPitch()">+ Add link</div></div>`;
    });
    h+=`<div class="ofc-ql-addg" onclick="ofcQLGroups.push({id:'g'+Date.now(),ico:'📌',name:'New Group',items:[{ico:'🔗',name:'Link',url:''}]});saveOfcQL();renderPitch()">+ Add Group</div></div>`;
  }
  h+=`</div>`;

  // Critical surface
  if(topTasks.length){
    h+=`<div class="ofc-crit"><div class="ofc-crit-hd">🔥 Highest Priority (${topTasks.length})</div>`;
    topTasks.forEach(t=>{const cl=t.src==='mgr'?'mgr':t.src==='me'?'me':'ppl';
      h+=`<div class="ofc-crit-card s-${cl}"><div class="ofc-crit-pri" style="background:${OFC_PRI[t.pri].c}"></div><div class="ofc-crit-info"><div class="ofc-crit-name">${esc(t.name)}</div><div class="ofc-crit-meta"><span class="ofc-crit-src ${cl}">${t.srcLabel}</span> ${t.due?'Due '+t.due:''}${t.time||''}</div></div><div class="ofc-crit-dn" onclick="ofcToggleDone('${t.bk}','${t.id}')">✓</div></div>`});
    h+=`</div>`;
  }

  // Box cards
  h+=`<div class="ofc-box-grid">`;
  ['mgr','rem','ppl'].forEach(key=>{const m=OFC_BOX[key],c=key==='mgr'?mgrC:key==='rem'?remC:pplC,isA=ofcOpenBox===key;
    h+=`<div class="ofc-box ${isA?'active':''}" onclick="ofcOpenBox=ofcOpenBox==='${key}'?'':'${key}';renderPitch()"><div class="ofc-box-badges">${c.crit?`<div class="ofc-box-bdot" style="background:#DC2626"></div>`:''}${c.high?`<div class="ofc-box-bdot" style="background:#E8722A"></div>`:''}</div><span class="ofc-box-ico">${m.ico}</span><div class="ofc-box-cnt">${c.total}</div><div class="ofc-box-nm">${m.name}</div></div>`});
  h+=`</div>`;

  // Expanded panel
  if(ofcOpenBox){
    const m=OFC_BOX[ofcOpenBox],list=ofcGetList(ofcOpenBox);
    const metaLabel=ofcOpenBox==='mgr'?'Due':ofcOpenBox==='rem'?'Time':'From';
    const metaFn=ofcOpenBox==='mgr'?t=>`<span class="ofc-from mgr">${t.from||''}</span> ${t.due?'Due '+t.due:''}`:ofcOpenBox==='rem'?t=>t.time||'':t=>`<span class="ofc-from ppl">${t.from||''}</span> ${t.role||''}`;
    const metaVal=ofcOpenBox==='mgr'?t=>t.due||'':ofcOpenBox==='rem'?t=>t.time||'':t=>t.from||'';
    h+=`<div class="ofc-panel"><div class="ofc-panel-hd"><div class="ofc-panel-title"><span style="font-size:18px">${m.ico}</span> ${m.name}</div><button class="ofc-panel-close" onclick="ofcOpenBox='';renderPitch()">✕</button></div>`;
    h+=`<div class="ofc-box-add"><input class="ofc-box-inp" id="ofcAddInp_${ofcOpenBox}" placeholder="Add task..." onkeydown="if(event.key==='Enter')ofcAddTask('${ofcOpenBox}')"><button class="ofc-box-sub" style="background:${m.color}" onclick="ofcAddTask('${ofcOpenBox}')">+ Add</button></div>`;
    const groups={};OFC_PRI_ORD.forEach(p=>groups[p]=[]);const cds=[];
    list.forEach(t=>{if(t.done&&t.doneAt&&Math.floor((Date.now()-t.doneAt)/86400000)>=7)return;if(t.done&&t.doneAt&&Math.floor((Date.now()-t.doneAt)/86400000)<7){cds.push(t);return}if(!t.done)groups[t.pri].push(t)});
    let has=false;
    for(const pri of OFC_PRI_ORD){if(!groups[pri].length)continue;has=true;
      h+=`<div class="ofc-pri-grp"><div class="ofc-pri-hd"><span class="ofc-pri-dot" style="background:${OFC_PRI[pri].c}"></span> <span style="color:${OFC_PRI[pri].c}">${OFC_PRI[pri].l} (${groups[pri].length})</span></div>`;
      groups[pri].forEach(t=>{
        const isEd=ofcEditingTask&&ofcEditingTask.key===ofcOpenBox&&ofcEditingTask.id===t.id;
        const sid=t.id.replace(/\W/g,'');
        if(isEd){
          h+=`<div class="ofc-titem-edit"><div class="ofc-titem-edit-row"><input class="ofc-titem-edit-inp" id="ofcEd_name_${sid}" value="${esc(t.name)}"><select class="ofc-titem-edit-sel" id="ofcEd_pri_${sid}">${OFC_PRI_ORD.map(p=>`<option value="${p}" ${t.pri===p?'selected':''}>${OFC_PRI[p].l}</option>`).join('')}</select></div><div class="ofc-titem-edit-row"><input class="ofc-titem-edit-inp" id="ofcEd_meta_${sid}" value="${esc(metaVal(t))}" placeholder="${metaLabel}..."></div><div class="ofc-titem-edit-btns"><button class="ofc-titem-edit-btn save" onclick="ofcSaveEdit('${ofcOpenBox}','${t.id}')">Save</button><button class="ofc-titem-edit-btn del" onclick="ofcAskDelTask('${ofcOpenBox}','${t.id}')">🗑️ Delete</button><button class="ofc-titem-edit-btn cancel" onclick="ofcCancelEdit()">Cancel</button></div></div>`;
        } else {
          h+=`<div class="ofc-titem"><div class="ofc-titem-cb" onclick="ofcToggleDone('${ofcOpenBox}','${t.id}')"></div><div class="ofc-titem-info" onclick="ofcStartEdit('${ofcOpenBox}','${t.id}')" style="cursor:pointer"><div class="ofc-titem-nm">${esc(t.name)}</div><div class="ofc-titem-meta">${metaFn(t)}</div></div>${ofcPriTag(t.pri)}<button class="ofc-titem-del" onclick="ofcAskDelTask('${ofcOpenBox}','${t.id}')">🗑️</button></div>`;
        }
      });
      h+=`</div>`}
    if(cds.length){has=true;h+=`<div class="ofc-pri-grp"><div class="ofc-pri-hd"><span style="color:#8B5CF6">🔄 Completed (${cds.length})</span></div>`;
      cds.forEach(t=>{const left=Math.max(0,7-Math.floor((Date.now()-t.doneAt)/86400000));h+=`<div class="ofc-titem cooldown"><div class="ofc-titem-cb done"></div><div class="ofc-titem-info"><div class="ofc-titem-nm">${esc(t.name)}</div><div class="ofc-titem-meta" style="color:#8B5CF6">↻ ${left}d</div></div>${ofcPriTag(t.pri)}</div>`});h+=`</div>`}
    if(!has&&!cds.length)h+=`<div class="ofc-empty">All clear ✨</div>`;
    h+=`</div>`;
  }
  h+=`</div>`;
  field.innerHTML=h;
}

// Render pending office tasks on non-office screens
function renderOfcPendingBanner(){
  const pending=ofcGetPending();if(!pending.length)return'';
  let h=`<div class="ofc-pending"><div class="ofc-pend-hdr">⚠️ Pending Office Tasks</div>`;
  pending.forEach(p=>{h+=`<div class="ofc-pend-task"><div class="ofc-pend-ico">${p.ico}</div><div class="ofc-pend-info"><div class="ofc-pend-name">${p.name}</div><div class="ofc-pend-desc">${p.desc}</div></div><button class="ofc-pend-btn dn" onclick="ofcMarkPending('${p.key}')">✓ Done</button></div>`});
  return h+`</div>`;
}
async function markDone(id){const t=allTasks.find(x=>x.id===id);if(t)t.status='done';await sb.from('mind_map_app_tasks').update({status:'done',updated_at:new Date().toISOString()}).eq('id',id)}
async function markActive(id){const t=allTasks.find(x=>x.id===id);if(t)t.status='in_progress';await sb.from('mind_map_app_tasks').update({status:'in_progress',updated_at:new Date().toISOString()}).eq('id',id)}

// Pitch
function addPitch(id){const t=allTasks.find(x=>x.id===id);if(t&&!canPitch(t))return;pitchSet.add(id);savePitch();renderAll()}
function rmPitch(id){pitchSet.delete(id);savePitch();if(currentStudyId===id)stopTimer();renderAll()}
async function toggleTask(id){
  const t=allTasks.find(x=>x.id===id);if(!t)return;
  if(t.status==='done'){
    // Reactivate from done
    await markActive(id);renderAll();
  } else {
    // Show regen popup before marking done
    pendingDoneId=id;showRegenPopup(t);
  }
}
function showRegenPopup(t){
  const cat=tCategory(t);const catDefault=regenDefaults[cat];const taskOverride=regenTasks[t.id]?.days;
  const current=taskOverride!=null?taskOverride:catDefault!=null?catDefault:null;
  const el=document.getElementById('regenPopup');
  document.getElementById('regenTaskName').textContent=t.name;
  document.getElementById('regenCatDefault').textContent=catDefault!=null?catDefault+' days':'not set';
  document.getElementById('regenCustom').value=current||'';
  // Highlight active preset
  document.querySelectorAll('.regen-chip').forEach(c=>c.classList.toggle('active',current!=null&&parseInt(c.dataset.d)===current));
  el.classList.add('show');
}
async function confirmRegen(){
  const id=pendingDoneId;if(!id)return;const t=allTasks.find(x=>x.id===id);if(!t)return;
  const custom=document.getElementById('regenCustom').value;
  const days=custom?parseInt(custom):null;
  // Save regen info
  regenTasks[id]={days,done_at:new Date().toISOString()};
  await saveRegenTasks();
  // Mark done + rotation
  const pl=taskPlayer(t);const cat=tCategory(t);await markDone(id);pitchSet.delete(id);savePitch();
  if(pl==='attacker'){
    pitchRotation='cooldown_atk'; // blur ALL attackers
    lastDoneAtkCat=cat; // this one stays blurred even after unlock
  } else if(pitchRotation==='cooldown_atk'&&(pl==='midfielder'||pl==='defender')){
    pitchRotation='free'; // unlock attackers (except lastDoneAtkCat)
  }
  pendingDoneId=null;closeRegenPopup();
  // Auto-start next study if coming from study chain
  const next=pitched().filter(isStudy);
  if(isStudy(t)&&next.length){startStudy(next[0].id)}else{renderAll()}
}
function selectRegenPreset(days){document.getElementById('regenCustom').value=days;document.querySelectorAll('.regen-chip').forEach(c=>c.classList.toggle('active',parseInt(c.dataset.d)===days))}
function closeRegenPopup(){document.getElementById('regenPopup').classList.remove('show');pendingDoneId=null}

// ===== DELETE TASK =====
let pendingDeleteId=null;
function askDelete(id){
  const t=allTasks.find(x=>x.id===id);if(!t)return;
  pendingDeleteId=id;
  document.getElementById('delTaskName').textContent=t.name;
  document.getElementById('delPopup').classList.add('show');
}
function cancelDelete(){document.getElementById('delPopup').classList.remove('show');pendingDeleteId=null;ofcDelTarget=null;alDelTarget=null;ofcDelTaskTarget=null}
async function confirmDelete(){
  // Office QL/App deletes
  if(ofcDelTarget){
    if(ofcDelTarget.type==='qlgroup'){ofcQLGroups.splice(ofcDelTarget.idx,1);saveOfcQL()}
    else if(ofcDelTarget.type==='app'){ofcApps.splice(ofcDelTarget.idx,1);saveOfcApps()}
    ofcDelTarget=null;document.getElementById('delPopup').classList.remove('show');renderPitch();return;
  }
  // App launcher deletes
  if(alDelTarget){
    const{type,ci,si,ai}=alDelTarget;
    if(type==='alcat'){appDB.splice(ci,1)}
    else if(type==='alsub'){appDB[ci].subs.splice(si,1)}
    else if(type==='alapp'){if(si!=null)appDB[ci].subs[si].apps.splice(ai,1);else appDB[ci].apps.splice(ai,1)}
    saveAppDB();alDelTarget=null;document.getElementById('delPopup').classList.remove('show');openAppLaunch();return;
  }
  // Office task deletes
  if(ofcDelTaskTarget){
    const{key,id}=ofcDelTaskTarget;const list=ofcGetList(key);
    const idx=list.findIndex(x=>x.id===id);if(idx>=0)list.splice(idx,1);
    ofcDelTaskTarget=null;ofcEditingTask=null;document.getElementById('delPopup').classList.remove('show');renderPitch();return;
  }
  // Regular task delete
  const id=pendingDeleteId;if(!id)return;
  // Remove from pitch
  pitchSet.delete(id);savePitch();
  if(currentStudyId===id)stopTimer();
  // Remove from regen tracking
  delete regenTasks[id];await saveRegenTasks();
  // Delete tag associations
  await sb.from('mind_map_app_task_tags').delete().eq('task_id',id);
  // Delete the task itself
  await sb.from('mind_map_app_tasks').delete().eq('id',id);
  // Remove from local state
  allTasks=allTasks.filter(t=>t.id!==id);
  delete taskTags[id];
  pendingDeleteId=null;
  document.getElementById('delPopup').classList.remove('show');
  renderAll();
}
// ===== TASK LINKS =====
let editingLinkId=null;
function showLinkEdit(id){editingLinkId=editingLinkId===id?null:id;renderCatDetail()}
async function saveTaskLink(id){
  const inp=document.getElementById('linkInp_'+id.replace(/-/g,''));if(!inp)return;
  const url=inp.value.trim();
  const t=allTasks.find(x=>x.id===id);if(t)t.links=url;
  await sb.from('mind_map_app_tasks').update({links:url,updated_at:new Date().toISOString()}).eq('id',id);
  editingLinkId=null;renderCatDetail();
}
async function removeTaskLink(id){
  const t=allTasks.find(x=>x.id===id);if(t)t.links='';
  await sb.from('mind_map_app_tasks').update({links:'',updated_at:new Date().toISOString()}).eq('id',id);
  editingLinkId=null;renderCatDetail();
}
function renderAll(){renderPitch();if(document.getElementById('ovBg').classList.contains('show'))renderOv();if(document.getElementById('catDetail').classList.contains('show'))renderCatDetail()}

// Priority
async function changePriority(taskId,newPri){
  const priTags=allTags.filter(t=>t.type==='priority');const newTag=priTags.find(t=>t.name.toLowerCase()===newPri);if(!newTag)return;
  const oldIds=priTags.map(t=>t.id);const cur=taskTags[taskId]||[];
  for(const id of cur.filter(i=>oldIds.includes(i)))await sb.from('mind_map_app_task_tags').delete().eq('task_id',taskId).eq('tag_id',id);
  await sb.from('mind_map_app_task_tags').insert({id:crypto.randomUUID(),task_id:taskId,tag_id:newTag.id,created_at:new Date().toISOString()});
  taskTags[taskId]=cur.filter(i=>!oldIds.includes(i)).concat([newTag.id]);renderAll();
}
function promoteTask(id){const c=tPriority(allTasks.find(t=>t.id===id)),i=PRI_ORDER.indexOf(c);if(i>0)changePriority(id,PRI_ORDER[i-1])}
function demoteTask(id){const c=tPriority(allTasks.find(t=>t.id===id)),i=PRI_ORDER.indexOf(c);if(i<PRI_ORDER.length-1)changePriority(id,PRI_ORDER[i+1])}

// Category assign
async function assignCat(taskId,catName){
  const catTag=allTags.find(t=>t.type==='category'&&t.name===catName);if(!catTag)return;
  const oldCatIds=allTags.filter(t=>t.type==='category').map(t=>t.id);const cur=taskTags[taskId]||[];
  for(const id of cur.filter(i=>oldCatIds.includes(i)))await sb.from('mind_map_app_task_tags').delete().eq('task_id',taskId).eq('tag_id',id);
  await sb.from('mind_map_app_task_tags').insert({id:crypto.randomUUID(),task_id:taskId,tag_id:catTag.id,created_at:new Date().toISOString()});
  taskTags[taskId]=cur.filter(i=>!oldCatIds.includes(i)).concat([catTag.id]);renderAll();
}

// Create new task
async function createTask(name,catName){
  const newId=crypto.randomUUID();const now=new Date().toISOString();
  const{data,error}=await sb.from('mind_map_app_tasks').insert({id:newId,name,status:'not_started',created_at:now,updated_at:now}).select().single();
  if(error){alert('Error: '+error.message);return}
  allTasks.push({id:newId,name,status:'not_started',created_at:now});
  if(catName){const catTag=allTags.find(t=>t.type==='category'&&t.name===catName);if(catTag){
    await sb.from('mind_map_app_task_tags').insert({id:crypto.randomUUID(),task_id:newId,tag_id:catTag.id,created_at:now});
    taskTags[newId]=[catTag.id];
  }}
  renderAll();
}

// Theme/UI
function applyTheme(l){const r=document.documentElement,p='--'+l;['bg','accent','as','card','text','text2'].forEach(k=>r.style.setProperty('--'+k,getComputedStyle(r).getPropertyValue(p+'-'+k)))}
function setLoc(l){loc=l;applyTheme(l);document.querySelectorAll('#locG .loc-b').forEach(b=>b.classList.toggle('active',b.dataset.l===l));checkPoss();ofcUpdateBlockers();renderPitch()}
function setMood(m){mood=m;renderPitch()}
function toggleHol(){manHol=!manHol;updateBadge();checkPoss();renderPitch()}
function updateBadge(){const dt=dayType(),b=document.getElementById('dayB');b.textContent=dt==='holiday'?'Holiday':dt==='weekend'?'Weekend':'Weekday';b.className='day-badge '+dt;document.getElementById('holB').classList.toggle('active',manHol)}
function updateClock(){document.getElementById('timeD').textContent=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}

// ===== OVERLAY =====
function openOv(){document.getElementById('ovBg').classList.add('show');renderOv()}
function closeOv(){document.getElementById('ovBg').classList.remove('show')}
function switchOvTab(t){ovTab=t;document.getElementById('ovTabB').classList.toggle('active',t==='bench');document.getElementById('ovTabD').classList.toggle('active',t==='dc');document.getElementById('ovTabR').classList.toggle('active',t==='rules');renderOv()}
function renderOv(){document.getElementById('ovContent').innerHTML=ovTab==='bench'?renderBench():ovTab==='dc'?renderDC():renderRules()}

// ===== BENCH =====
function renderBench(){
  const lt=locTasks(),done=allTasks.filter(t=>t.status==='done'&&tInLoc(t,loc)&&!isInCooldown(t)).slice(0,15);
  const cooldown=allTasks.filter(t=>isInCooldown(t)&&tInLoc(t,loc));
  const tagged=lt.filter(hasCategory),untagged=lt.filter(t=>!hasCategory(t));
  const groups={};tagged.forEach(t=>{const c=tCategory(t);if(!groups[c])groups[c]=[];groups[c].push(t)});
  let h='';for(const[cat,list]of Object.entries(groups)){h+=`<div style="margin-bottom:14px"><div class="sec-hdr">${cat} <span style="background:var(--as);color:var(--accent);padding:0 6px;border-radius:8px;font-size:9px">${list.length}</span></div>${list.map(benchHTML).join('')}</div>`}
  if(untagged.length)h+=`<div style="margin-bottom:14px"><div class="sec-hdr" style="cursor:pointer" onclick="document.getElementById('uncL').style.display=document.getElementById('uncL').style.display==='none'?'block':'none'">📦 Uncategorized (${untagged.length}) ▸</div><div id="uncL" style="display:none">${untagged.map(benchHTML).join('')}</div></div>`;
  if(cooldown.length)h+=`<div style="margin-bottom:14px"><div class="sec-hdr" style="cursor:pointer;color:#8B5CF6" onclick="document.getElementById('cdL').style.display=document.getElementById('cdL').style.display==='none'?'block':'none'">🔄 In Cooldown (${cooldown.length}) ▸</div><div id="cdL" style="display:none">${cooldown.map(benchHTML).join('')}</div></div>`;
  if(done.length)h+=`<div><div class="sec-hdr" style="cursor:pointer" onclick="document.getElementById('doneL').style.display=document.getElementById('doneL').style.display==='none'?'block':'none'">✅ Done (${done.length}) ▸</div><div id="doneL" style="display:none">${done.map(benchHTML).join('')}</div></div>`;
  return h||'<div style="text-align:center;padding:24px;color:var(--text2);font-size:12px">No tasks for this location</div>';
}
function benchHTML(t){
  const pri=tPriority(t),onP=pitchSet.has(t.id),cat=tCategory(t),isDone=t.status==='done',inCD=isInCooldown(t);
  const left=inCD?cooldownDaysLeft(t):0;const rDays=getRegenDays(t);
  const delBtn=`<button style="border:none;background:none;font-size:11px;cursor:pointer;color:#DC2626;opacity:.35;flex-shrink:0;padding:2px 4px" onclick="event.stopPropagation();askDelete('${t.id}')">🗑️</button>`;
  if(inCD)return`<div class="bench-task done" style="opacity:.45"><div class="bench-pbar" style="background:#8B5CF6"></div><div class="bench-cb checked" style="pointer-events:none"></div><div class="bench-info"><div class="bench-title">${esc(t.name)}</div><div class="bench-meta"><span class="bench-tag" style="background:#8B5CF622;color:#8B5CF6">↻ ${left}d left</span>${cat?`<span class="bench-tag" style="background:var(--as);color:var(--accent)">${cat}</span>`:''}</div></div>${delBtn}</div>`;
  return`<div class="bench-task ${isDone?'done':''}"><div class="bench-pbar" style="background:${priColor(pri)}"></div><div class="bench-cb ${isDone?'checked':''}" onclick="toggleTask('${t.id}')"></div><div class="bench-info"><div class="bench-title">${esc(t.name)}</div><div class="bench-meta">${cat?`<span class="bench-tag" style="background:${priColor(pri)}22;color:${priColor(pri)}">${pri}</span><span class="bench-tag" style="background:var(--as);color:var(--accent)">${cat}</span>`:''}</div></div>${!isDone?`<button class="pitch-btn ${onP?'on':'off'}" onclick="event.stopPropagation();${onP?`rmPitch('${t.id}')`:`addPitch('${t.id}')`}">${onP?'✓ Pitch':'▶ Pitch'}</button>`:''} ${delBtn}</div>`;
}

// ===== DECISION CENTRE =====
function renderDC(){
  const allActive=allTasks.filter(t=>t.status!=='done'&&!isInCooldown(t));const players={attacker:{},midfielder:{},defender:{}};
  allActive.filter(hasCategory).forEach(t=>{const cat=tCategory(t),pl=catPlayer(cat);if(pl&&players[pl]){if(!players[pl][cat])players[pl][cat]=[];players[pl][cat].push(t)}});
  let h='';
  ['attacker','midfielder','defender'].forEach(pl=>{
    const info=PLAYER_INFO[pl];const cats=Object.entries(players[pl]);
    const assigned=Object.entries(playerMap).filter(([,p])=>p===pl).map(([c])=>c);
    const allCats=[...new Set([...cats.map(([c])=>c),...assigned])];
    const total=cats.reduce((s,[,l])=>s+l.length,0);
    const totalCrit=cats.reduce((s,[,l])=>s+l.filter(t=>tPriority(t)==='critical').length,0);
    h+=`<div class="player-sec ${info.cl}"><div class="player-hdr ${info.cl}"><span class="player-icon">${info.icon}</span><span class="player-name">${info.name} ${totalCrit?'(🔴'+totalCrit+')':'('+total+')'}</span><button class="player-add-btn" onclick="openNewCatModal('${pl}')" style="margin-left:auto">+ New</button></div>`;
    if(allCats.length){h+=`<div class="dc-chips">${allCats.map(cat=>{
      const list=players[pl][cat]||[];const onP=list.filter(t=>pitchSet.has(t.id)).length;
      const critCount=list.filter(t=>tPriority(t)==='critical').length;
      return`<div class="dc-chip" onclick="openCatDetail('${cat.replace(/'/g,"\\'")}')"><span>${cat}</span>${critCount?`<span class="dc-chip-count" style="background:#DC262622;color:#DC2626">🔴${critCount}</span>`:`<span class="dc-chip-count">${list.length}</span>`}${onP?`<span style="font-size:8px;color:#059669">⚽${onP}</span>`:''}</div>`
    }).join('')}</div>`}else{h+=`<div style="font-size:10px;color:var(--text2);opacity:.5;padding:4px">No categories assigned</div>`}
    h+=`</div>`;
  });
  return h;
}

// ===== CATEGORY DETAIL =====
function openCatDetail(cat){catDetailName=cat;catDetailSearch='';document.getElementById('catDetail').classList.add('show');renderCatDetail()}
function closeCatDetail(){editingLinkId=null;document.getElementById('catDetail').classList.remove('show')}
function renderCatDetail(){
  const cat=catDetailName;const pl=catPlayer(cat);const info=pl?PLAYER_INFO[pl]:null;
  const allInCat=allTasks.filter(t=>tCategory(t)===cat);
  const tasksInCat=allInCat.filter(t=>t.status!=='done');
  const cooldownTasks=allInCat.filter(t=>isInCooldown(t));
  const doneInCat=allInCat.filter(t=>t.status==='done'&&!isInCooldown(t));
  const onPitch=tasksInCat.filter(t=>pitchSet.has(t.id)).length;
  const uncategorized=allTasks.filter(t=>t.status!=='done'&&!hasCategory(t));
  const filtered=catDetailSearch?uncategorized.filter(t=>t.name.toLowerCase().includes(catDetailSearch.toLowerCase())):[];
  const catDef=regenDefaults[cat];

  let h=`<div class="cat-top"><div class="cat-back" onclick="closeCatDetail()">←</div><div class="cat-name">${esc(cat)}</div>${info?`<div class="cat-badge ${info.cl}">${info.icon} ${info.name}</div>`:''}</div>`;
  h+=`<div class="cat-stats"><div class="cat-stat"><div class="cat-stat-num">${tasksInCat.length}</div><div class="cat-stat-lbl">Active</div></div><div class="cat-stat"><div class="cat-stat-num">${onPitch}</div><div class="cat-stat-lbl">On Pitch</div></div><div class="cat-stat"><div class="cat-stat-num">${cooldownTasks.length}</div><div class="cat-stat-lbl">Cooldown</div></div><div class="cat-stat"><div class="cat-stat-num">${doneInCat.length}</div><div class="cat-stat-lbl">Done</div></div></div>`;

  // Regen default setting
  h+=`<div style="margin-bottom:12px;padding:10px 12px;background:var(--card);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.05)"><div style="display:flex;align-items:center;justify-content:space-between"><div style="font-size:10px;font-weight:700;color:var(--text2)">♻️ DEFAULT REGEN INTERVAL</div><div style="display:flex;align-items:center;gap:6px"><input id="catRegenInput" type="number" min="0" value="${catDef||''}" placeholder="days" style="width:50px;border:1.5px solid var(--as);border-radius:6px;padding:4px 6px;font-size:11px;font-family:DM Sans,sans-serif;text-align:center;background:var(--bg);color:var(--text);outline:none"><button onclick="saveCatRegen()" style="border:none;background:var(--accent);color:white;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;font-family:DM Sans,sans-serif">Set</button></div></div><div style="font-size:9px;color:var(--text2);margin-top:4px">${catDef?'All new completions regen after '+catDef+' days':'Not set — set days so tasks regenerate after completion'}</div></div>`;

  // Add new task
  h+=`<div class="cat-add"><input class="cat-add-input" id="catNewTask" placeholder="Add new task to ${esc(cat)}..." onkeydown="if(event.key==='Enter')addTaskToCat()"><button class="cat-add-btn" onclick="addTaskToCat()">+ Add</button></div>`;

  // Search uncategorized
  h+=`<div class="sec-hdr" style="margin-top:8px">🔍 Pull from uncategorized (${uncategorized.length})</div>`;
  h+=`<input class="cat-search" id="catSearchInput" placeholder="Search tasks to add to ${esc(cat)}..." value="${esc(catDetailSearch)}" oninput="catDetailSearch=this.value;renderCatDetail()">`;
  if(catDetailSearch&&filtered.length){h+=filtered.slice(0,15).map(t=>`<div class="cat-search-item"><div class="cat-search-name">${esc(t.name)}</div><button class="cat-pull-btn" onclick="assignCat('${t.id}','${cat.replace(/'/g,"\\'")}')">+ Pull in</button></div>`).join('');
    if(filtered.length>15)h+=`<div style="font-size:9px;color:var(--text2);text-align:center;padding:4px">${filtered.length-15} more...</div>`}
  else if(catDetailSearch&&!filtered.length){h+=`<div style="font-size:10px;color:var(--text2);padding:8px;text-align:center">No matches</div>`}

  // Cooldown section
  if(cooldownTasks.length){
    h+=`<div class="sec-hdr" style="margin-top:16px;color:#8B5CF6">🔄 In Cooldown (${cooldownTasks.length})</div>`;
    h+=cooldownTasks.map(t=>{
      const left=cooldownDaysLeft(t);const days=getRegenDays(t);
      return`<div class="dc-item" style="opacity:.5"><div class="dc-item-info" style="flex:1"><div class="dc-item-n">${esc(t.name)}</div><div class="dc-item-c" style="color:#8B5CF6">↻ ${left} day${left!==1?'s':''} left · regen every ${days}d</div></div><button style="border:none;background:none;font-size:12px;cursor:pointer;color:#DC2626;opacity:.6;flex-shrink:0;padding:4px" onclick="event.stopPropagation();askDelete('${t.id}')">🗑️</button></div>`
    }).join('');
  }

  // Existing tasks grouped by priority
  if(tasksInCat.length){
    const priGroups={critical:[],high:[],medium:[],low:[],someday:[]};
    tasksInCat.forEach(t=>priGroups[tPriority(t)].push(t));
    const priLabels={critical:{l:'🔴 Critical',c:'#DC2626'},high:{l:'🟠 High',c:'#E8722A'},medium:{l:'🟡 Medium',c:'#F59E0B'},low:{l:'🔵 Low',c:'#95a5a6'},someday:{l:'💭 Someday',c:'#bdc3c7'}};
    h+=`<div style="margin-top:16px">`;
    for(const[pri,list]of Object.entries(priGroups)){
      if(!list.length)continue;const lb=priLabels[pri];
      h+=`<div class="sec-hdr" style="margin-top:10px;color:${lb.c}">${lb.l} (${list.length})</div>`;
      h+=list.map(t=>{
        const onP=pitchSet.has(t.id),dur=isStudy(t)?tDuration(t):null,full=!onP&&!canPitch(t);
        const hasLink=t.links&&t.links.trim();const isEditing=editingLinkId===t.id;const sid=t.id.replace(/-/g,'');
        let linkHtml='';
        if(isEditing){
          linkHtml=`<div class="link-edit"><input class="link-inp" id="linkInp_${sid}" value="${esc(t.links||'')}" placeholder="https://..." onkeydown="if(event.key==='Enter'){event.stopPropagation();saveTaskLink('${t.id}')}"><div class="link-edit-btns"><button class="link-save" onclick="event.stopPropagation();saveTaskLink('${t.id}')">Save</button>${hasLink?`<button class="link-rm" onclick="event.stopPropagation();removeTaskLink('${t.id}')">Remove</button>`:''}<button class="link-cancel" onclick="event.stopPropagation();editingLinkId=null;renderCatDetail()">Cancel</button></div></div>`;
        } else if(hasLink){
          linkHtml=`<div class="dc-item-c"><a href="${esc(t.links)}" target="_blank" onclick="event.stopPropagation()" style="color:var(--accent);font-size:10px;text-decoration:none">🔗 ${t.links.length>30?t.links.slice(0,30)+'…':t.links}</a> <button style="border:none;background:none;font-size:9px;cursor:pointer;color:var(--text2);opacity:.5" onclick="event.stopPropagation();showLinkEdit('${t.id}')">✏️</button></div>`;
        }
        return`<div class="dc-item" style="flex-wrap:wrap"><div class="dc-pri-btns"><button class="dc-pri-btn" onclick="event.stopPropagation();promoteTask('${t.id}')">↑</button><button class="dc-pri-btn" onclick="event.stopPropagation();demoteTask('${t.id}')">↓</button></div><div class="dc-item-info"><div class="dc-item-n">${esc(t.name)}</div><div class="dc-item-c">${dur?dur+'m':''}${!hasLink&&!isEditing?` <button style="border:none;background:none;font-size:9px;cursor:pointer;color:var(--text2);opacity:.4" onclick="event.stopPropagation();showLinkEdit('${t.id}')">+ link</button>`:''}</div>${linkHtml}</div><button class="pitch-btn ${onP?'on':'off'}" ${full&&!onP?'disabled style="opacity:.4;cursor:not-allowed"':''} onclick="event.stopPropagation();${onP?`rmPitch('${t.id}')`:`addPitch('${t.id}')`}">${onP?'✓ Pitch':full?'Full':'▶ Pitch'}</button><button style="border:none;background:none;font-size:12px;cursor:pointer;color:#DC2626;opacity:.4;flex-shrink:0;padding:4px" onclick="event.stopPropagation();askDelete('${t.id}')">🗑️</button></div>`
      }).join('');
    }
    h+=`</div>`;
  }

  document.getElementById('catPanel').innerHTML=h;
  if(catDetailSearch){const inp=document.getElementById('catSearchInput');if(inp){inp.focus();inp.setSelectionRange(inp.value.length,inp.value.length)}}
  if(editingLinkId){const sid=editingLinkId.replace(/-/g,'');const inp=document.getElementById('linkInp_'+sid);if(inp){inp.focus();inp.setSelectionRange(inp.value.length,inp.value.length)}}
}
async function saveCatRegen(){const v=document.getElementById('catRegenInput').value;const days=v?parseInt(v):null;if(days!=null&&days>0)regenDefaults[catDetailName]=days;else delete regenDefaults[catDetailName];await saveRegenDefaults();renderCatDetail()}
async function addTaskToCat(){const inp=document.getElementById('catNewTask');const name=inp.value.trim();if(!name)return;await createTask(name,catDetailName);inp.value='';renderCatDetail()}

// ===== NEW CATEGORY MODAL =====
let catModalForPlayer='attacker';
function openNewCatModal(pl){catModalForPlayer=pl;document.getElementById('catModalTitle').textContent='New Category';document.getElementById('catModalInput').value='';document.getElementById('catModalPlayer').value=pl;document.getElementById('catModal').classList.add('show')}
function closeCatModal(){document.getElementById('catModal').classList.remove('show')}
async function saveCatModal(){
  const player=document.getElementById('catModalPlayer').value;
  const name=document.getElementById('catModalInput').value.trim();if(!name){alert('Enter a name');return}
  let catTag=allTags.find(t=>t.type==='category'&&t.name.toLowerCase()===name.toLowerCase());
  if(!catTag){const{data,error}=await sb.from('mind_map_app_tags').insert({id:crypto.randomUUID(),name,type:'category',color:'#7f8c8d',is_focused:false,sort_order:0,created_at:new Date().toISOString()}).select().single();if(error){alert('Error: '+error.message);return}if(data){allTags.push(data);tagMap[data.id]=data;catTag=data}}
  playerMap[catTag?catTag.name:name]=player;await savePlayerMap();closeCatModal();renderOv();
}

// ===== POSSESSION =====
const M_T=[{id:'mc',t:'Make coffee / tea',i:'☕'},{id:'mw',t:'Drink water',i:'💧'},{id:'mf',t:'Face wash',i:'🧼'}];
const L_T=[{id:'le',t:'Eat a proper lunch',i:'🍱'},{id:'lw',t:'Drink water',i:'💧'},{id:'lo',t:'Organize food',i:'🗄️'},{id:'ls',t:'Shopping list check',i:'🛒'}];
const D_T=[{id:'dg',t:'Grooming / skincare',i:'🪞'},{id:'dl',t:'Laundry',i:'👔'},{id:'dc',t:'Clean room',i:'🧹'},{id:'ds',t:"Prep tomorrow's clothes",i:'👕'},{id:'dd',t:'Wind down',i:'😴'}];
function checkPoss(){if(!isOff()||loc!=='home'){hideAllLocks();clearNudge();return}applyPoss()}
function applyPoss(){hideAllLocks();clearNudge();if(possession==='mid_morning')showLock('lockM','lockMT','lockMB','lockMS',M_T,morningCk);else if(possession==='attacker'||possession==='attacker2')startNudge();else if(possession==='mid_lunch')showLunchLock();else if(possession==='defender')showDefLock()}
function hideAllLocks(){['lockM','lockL','lockD'].forEach(id=>document.getElementById(id).classList.remove('show'))}
function showLock(ov,tid,bid,sid,list,set){set.clear();document.getElementById(tid).innerHTML=list.map(t=>`<div class="lock-task" id="lk_${t.id}" onclick="tglLock('${t.id}','${ov}')"><div class="lt-cb" id="lcb_${t.id}"></div><span class="lt-text">${t.t}</span><span class="lt-icon">${t.i}</span></div>`).join('');updLockBtn(bid,sid,set,ov==='lockM');document.getElementById(ov).classList.add('show')}
function tglLock(id,ov){const set=ov==='lockM'?morningCk:ov==='lockL'?lunchCk:defCk;set.has(id)?set.delete(id):set.add(id);const list=ov==='lockM'?M_T:ov==='lockL'?L_T:D_T;list.forEach(t=>{document.getElementById('lk_'+t.id)?.classList.toggle('checked',set.has(t.id));document.getElementById('lcb_'+t.id)?.classList.toggle('checked',set.has(t.id))});const td=ov==='lockM'?true:ov==='lockL'?lunchRem<=0:defRem<=0;updLockBtn(ov==='lockM'?'lockMB':ov==='lockL'?'lockLB':'lockDB',ov==='lockM'?'lockMS':ov==='lockL'?'lockLS':'lockDS',set,td)}
function updLockBtn(b,s,set,td){const r=set.size>=1&&td;document.getElementById(b).className='lock-btn '+(r?'ready':'waiting');document.getElementById(s).textContent=r?'Ready! ⚽':set.size<1?'Check at least one':'✅ Checked — wait'}
function unlockM(){if(morningCk.size<1)return;possession='attacker';savePoss();hideAllLocks();startNudge();renderPitch()}
function showLunchLock(){lunchCk.clear();lunchRem=3600;showLock('lockL','lockLT','lockLB','lockLS',L_T,lunchCk);clearInterval(lunchInt);lunchInt=setInterval(()=>{lunchRem--;document.getElementById('lunchT').textContent=`${String(Math.floor(lunchRem/60)).padStart(2,'0')}:${String(lunchRem%60).padStart(2,'0')}`;updLockBtn('lockLB','lockLS',lunchCk,lunchRem<=0);if(lunchRem<=0)clearInterval(lunchInt)},1000)}
function unlockL(){if(lunchCk.size<1||lunchRem>0)return;clearInterval(lunchInt);possession='attacker2';savePoss();hideAllLocks();startNudge();renderPitch()}
function showDefLock(){defCk.clear();defRem=1800;showLock('lockD','lockDT','lockDB','lockDS',D_T,defCk);clearInterval(defInt);defInt=setInterval(()=>{defRem--;document.getElementById('defT').textContent=`${String(Math.floor(defRem/60)).padStart(2,'0')}:${String(defRem%60).padStart(2,'0')}`;updLockBtn('lockDB','lockDS',defCk,defRem<=0);if(defRem<=0)clearInterval(defInt)},1000)}
function unlockD(){if(defCk.size<1||defRem>0)return;clearInterval(defInt);possession='done';savePoss();hideAllLocks();renderPitch()}
function triggerDef(){possession='defender';savePoss();clearNudge();stopTimer();showDefLock();renderPitch()}
function skipLock(type){hideAllLocks();clearInterval(lunchInt);clearInterval(defInt);if(type==='morning')possession='attacker';else if(type==='lunch')possession='attacker2';else possession='done';savePoss();if(possession==='attacker'||possession==='attacker2')startNudge();renderPitch()}
setInterval(()=>{if(isOff()&&loc==='home'&&possession==='attacker'&&new Date().getHours()>=13){possession='mid_lunch';savePoss();stopTimer();applyPoss();renderPitch()}},60000);
const NUDGES=[{i:'💧',t:'Drink water!'},{i:'🧘',t:'Quick stretch'},{i:'👀',t:'Look away 20s'},{i:'🫁',t:'3 deep breaths'},{i:'🚶',t:'Stand up'}];
function startNudge(){clearNudge();lastNudge=Date.now();nudgeInt=setInterval(()=>{if(Date.now()-lastNudge>=3600000){const n=NUDGES[Math.floor(Math.random()*NUDGES.length)];document.getElementById('nudgeT').textContent=n.t;document.querySelector('.nudge-icon').textContent=n.i;document.getElementById('nudge').classList.add('show');lastNudge=Date.now();setTimeout(dismissNudge,30000)}},60000)}
function dismissNudge(){document.getElementById('nudge').classList.remove('show')}
function clearNudge(){clearInterval(nudgeInt);dismissNudge()}

// ===== STUDY TIMER =====
function startStudy(id){const t=allTasks.find(x=>x.id===id);if(!t)return;studyTimerTotal=tDuration(t)*60;studyTimerRem=studyTimerTotal;currentStudyId=id;studyTimerActive=true;clearInterval(studyTimerInt);studyTimerInt=setInterval(()=>{studyTimerRem--;renderPitch();if(studyTimerRem<=0){studyTimerActive=false;clearInterval(studyTimerInt);triggerBreak()}},1000);renderPitch()}
function pauseStudy(){studyTimerActive=false;clearInterval(studyTimerInt);renderPitch()}
function resumeStudy(){if(!currentStudyId||studyTimerRem<=0)return;studyTimerActive=true;studyTimerInt=setInterval(()=>{studyTimerRem--;renderPitch();if(studyTimerRem<=0){studyTimerActive=false;clearInterval(studyTimerInt);triggerBreak()}},1000);renderPitch()}
async function completeStudy(){studyTimerActive=false;clearInterval(studyTimerInt);const id=currentStudyId;studyTimerRem=0;currentStudyId=null;const t=allTasks.find(x=>x.id===id);if(t){pendingDoneId=id;showRegenPopup(t);renderPitch()}}
function stopTimer(){studyTimerActive=false;clearInterval(studyTimerInt);currentStudyId=null;studyTimerRem=0}
const TIPS=[{i:'💧',t:'Drink water'},{i:'🍙',t:'Snack'},{i:'🧘',t:'Stretch'},{i:'👀',t:'Rest eyes'},{i:'🚶',t:'Walk'},{i:'🫁',t:'Deep breaths'},{i:'🎵',t:'Song'}];
function triggerBreak(){breakRem=300;document.getElementById('breakOv').classList.add('show');document.getElementById('breakIcon').textContent=['🌿','🌊','☀️','🍃'][Math.floor(Math.random()*4)];document.getElementById('breakTips').innerHTML=[...TIPS].sort(()=>Math.random()-.5).slice(0,3).map(t=>`<div class="break-tip"><span style="font-size:18px">${t.i}</span><span>${t.t}</span></div>`).join('');breakInt=setInterval(()=>{breakRem--;document.getElementById('bTime').textContent=`${Math.floor(breakRem/60)}:${String(breakRem%60).padStart(2,'0')}`;document.getElementById('bRing').style.strokeDashoffset=276.46*(1-breakRem/300);if(breakRem<=0)endBreak()},1000)}
async function endBreak(){clearInterval(breakInt);document.getElementById('breakOv').classList.remove('show');const t=allTasks.find(x=>x.id===currentStudyId);if(t){pendingDoneId=currentStudyId;currentStudyId=null;showRegenPopup(t)}else{currentStudyId=null;const next=pitched().filter(isStudy);if(next.length)startStudy(next[0].id);else renderPitch()}}
function skipBreak(){endBreak()}

// ===== RENDER PITCH =====
function renderPitch(){
  const field=document.getElementById('pitchField'),strip=document.getElementById('possStrip');
  // === OFFICE: render office dashboard instead of pitch ===
  if(loc==='office'){renderOffice();return}
  // Pending office tasks banner on non-office screens
  const pendingBanner=renderOfcPendingBanner();
  const uTiles=renderUniTiles();
  if(loc==='home'&&isOff()){const p={attacker:{d:'d-atk',cl:'atk',t:'⚔️ Attackers',s:'Focus'},attacker2:{d:'d-atk',cl:'atk',t:'⚔️ Second Half',s:'Keep going'},mid_morning:{d:'d-mid',cl:'mid',t:'☕ Midfield',s:'Morning'},mid_lunch:{d:'d-mid',cl:'mid',t:'🍱 Midfield',s:'Lunch'},defender:{d:'d-def',cl:'def',t:'🪞 Defenders',s:'Self-care'},done:{d:'d-done',cl:'done',t:'✅ Done',s:'Great day!'}}[possession]||{d:'d-atk',cl:'atk',t:'⚔️',s:''};strip.innerHTML=uTiles+pendingBanner+`<div class="poss-strip ${p.cl}"><div class="poss-dot ${p.d}"></div><span class="poss-text">${p.t}</span><span class="poss-sub">${p.s}</span>${(possession==='attacker'||possession==='attacker2')?`<button class="pass-def-btn" onclick="triggerDef()">🪞 Defenders</button>`:''}</div>`}else strip.innerHTML=uTiles+pendingBanner;
  if(loc==='outside'){let h=`<div style="width:100%"><div class="mood-bar">${[['Energetic','💪'],['Bit tired','😊'],['Tired','😔'],['Sleepy','😴']].map(([m,e])=>`<div class="mood-btn ${mood===m?'active':''}" onclick="setMood('${m}')"><span class="mood-emoji">${e}</span><span class="mood-lbl">${m}</span></div>`).join('')}</div></div>`;if(mood==='Sleepy')h+=`<a class="link-c" href="https://youtube.com" target="_blank"><span style="font-size:24px">📺</span><div style="font-size:13px;font-weight:600">YouTube</div></a>`;const pt=pitched();if(pt.length)h+=pt.map(t=>`<div class="dev-card"><div class="dev-cb" onclick="toggleTask('${t.id}')"></div><div class="dev-title">${esc(t.name)}</div><div class="dev-tag">${tCategory(t)}</div><button class="dev-rm" onclick="rmPitch('${t.id}')">✕</button></div>`).join('');field.innerHTML=h;return}
  
  const pt=pitched();
  if(!pt.length){field.innerHTML=`<div class="fp"><div class="fp-lines"><svg viewBox="0 0 300 450" preserveAspectRatio="none"><line x1="0" y1="225" x2="300" y2="225"/><circle cx="150" cy="225" r="45"/><circle cx="150" cy="225" r="2" fill="rgba(255,255,255,.3)"/><rect x="75" y="0" width="150" height="70"/><rect x="110" y="0" width="80" height="25"/><rect x="75" y="380" width="150" height="70"/><rect x="110" y="425" width="80" height="25"/><line x1="0" y1="0" x2="300" y2="0"/><line x1="0" y1="450" x2="300" y2="450"/><line x1="0" y1="0" x2="0" y2="450"/><line x1="300" y1="0" x2="300" y2="450"/></svg></div><div class="fp-empty"><div class="fp-empty-icon">⚽</div><div class="fp-empty-text">The pitch is empty</div><div class="fp-empty-sub">Open ☰ and select tasks</div></div></div>`;return}

  // Group pitched tasks by category → player type (filter by timeslot)
  const catGroups={};
  pt.forEach(t=>{const cat=tCategory(t)||'Other';if(!catGroups[cat])catGroups[cat]=[];catGroups[cat].push(t)});
  const zones={attacker:[],midfielder:[],defender:[],other:[]};
  for(const[cat,tasks]of Object.entries(catGroups)){
    const pl=catPlayer(cat);
    // Time slot filter: hide attackers outside their allowed window
    if(pl==='attacker'&&!isCatAllowedNow(cat))continue;
    if(pl&&zones[pl])zones[pl].push({cat,tasks});else zones.other.push({cat,tasks});
  }
  // Merge other into midfielder
  zones.midfielder.push(...zones.other);zones.other=[];
  
  const CIRC=2*Math.PI*60;

  // Position calculator — vertical pitch: attackers top, mid center, def bottom
  function getPositions(list,yCenter,ySpread){
    const n=list.length;if(!n)return[];
    const positions=[];
    if(n===1){positions.push({x:50,y:yCenter})}
    else if(n===2){positions.push({x:30,y:yCenter},{x:70,y:yCenter})}
    else if(n===3){positions.push({x:50,y:yCenter-ySpread},{x:25,y:yCenter+ySpread},{x:75,y:yCenter+ySpread})}
    else if(n===4){positions.push({x:25,y:yCenter-ySpread},{x:75,y:yCenter-ySpread},{x:25,y:yCenter+ySpread},{x:75,y:yCenter+ySpread})}
    else{for(let i=0;i<n;i++){const angle=(i/(n))*Math.PI*2-Math.PI/2;positions.push({x:50+Math.cos(angle)*25,y:yCenter+Math.sin(angle)*ySpread})}}
    return positions;
  }

  const atkPos=getPositions(zones.attacker,18,7);
  const midPos=getPositions(zones.midfielder,50,8);
  const defPos=getPositions(zones.defender,82,7);

  let dots='';
  function renderDots(list,positions,cl){
    list.forEach((g,i)=>{
      const pos=positions[i]||{x:50,y:50};const isExp=expandedDot===g.cat;const taskCount=g.tasks.length;
      // Per-category blur for attackers
      const blur=cl==='atk'&&isAtkDotBlurred(g.cat);
      dots+=`<div class="fp-dot ${isExp?'active':''} ${blur?'blurred':''}" style="left:${pos.x}%;top:${pos.y}%" onclick="${blur?'':`event.stopPropagation();toggleDot('${g.cat.replace(/'/g,"\\'")}')`}"><div class="fp-ball ${cl}" style="position:relative"><span style="font-size:${g.cat.length>6?'7':'8'}px;line-height:1.2">${g.cat.length>10?g.cat.slice(0,9)+'…':g.cat}</span>${taskCount>1?`<div class="fp-count">${taskCount}</div>`:''}</div><div class="fp-lbl">${g.cat}</div>`;
      // Expanded card
      if(isExp&&!blur){
        const cardDir=pos.y>60?'above':'';
        dots+=`<div class="fp-card ${cardDir}" onclick="event.stopPropagation()"><button class="fp-card-close" onclick="event.stopPropagation();expandedDot='';renderPitch()">✕</button><div class="fp-card-cat ${cl}">${g.cat} — ${taskCount} task${taskCount>1?'s':''}</div>`;
        g.tasks.forEach(t=>{
          const dur=tDuration(t);const isSt=isStudy(t);
          const hasLnk=t.links&&t.links.trim();
          dots+=`<div class="fp-card-task" style="flex-wrap:wrap"><div class="fp-card-cb" onclick="event.stopPropagation();toggleTask('${t.id}')"></div><div class="fp-card-name">${esc(t.name)}</div>${hasLnk?`<a href="${esc(t.links)}" target="_blank" onclick="event.stopPropagation()" style="font-size:10px;text-decoration:none;flex-shrink:0">🔗</a>`:''}${isSt?`<button class="fp-card-btn timer" onclick="event.stopPropagation();startStudy('${t.id}')">▶ ${dur}m</button>`:`<button class="fp-card-btn check" onclick="event.stopPropagation();toggleTask('${t.id}')">✓</button>`}</div>`;
        });
        dots+=`</div>`;
      }
      dots+=`</div>`;
    });
  }
  renderDots(zones.attacker,atkPos,'atk');
  renderDots(zones.midfielder,midPos,'mid');
  renderDots(zones.defender,defPos,'def');

  // Timer overlay
  let timerHtml='';
  const activeStudy=currentStudyId?pt.find(t=>t.id===currentStudyId):null;
  if(activeStudy&&(studyTimerActive||studyTimerRem>0)){
    const pct=studyTimerTotal>0?studyTimerRem/studyTimerTotal:1,off=CIRC*(1-pct);
    const m=Math.floor(studyTimerRem/60),s=studyTimerRem%60;
    timerHtml=`<div class="fp-timer"><div class="fp-timer-label">📓 NOW STUDYING</div><div class="fp-timer-title">${esc(activeStudy.name)}</div><div class="fp-timer-cat">${tCategory(activeStudy)}</div><div class="fp-timer-ring"><svg viewBox="0 0 140 140"><circle class="tr-bg" cx="70" cy="70" r="60"/><circle class="tr-fill" cx="70" cy="70" r="60" stroke-dasharray="${CIRC}" stroke-dashoffset="${off}"/></svg><div class="fp-timer-digits">${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}<div class="fp-timer-status">${studyTimerActive?'studying':'paused'}</div></div></div><div class="fp-timer-btns">${studyTimerActive?`<button class="fp-timer-btn pause" onclick="pauseStudy()">⏸ Pause</button>`:`<button class="fp-timer-btn start" onclick="resumeStudy()">▶ Resume</button>`}<button class="fp-timer-btn done" onclick="completeStudy()">✓ Done</button></div></div>`;
  }

  let lockMsg='';
  if(pitchRotation==='cooldown_atk')lockMsg=`<div class="fp-lock-msg">🔄 Do a Mid/Defender task to unlock Attackers</div>`;
  else if(lastDoneAtkCat&&zones.attacker.some(g=>g.cat===lastDoneAtkCat))lockMsg=`<div class="fp-lock-msg">🔒 ${lastDoneAtkCat} resting — use other attackers</div>`;

  field.innerHTML=`<div class="fp" onclick="expandedDot='';renderPitch()"><div class="fp-lines"><svg viewBox="0 0 300 450" preserveAspectRatio="none"><line x1="0" y1="225" x2="300" y2="225"/><circle cx="150" cy="225" r="45"/><circle cx="150" cy="225" r="2" fill="rgba(255,255,255,.3)"/><rect x="75" y="0" width="150" height="70"/><rect x="110" y="0" width="80" height="25"/><rect x="75" y="380" width="150" height="70"/><rect x="110" y="425" width="80" height="25"/><line x1="0" y1="0" x2="300" y2="0"/><line x1="0" y1="450" x2="300" y2="450"/><line x1="0" y1="0" x2="0" y2="450"/><line x1="300" y1="0" x2="300" y2="450"/></svg></div>${dots}${timerHtml}${lockMsg}</div>`;
}
function toggleDot(cat){expandedDot=expandedDot===cat?'':cat;renderPitch()}

// ===== RULES PANEL =====
function renderRules(){
  // Get all attacker categories
  const atkCats=Object.entries(playerMap).filter(([,p])=>p==='attacker').map(([c])=>c);
  const hr=new Date().getHours();
  const dt=dayType();

  let h=`<div style="margin-bottom:16px"><div style="font-family:'Fraunces',serif;font-size:15px;font-weight:700;margin-bottom:4px">⚔️ Attacker Time Slots</div><div style="font-size:10px;color:var(--text2);line-height:1.5">Set when each attacker can appear on the pitch during weekdays. Mid/Def are always available.</div></div>`;

  if(!atkCats.length){h+=`<div style="font-size:11px;color:var(--text2);text-align:center;padding:20px">No attacker categories assigned yet</div>`;return h}

  atkCats.forEach(cat=>{
    const rule=timeSlotRules[cat]||{};
    const wdFrom=rule.weekday_from!=null?rule.weekday_from:0;
    const wdTo=rule.weekday_to!=null?rule.weekday_to:24;
    const wkend=rule.weekend!==false;
    const allowed=isCatAllowedNow(cat);

    h+=`<div class="rule-card"><div class="rule-top"><div class="rule-name">${esc(cat)}</div><div class="rule-status ${allowed?'on':'off'}">${allowed?'● Available':'○ Blocked'}</div></div>`;

    // Weekday hours
    h+=`<div class="rule-row"><div class="rule-label">Weekday hours</div><div class="rule-inputs"><select class="rule-sel" id="rs_${cat.replace(/\s/g,'_')}_from" onchange="updateTimeSlot('${cat.replace(/'/g,"\\'")}')">`;
    for(let i=0;i<=23;i++){h+=`<option value="${i}" ${i===wdFrom?'selected':''}>${String(i).padStart(2,'0')}:00</option>`}
    h+=`</select><span style="font-size:10px;color:var(--text2)">to</span><select class="rule-sel" id="rs_${cat.replace(/\s/g,'_')}_to" onchange="updateTimeSlot('${cat.replace(/'/g,"\\'")}')">`;
    for(let i=1;i<=24;i++){h+=`<option value="${i}" ${i===wdTo?'selected':''}>${i===24?'24:00':String(i).padStart(2,'0')+':00'}</option>`}
    h+=`</select></div></div>`;

    // Weekend toggle
    h+=`<div class="rule-row"><div class="rule-label">Weekends & holidays</div><button class="rule-toggle ${wkend?'on':''}" onclick="toggleWeekend('${cat.replace(/'/g,"\\'")}')">${wkend?'✓ Available':'✕ Blocked'}</button></div>`;

    // Quick presets
    h+=`<div class="rule-presets"><button class="rule-preset" onclick="setPreset('${cat.replace(/'/g,"\\'")}','always')">Always</button><button class="rule-preset" onclick="setPreset('${cat.replace(/'/g,"\\'")}','evening')">Evening (18+)</button><button class="rule-preset" onclick="setPreset('${cat.replace(/'/g,"\\'")}','morning')">Morning (6-12)</button><button class="rule-preset" onclick="setPreset('${cat.replace(/'/g,"\\'")}','offhours')">Off-hours (20+)</button></div>`;

    h+=`</div>`;
  });

  // Rotation info
  h+=`<div style="margin-top:20px;padding:12px;background:var(--card);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.05)"><div style="font-size:10px;font-weight:700;color:var(--text2);margin-bottom:6px">🔄 ROTATION STATUS</div>`;
  h+=`<div style="font-size:11px;color:var(--text);line-height:1.6">`;
  h+=`State: <strong>${pitchRotation==='cooldown_atk'?'All attackers blocked':'Free'}</strong><br>`;
  h+=`Last completed attacker: <strong>${lastDoneAtkCat||'None'}</strong>${lastDoneAtkCat?' (individually resting)':''}`;
  h+=`</div>`;
  if(lastDoneAtkCat||pitchRotation==='cooldown_atk'){h+=`<button onclick="pitchRotation='free';lastDoneAtkCat='';renderAll()" style="margin-top:6px;border:none;background:#DC262622;color:#DC2626;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif">Reset Rotation</button>`}
  h+=`</div>`;

  return h;
}
async function updateTimeSlot(cat){
  const safeId=cat.replace(/\s/g,'_');
  const from=parseInt(document.getElementById('rs_'+safeId+'_from').value);
  const to=parseInt(document.getElementById('rs_'+safeId+'_to').value);
  if(!timeSlotRules[cat])timeSlotRules[cat]={};
  timeSlotRules[cat].weekday_from=from;timeSlotRules[cat].weekday_to=to;
  await saveTimeSlots();renderOv();
}
async function toggleWeekend(cat){
  if(!timeSlotRules[cat])timeSlotRules[cat]={};
  timeSlotRules[cat].weekend=timeSlotRules[cat].weekend===false?true:false;
  await saveTimeSlots();renderOv();
}
async function setPreset(cat,preset){
  if(!timeSlotRules[cat])timeSlotRules[cat]={};
  if(preset==='always'){timeSlotRules[cat]={weekday_from:0,weekday_to:24,weekend:true}}
  else if(preset==='evening'){timeSlotRules[cat]={weekday_from:18,weekday_to:24,weekend:true}}
  else if(preset==='morning'){timeSlotRules[cat]={weekday_from:6,weekday_to:12,weekend:true}}
  else if(preset==='offhours'){timeSlotRules[cat]={weekday_from:20,weekday_to:24,weekend:true}}
  await saveTimeSlots();renderOv();
}

async function init(){applyTheme(loc);updateBadge();updateClock();setInterval(updateClock,60000);await loadAll();await checkAndReactivate();document.getElementById('loadingView').style.display='none';document.getElementById('pitch').style.display='';document.getElementById('cornerBtn').style.display='';document.getElementById('appLaunchBtn').style.display='';checkPoss();ofcUpdateBlockers();renderPitch()}
init();
</script>
</body>
</html>
